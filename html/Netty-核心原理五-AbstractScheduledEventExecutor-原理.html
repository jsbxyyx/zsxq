<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
</head>
<body>
<h1>Netty 核心原理五 AbstractScheduledEventExecutor 原理</h1>
<p>2022-02-18T14:59:11.951+0800</p>
<p><p><br></p>
<p><strong>DefaultEventExecutorGroup 原理</strong></p>
<p>由于绝大部分工作都在MultithreadEventExecutorGroup中实现了，那么可以看到该类仅仅只是在构造函数中对父类进行初始化，同时实现了唯一的newChild方法，在该方法中创建子执行器实例为DefaultEventExecutor对象。源码描述如下：</p>
<p><span style="color: rgb(200, 143, 208);">public</span> <span style="color: rgb(200, 143, 208);">class</span> <span style="color: rgb(141, 141, 240);">DefaultEventExecutorGroup</span> <span style="color: rgb(200, 143, 208);">extends</span> <span style="color: rgb(184, 191, 198);">MultithreadEventExecutorGroup</span> {</p>
<p>​</p>
<p>&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">public</span> <span style="color: rgb(184, 191, 198);">DefaultEventExecutorGroup</span>(<span style="color: rgb(28, 198, 133);">int</span> <span style="color: rgb(184, 191, 198);">nThreads</span>) {</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">this</span>(<span style="color: rgb(184, 191, 198);">nThreads</span>, <span style="color: rgb(132, 182, 203);">null</span>);</p>
<p>&nbsp;}</p>
<p>​</p>
<p>&nbsp;&nbsp;<span style="color: rgb(218, 146, 74);">// 构造函数：提供了默认的maxPendingTasks参数：SingleThreadEventExecutor.DEFAULT_MAX_PENDING_EXECUTOR_TASKS表示等待执行的任务个数</span></p>
<p>&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">public</span> <span style="color: rgb(184, 191, 198);">DefaultEventExecutorGroup</span>(<span style="color: rgb(28, 198, 133);">int</span> <span style="color: rgb(184, 191, 198);">nThreads</span>, <span style="color: rgb(184, 191, 198);">ThreadFactory</span> <span style="color: rgb(184, 191, 198);">threadFactory</span>) {</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">this</span>(<span style="color: rgb(184, 191, 198);">nThreads</span>, <span style="color: rgb(184, 191, 198);">threadFactory</span>, <span style="color: rgb(184, 191, 198);">SingleThreadEventExecutor</span>.<span style="color: rgb(184, 191, 198);">DEFAULT_MAX_PENDING_EXECUTOR_TASKS</span>,</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">RejectedExecutionHandlers</span>.<span style="color: rgb(184, 191, 198);">reject</span>());</p>
<p>&nbsp;}</p>
<p>​</p>
<p>&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">public</span> <span style="color: rgb(184, 191, 198);">DefaultEventExecutorGroup</span>(<span style="color: rgb(28, 198, 133);">int</span> <span style="color: rgb(184, 191, 198);">nThreads</span>, <span style="color: rgb(184, 191, 198);">ThreadFactory</span> <span style="color: rgb(184, 191, 198);">threadFactory</span>, <span style="color: rgb(28, 198, 133);">int</span> <span style="color: rgb(184, 191, 198);">maxPendingTasks</span>,</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">RejectedExecutionHandler</span> <span style="color: rgb(184, 191, 198);">rejectedHandler</span>) {</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">super</span>(<span style="color: rgb(184, 191, 198);">nThreads</span>, <span style="color: rgb(184, 191, 198);">threadFactory</span>, <span style="color: rgb(184, 191, 198);">maxPendingTasks</span>, <span style="color: rgb(184, 191, 198);">rejectedHandler</span>);</p>
<p>&nbsp;}</p>
<p>​</p>
<p>&nbsp;&nbsp;<span style="color: rgb(218, 146, 74);">// 通过父类的源码我们知道，传递的参数args（这里为maxPendingTasks）将会传递到该方法，由子执行器DefaultEventExecutor来使用。为何？父执行器组仅仅用于管理子执行器（创建、选择、销毁），而真实业务逻辑将在子执行器中完成</span></p>
<p>&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">protected</span> <span style="color: rgb(184, 191, 198);">EventExecutor</span> <span style="color: rgb(184, 191, 198);">newChild</span>(<span style="color: rgb(184, 191, 198);">Executor</span> <span style="color: rgb(184, 191, 198);">executor</span>, <span style="color: rgb(28, 198, 133);">Object</span>... <span style="color: rgb(184, 191, 198);">args</span>) <span style="color: rgb(200, 143, 208);">throws</span> <span style="color: rgb(184, 191, 198);">Exception</span> {</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">return</span> <span style="color: rgb(200, 143, 208);">new</span> <span style="color: rgb(184, 191, 198);">DefaultEventExecutor</span>(<span style="color: rgb(200, 143, 208);">this</span>, <span style="color: rgb(184, 191, 198);">executor</span>, (<span style="color: rgb(28, 198, 133);">Integer</span>) <span style="color: rgb(184, 191, 198);">args</span>[<span style="color: rgb(100, 171, 143);">0</span>], (<span style="color: rgb(184, 191, 198);">RejectedExecutionHandler</span>) <span style="color: rgb(184, 191, 198);">args</span>[<span style="color: rgb(100, 171, 143);">1</span>]);</p>
<p>&nbsp;}</p>
<p>}</p>
<p><strong>AbstractEventExecutor 原理</strong></p>
<p>我们看到该类同AbstractEventExecutorGroup一样，实现了一些默认的功能方法。这里需要注意：</p>
<ol>
 <li>在shutdownGracefully方法中提供了默认的静默期时间、关闭超时时间</li>
 <li>提交执行方法由父类AbstractExecutorService完成</li>
 <li>默认不支持周期性调度方法</li>
</ol>
<p><span style="color: rgb(200, 143, 208);">public</span> <span style="color: rgb(200, 143, 208);">abstract</span> <span style="color: rgb(200, 143, 208);">class</span> <span style="color: rgb(141, 141, 240);">AbstractEventExecutor</span> <span style="color: rgb(200, 143, 208);">extends</span> <span style="color: rgb(184, 191, 198);">AbstractExecutorService</span> <span style="color: rgb(200, 143, 208);">implements</span> <span style="color: rgb(184, 191, 198);">EventExecutor</span> {</p>
<p>​</p>
<p>&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">static</span> <span style="color: rgb(200, 143, 208);">final</span> <span style="color: rgb(28, 198, 133);">long</span> <span style="color: rgb(184, 191, 198);">DEFAULT_SHUTDOWN_QUIET_PERIOD</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(100, 171, 143);">2</span>; <span style="color: rgb(218, 146, 74);">// 静默期</span></p>
<p>&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">static</span> <span style="color: rgb(200, 143, 208);">final</span> <span style="color: rgb(28, 198, 133);">long</span> <span style="color: rgb(184, 191, 198);">DEFAULT_SHUTDOWN_TIMEOUT</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(100, 171, 143);">15</span>; <span style="color: rgb(218, 146, 74);">// 关闭超时时间</span></p>
<p>​</p>
<p>&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">private</span> <span style="color: rgb(200, 143, 208);">final</span> <span style="color: rgb(184, 191, 198);">EventExecutorGroup</span> <span style="color: rgb(184, 191, 198);">parent</span>;</p>
<p>&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">private</span> <span style="color: rgb(200, 143, 208);">final</span> <span style="color: rgb(184, 191, 198);">Collection&lt;EventExecutor&gt;</span> <span style="color: rgb(184, 191, 198);">selfCollection</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">Collections</span>.<span style="color: rgb(184, 191, 198);">&lt;EventExecutor&gt;singleton</span>(<span style="color: rgb(200, 143, 208);">this</span>);</p>
<p>​</p>
<p>&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">protected</span> <span style="color: rgb(184, 191, 198);">AbstractEventExecutor</span>() {</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">this</span>(<span style="color: rgb(132, 182, 203);">null</span>);</p>
<p>&nbsp;}</p>
<p>​</p>
<p>&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">protected</span> <span style="color: rgb(184, 191, 198);">AbstractEventExecutor</span>(<span style="color: rgb(184, 191, 198);">EventExecutorGroup</span> <span style="color: rgb(184, 191, 198);">parent</span>) {</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">this</span>.<span style="color: rgb(184, 191, 198);">parent</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">parent</span>;</p>
<p>&nbsp;}</p>
<p>​</p>
<p>&nbsp;&nbsp;<span style="color: rgb(183, 179, 179);">@Override</span></p>
<p>&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">public</span> <span style="color: rgb(184, 191, 198);">EventExecutorGroup</span> <span style="color: rgb(184, 191, 198);">parent</span>() {</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">return</span> <span style="color: rgb(184, 191, 198);">parent</span>;</p>
<p>&nbsp;}</p>
<p>​</p>
<p>&nbsp;&nbsp;<span style="color: rgb(218, 146, 74);">// 由于子执行器组只有他自己，所以永远返回他自己</span></p>
<p>&nbsp;&nbsp;<span style="color: rgb(183, 179, 179);">@Override</span></p>
<p>&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">public</span> <span style="color: rgb(184, 191, 198);">EventExecutor</span> <span style="color: rgb(184, 191, 198);">next</span>() {</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">return</span> <span style="color: rgb(200, 143, 208);">this</span>;</p>
<p>&nbsp;}</p>
<p>​</p>
<p>&nbsp;&nbsp;<span style="color: rgb(218, 146, 74);">// 判断当前线程是否为当前EventExecutor的执行线程，由子类来完成</span></p>
<p>&nbsp;&nbsp;<span style="color: rgb(183, 179, 179);">@Override</span></p>
<p>&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">public</span> <span style="color: rgb(28, 198, 133);">boolean</span> <span style="color: rgb(184, 191, 198);">inEventLoop</span>() {</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">return</span> <span style="color: rgb(184, 191, 198);">inEventLoop</span>(<span style="color: rgb(184, 191, 198);">Thread</span>.<span style="color: rgb(184, 191, 198);">currentThread</span>());</p>
<p>&nbsp;}</p>
<p>​</p>
<p>&nbsp;&nbsp;<span style="color: rgb(183, 179, 179);">@Override</span></p>
<p>&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">public</span> <span style="color: rgb(184, 191, 198);">Iterator&lt;EventExecutor&gt;</span> <span style="color: rgb(184, 191, 198);">iterator</span>() {</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">return</span> <span style="color: rgb(184, 191, 198);">selfCollection</span>.<span style="color: rgb(184, 191, 198);">iterator</span>();</p>
<p>&nbsp;}</p>
<p>​</p>
<p>&nbsp;&nbsp;<span style="color: rgb(218, 146, 74);">// 关闭方法由子类来完成，这里指定了默认的静默周期和关闭超时时间</span></p>
<p>&nbsp;&nbsp;<span style="color: rgb(183, 179, 179);">@Override</span></p>
<p>&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">public</span> <span style="color: rgb(184, 191, 198);">Future&lt;?&gt;</span> <span style="color: rgb(184, 191, 198);">shutdownGracefully</span>() {</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">return</span> <span style="color: rgb(184, 191, 198);">shutdownGracefully</span>(<span style="color: rgb(184, 191, 198);">DEFAULT_SHUTDOWN_QUIET_PERIOD</span>, <span style="color: rgb(184, 191, 198);">DEFAULT_SHUTDOWN_TIMEOUT</span>, <span style="color: rgb(184, 191, 198);">TimeUnit</span>.<span style="color: rgb(184, 191, 198);">SECONDS</span>);</p>
<p>&nbsp;}</p>
<p>​</p>
<p>&nbsp;&nbsp;</p>
<p>&nbsp;&nbsp;<span style="color: rgb(218, 146, 74);">/* ---- 异步执行创建默认的实例 */</span></p>
<p>&nbsp;&nbsp;</p>
<p>&nbsp;&nbsp;<span style="color: rgb(183, 179, 179);">@Override</span></p>
<p>&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">public</span> <span style="color: rgb(184, 191, 198);">&lt;V&gt;</span> <span style="color: rgb(184, 191, 198);">Promise&lt;V&gt;</span> <span style="color: rgb(184, 191, 198);">newPromise</span>() {</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">return</span> <span style="color: rgb(200, 143, 208);">new</span> <span style="color: rgb(184, 191, 198);">DefaultPromise&lt;V&gt;</span>(<span style="color: rgb(200, 143, 208);">this</span>);</p>
<p>&nbsp;}</p>
<p>​</p>
<p>&nbsp;&nbsp;<span style="color: rgb(183, 179, 179);">@Override</span></p>
<p>&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">public</span> <span style="color: rgb(184, 191, 198);">&lt;V&gt;</span> <span style="color: rgb(184, 191, 198);">ProgressivePromise&lt;V&gt;</span> <span style="color: rgb(184, 191, 198);">newProgressivePromise</span>() {</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">return</span> <span style="color: rgb(200, 143, 208);">new</span> <span style="color: rgb(184, 191, 198);">DefaultProgressivePromise&lt;V&gt;</span>(<span style="color: rgb(200, 143, 208);">this</span>);</p>
<p>&nbsp;}</p>
<p>​</p>
<p>&nbsp;&nbsp;<span style="color: rgb(183, 179, 179);">@Override</span></p>
<p>&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">public</span> <span style="color: rgb(184, 191, 198);">&lt;V&gt;</span> <span style="color: rgb(184, 191, 198);">Future&lt;V&gt;</span> <span style="color: rgb(184, 191, 198);">newSucceededFuture</span>(<span style="color: rgb(184, 191, 198);">V</span> <span style="color: rgb(184, 191, 198);">result</span>) {</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">return</span> <span style="color: rgb(200, 143, 208);">new</span> <span style="color: rgb(184, 191, 198);">SucceededFuture&lt;V&gt;</span>(<span style="color: rgb(200, 143, 208);">this</span>, <span style="color: rgb(184, 191, 198);">result</span>);</p>
<p>&nbsp;}</p>
<p>​</p>
<p>&nbsp;&nbsp;<span style="color: rgb(183, 179, 179);">@Override</span></p>
<p>&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">public</span> <span style="color: rgb(184, 191, 198);">&lt;V&gt;</span> <span style="color: rgb(184, 191, 198);">Future&lt;V&gt;</span> <span style="color: rgb(184, 191, 198);">newFailedFuture</span>(<span style="color: rgb(184, 191, 198);">Throwable</span> <span style="color: rgb(184, 191, 198);">cause</span>) {</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">return</span> <span style="color: rgb(200, 143, 208);">new</span> <span style="color: rgb(184, 191, 198);">FailedFuture&lt;V&gt;</span>(<span style="color: rgb(200, 143, 208);">this</span>, <span style="color: rgb(184, 191, 198);">cause</span>);</p>
<p>&nbsp;}</p>
<p>​</p>
<p>&nbsp;&nbsp;<span style="color: rgb(218, 146, 74);">/* ---- 提交方法使用父类AbstractExecutorService来实现 */</span></p>
<p>​</p>
<p>&nbsp;&nbsp;<span style="color: rgb(183, 179, 179);">@Override</span></p>
<p>&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">public</span> <span style="color: rgb(184, 191, 198);">Future&lt;?&gt;</span> <span style="color: rgb(184, 191, 198);">submit</span>(<span style="color: rgb(184, 191, 198);">Runnable</span> <span style="color: rgb(184, 191, 198);">task</span>) {</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">return</span> (<span style="color: rgb(184, 191, 198);">Future&lt;?&gt;</span>) <span style="color: rgb(200, 143, 208);">super</span>.<span style="color: rgb(184, 191, 198);">submit</span>(<span style="color: rgb(184, 191, 198);">task</span>);</p>
<p>&nbsp;}</p>
<p>​</p>
<p>&nbsp;&nbsp;<span style="color: rgb(183, 179, 179);">@Override</span></p>
<p>&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">public</span> <span style="color: rgb(184, 191, 198);">&lt;T&gt;</span> <span style="color: rgb(184, 191, 198);">Future&lt;T&gt;</span> <span style="color: rgb(184, 191, 198);">submit</span>(<span style="color: rgb(184, 191, 198);">Runnable</span> <span style="color: rgb(184, 191, 198);">task</span>, <span style="color: rgb(184, 191, 198);">T</span> <span style="color: rgb(184, 191, 198);">result</span>) {</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">return</span> (<span style="color: rgb(184, 191, 198);">Future&lt;T&gt;</span>) <span style="color: rgb(200, 143, 208);">super</span>.<span style="color: rgb(184, 191, 198);">submit</span>(<span style="color: rgb(184, 191, 198);">task</span>, <span style="color: rgb(184, 191, 198);">result</span>);</p>
<p>&nbsp;}</p>
<p>​</p>
<p>&nbsp;&nbsp;<span style="color: rgb(183, 179, 179);">@Override</span></p>
<p>&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">public</span> <span style="color: rgb(184, 191, 198);">&lt;T&gt;</span> <span style="color: rgb(184, 191, 198);">Future&lt;T&gt;</span> <span style="color: rgb(184, 191, 198);">submit</span>(<span style="color: rgb(184, 191, 198);">Callable&lt;T&gt;</span> <span style="color: rgb(184, 191, 198);">task</span>) {</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">return</span> (<span style="color: rgb(184, 191, 198);">Future&lt;T&gt;</span>) <span style="color: rgb(200, 143, 208);">super</span>.<span style="color: rgb(184, 191, 198);">submit</span>(<span style="color: rgb(184, 191, 198);">task</span>);</p>
<p>&nbsp;}</p>
<p>​</p>
<p>&nbsp;&nbsp;<span style="color: rgb(218, 146, 74);">/* ---- 默认不支持周期性调度 */</span></p>
<p>&nbsp;&nbsp;<span style="color: rgb(183, 179, 179);">@Override</span></p>
<p>&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">public</span> <span style="color: rgb(184, 191, 198);">ScheduledFuture&lt;?&gt;</span> <span style="color: rgb(184, 191, 198);">schedule</span>(<span style="color: rgb(184, 191, 198);">Runnable</span> <span style="color: rgb(184, 191, 198);">command</span>, <span style="color: rgb(28, 198, 133);">long</span> <span style="color: rgb(184, 191, 198);">delay</span>,</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">TimeUnit</span> <span style="color: rgb(184, 191, 198);">unit</span>) {</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">throw</span> <span style="color: rgb(200, 143, 208);">new</span> <span style="color: rgb(184, 191, 198);">UnsupportedOperationException</span>();</p>
<p>&nbsp;}</p>
<p>​</p>
<p>&nbsp;&nbsp;<span style="color: rgb(183, 179, 179);">@Override</span></p>
<p>&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">public</span> <span style="color: rgb(184, 191, 198);">&lt;V&gt;</span> <span style="color: rgb(184, 191, 198);">ScheduledFuture&lt;V&gt;</span> <span style="color: rgb(184, 191, 198);">schedule</span>(<span style="color: rgb(184, 191, 198);">Callable&lt;V&gt;</span> <span style="color: rgb(184, 191, 198);">callable</span>, <span style="color: rgb(28, 198, 133);">long</span> <span style="color: rgb(184, 191, 198);">delay</span>, <span style="color: rgb(184, 191, 198);">TimeUnit</span> <span style="color: rgb(184, 191, 198);">unit</span>) {</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">throw</span> <span style="color: rgb(200, 143, 208);">new</span> <span style="color: rgb(184, 191, 198);">UnsupportedOperationException</span>();</p>
<p>&nbsp;}</p>
<p>​</p>
<p>&nbsp;&nbsp;<span style="color: rgb(183, 179, 179);">@Override</span></p>
<p>&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">public</span> <span style="color: rgb(184, 191, 198);">ScheduledFuture&lt;?&gt;</span> <span style="color: rgb(184, 191, 198);">scheduleAtFixedRate</span>(<span style="color: rgb(184, 191, 198);">Runnable</span> <span style="color: rgb(184, 191, 198);">command</span>, <span style="color: rgb(28, 198, 133);">long</span> <span style="color: rgb(184, 191, 198);">initialDelay</span>, <span style="color: rgb(28, 198, 133);">long</span> <span style="color: rgb(184, 191, 198);">period</span>, <span style="color: rgb(184, 191, 198);">TimeUnit</span> <span style="color: rgb(184, 191, 198);">unit</span>) {</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">throw</span> <span style="color: rgb(200, 143, 208);">new</span> <span style="color: rgb(184, 191, 198);">UnsupportedOperationException</span>();</p>
<p>&nbsp;}</p>
<p>​</p>
<p>&nbsp;&nbsp;<span style="color: rgb(183, 179, 179);">@Override</span></p>
<p>&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">public</span> <span style="color: rgb(184, 191, 198);">ScheduledFuture&lt;?&gt;</span> <span style="color: rgb(184, 191, 198);">scheduleWithFixedDelay</span>(<span style="color: rgb(184, 191, 198);">Runnable</span> <span style="color: rgb(184, 191, 198);">command</span>, <span style="color: rgb(28, 198, 133);">long</span> <span style="color: rgb(184, 191, 198);">initialDelay</span>, <span style="color: rgb(28, 198, 133);">long</span> <span style="color: rgb(184, 191, 198);">delay</span>, <span style="color: rgb(184, 191, 198);">TimeUnit</span> <span style="color: rgb(184, 191, 198);">unit</span>) {</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">throw</span> <span style="color: rgb(200, 143, 208);">new</span> <span style="color: rgb(184, 191, 198);">UnsupportedOperationException</span>();</p>
<p>&nbsp;}</p>
<p>}</p>
<p><strong>AbstractScheduledEventExecutor 原理</strong></p>
<p>该方法中定义了周期性任务队列scheduledTaskQueue和周期性任务调度功能方法的实现，用于对队列进行CRUD。同时提供ScheduledExecutorService中的函数实现。由于该类比较简单且功能单一，方法实现也不复杂，所以笔者这里这接将整个类都复制过来，然后进行了方法注释。读者这里只需要注意以下知识：</p>
<ol>
 <li>队列由PriorityQueue类实现</li>
 <li>只有当前执行器所属线程才能对队列进行操作，这时保证线程安全（保证线程安全的两种方法：1、多线程操作上锁 2、单线程操作，其他线程将操作放入单线程的普通任务队列中，由单线程串行化实现，混沌学习下：Redis？）</li>
</ol>
<p><span style="color: rgb(200, 143, 208);">public</span> <span style="color: rgb(200, 143, 208);">abstract</span> <span style="color: rgb(200, 143, 208);">class</span> <span style="color: rgb(141, 141, 240);">AbstractScheduledEventExecutor</span> <span style="color: rgb(200, 143, 208);">extends</span> <span style="color: rgb(184, 191, 198);">AbstractEventExecutor</span> {</p>
<p>&nbsp;&nbsp;</p>
<p>&nbsp;&nbsp;<span style="color: rgb(218, 146, 74);">// 周期性任务调度队列</span></p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">Queue&lt;ScheduledFutureTask&lt;?&gt;&gt;</span> <span style="color: rgb(184, 191, 198);">scheduledTaskQueue</span>;</p>
<p>​</p>
<p>&nbsp;&nbsp;<span style="color: rgb(218, 146, 74);">// 获取基于ScheduledFutureTask类加载时间的相对时间</span></p>
<p>&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">protected</span> <span style="color: rgb(200, 143, 208);">static</span> <span style="color: rgb(28, 198, 133);">long</span> <span style="color: rgb(184, 191, 198);">nanoTime</span>() {</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">return</span> <span style="color: rgb(184, 191, 198);">ScheduledFutureTask</span>.<span style="color: rgb(184, 191, 198);">nanoTime</span>();</p>
<p>&nbsp;}</p>
<p>​</p>
<p>&nbsp;&nbsp;<span style="color: rgb(218, 146, 74);">// 获取或者初始化任务调度队列，可以看到这里的队列很简单：PriorityQueue由数组实现的小顶堆优先级队列</span></p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">Queue&lt;ScheduledFutureTask&lt;?&gt;&gt;</span> <span style="color: rgb(184, 191, 198);">scheduledTaskQueue</span>() {</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">if</span> (<span style="color: rgb(184, 191, 198);">scheduledTaskQueue</span> <span style="color: rgb(184, 191, 198);">==</span> <span style="color: rgb(132, 182, 203);">null</span>) {</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">scheduledTaskQueue</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(200, 143, 208);">new</span> <span style="color: rgb(184, 191, 198);">PriorityQueue&lt;ScheduledFutureTask&lt;?&gt;&gt;</span>();</p>
<p>&nbsp;&nbsp;&nbsp;}</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">return</span> <span style="color: rgb(184, 191, 198);">scheduledTaskQueue</span>;</p>
<p>&nbsp;}</p>
<p>​</p>
<p>&nbsp;&nbsp;<span style="color: rgb(218, 146, 74);">// 取消所有周期性调度任务</span></p>
<p>&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">protected</span> <span style="color: rgb(28, 198, 133);">void</span> <span style="color: rgb(184, 191, 198);">cancelScheduledTasks</span>() {</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">Queue&lt;ScheduledFutureTask&lt;?&gt;&gt;</span> <span style="color: rgb(184, 191, 198);">scheduledTaskQueue</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(200, 143, 208);">this</span>.<span style="color: rgb(184, 191, 198);">scheduledTaskQueue</span>;</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">if</span> (<span style="color: rgb(184, 191, 198);">isNullOrEmpty</span>(<span style="color: rgb(184, 191, 198);">scheduledTaskQueue</span>)) { <span style="color: rgb(218, 146, 74);">// 队列为空，那么直接退出</span></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">return</span>;</p>
<p>&nbsp;&nbsp;&nbsp;}</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">final</span> <span style="color: rgb(184, 191, 198);">ScheduledFutureTask&lt;?&gt;</span>[] <span style="color: rgb(184, 191, 198);">scheduledTasks</span> <span style="color: rgb(184, 191, 198);">=</span></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">scheduledTaskQueue</span>.<span style="color: rgb(184, 191, 198);">toArray</span>(<span style="color: rgb(200, 143, 208);">new</span> <span style="color: rgb(184, 191, 198);">ScheduledFutureTask&lt;?&gt;</span>[<span style="color: rgb(184, 191, 198);">scheduledTaskQueue</span>.<span style="color: rgb(184, 191, 198);">size</span>()]); <span style="color: rgb(218, 146, 74);">// 导出所有周期性任务</span></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">for</span> (<span style="color: rgb(184, 191, 198);">ScheduledFutureTask&lt;?&gt;</span> <span style="color: rgb(184, 191, 198);">task</span>: <span style="color: rgb(184, 191, 198);">scheduledTasks</span>) { <span style="color: rgb(218, 146, 74);">// 遍历取消这些任务</span></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">task</span>.<span style="color: rgb(184, 191, 198);">cancelWithoutRemove</span>(<span style="color: rgb(132, 182, 203);">false</span>);</p>
<p>&nbsp;&nbsp;&nbsp;}</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">scheduledTaskQueue</span>.<span style="color: rgb(184, 191, 198);">clear</span>(); <span style="color: rgb(218, 146, 74);">// 清空任务队列</span></p>
<p>&nbsp;}</p>
<p>​</p>
<p>&nbsp;&nbsp;<span style="color: rgb(218, 146, 74);">// 从周期性任务队列中获取可以执行的周期性任务</span></p>
<p>&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">protected</span> <span style="color: rgb(200, 143, 208);">final</span> <span style="color: rgb(184, 191, 198);">Runnable</span> <span style="color: rgb(184, 191, 198);">pollScheduledTask</span>(<span style="color: rgb(28, 198, 133);">long</span> <span style="color: rgb(184, 191, 198);">nanoTime</span>) {</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">assert</span> <span style="color: rgb(184, 191, 198);">inEventLoop</span>(); <span style="color: rgb(218, 146, 74);">// 执行该方法的线程必须为当前执行器所属线程</span></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">Queue&lt;ScheduledFutureTask&lt;?&gt;&gt;</span> <span style="color: rgb(184, 191, 198);">scheduledTaskQueue</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(200, 143, 208);">this</span>.<span style="color: rgb(184, 191, 198);">scheduledTaskQueue</span>;</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(218, 146, 74);">// 从队列中看看是否存在任务，如果不存在，那么直接返回</span></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">ScheduledFutureTask&lt;?&gt;</span> <span style="color: rgb(184, 191, 198);">scheduledTask</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">scheduledTaskQueue</span> <span style="color: rgb(184, 191, 198);">==</span> <span style="color: rgb(132, 182, 203);">null</span> <span style="color: rgb(184, 191, 198);">?</span> <span style="color: rgb(132, 182, 203);">null</span> : <span style="color: rgb(184, 191, 198);">scheduledTaskQueue</span>.<span style="color: rgb(184, 191, 198);">peek</span>();</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">if</span> (<span style="color: rgb(184, 191, 198);">scheduledTask</span> <span style="color: rgb(184, 191, 198);">==</span> <span style="color: rgb(132, 182, 203);">null</span>) {</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">return</span> <span style="color: rgb(132, 182, 203);">null</span>;</p>
<p>&nbsp;&nbsp;&nbsp;}</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(218, 146, 74);">// 否则看看周期周期性调度任务的等待时间是否小于传入的等待时间，如果小于那么获取该任务返回。注意：这里的remove不会导致阻塞</span></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">if</span> (<span style="color: rgb(184, 191, 198);">scheduledTask</span>.<span style="color: rgb(184, 191, 198);">deadlineNanos</span>() <span style="color: rgb(184, 191, 198);">&lt;=</span> <span style="color: rgb(184, 191, 198);">nanoTime</span>) {</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">scheduledTaskQueue</span>.<span style="color: rgb(184, 191, 198);">remove</span>();</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">return</span> <span style="color: rgb(184, 191, 198);">scheduledTask</span>;</p>
<p>&nbsp;&nbsp;&nbsp;}</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">return</span> <span style="color: rgb(132, 182, 203);">null</span>;</p>
<p>&nbsp;}</p>
<p>​</p>
<p>&nbsp;&nbsp;<span style="color: rgb(218, 146, 74);">// 从队列中获取到下一次需要执行的周期性任务的等待时间</span></p>
<p>&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">protected</span> <span style="color: rgb(200, 143, 208);">final</span> <span style="color: rgb(28, 198, 133);">long</span> <span style="color: rgb(184, 191, 198);">nextScheduledTaskNano</span>() {</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">Queue&lt;ScheduledFutureTask&lt;?&gt;&gt;</span> <span style="color: rgb(184, 191, 198);">scheduledTaskQueue</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(200, 143, 208);">this</span>.<span style="color: rgb(184, 191, 198);">scheduledTaskQueue</span>;</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(218, 146, 74);">// 获取第一个需要执行的任务（由于这里队列是小顶堆实现，所以第一个任务一定是最近一个需要执行的周期性任务），如任务不存在，那么返回-1，否则返回需要等待的时间</span></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">ScheduledFutureTask&lt;?&gt;</span> <span style="color: rgb(184, 191, 198);">scheduledTask</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">scheduledTaskQueue</span> <span style="color: rgb(184, 191, 198);">==</span> <span style="color: rgb(132, 182, 203);">null</span> <span style="color: rgb(184, 191, 198);">?</span> <span style="color: rgb(132, 182, 203);">null</span> : <span style="color: rgb(184, 191, 198);">scheduledTaskQueue</span>.<span style="color: rgb(184, 191, 198);">peek</span>();</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">if</span> (<span style="color: rgb(184, 191, 198);">scheduledTask</span> <span style="color: rgb(184, 191, 198);">==</span> <span style="color: rgb(132, 182, 203);">null</span>) {</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">return</span> <span style="color: rgb(184, 191, 198);">-</span><span style="color: rgb(100, 171, 143);">1</span>;</p>
<p>&nbsp;&nbsp;&nbsp;}</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">return</span> <span style="color: rgb(184, 191, 198);">Math</span>.<span style="color: rgb(184, 191, 198);">max</span>(<span style="color: rgb(100, 171, 143);">0</span>, <span style="color: rgb(184, 191, 198);">scheduledTask</span>.<span style="color: rgb(184, 191, 198);">deadlineNanos</span>() <span style="color: rgb(184, 191, 198);">-</span> <span style="color: rgb(184, 191, 198);">nanoTime</span>());</p>
<p>&nbsp;}</p>
<p>​</p>
<p>&nbsp;&nbsp;<span style="color: rgb(218, 146, 74);">// 直接获取周期性任务队列中第一个需要执行的任务，不存在则返回null</span></p>
<p>&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">final</span> <span style="color: rgb(184, 191, 198);">ScheduledFutureTask&lt;?&gt;</span> <span style="color: rgb(184, 191, 198);">peekScheduledTask</span>() {</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">Queue&lt;ScheduledFutureTask&lt;?&gt;&gt;</span> <span style="color: rgb(184, 191, 198);">scheduledTaskQueue</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(200, 143, 208);">this</span>.<span style="color: rgb(184, 191, 198);">scheduledTaskQueue</span>;</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">if</span> (<span style="color: rgb(184, 191, 198);">scheduledTaskQueue</span> <span style="color: rgb(184, 191, 198);">==</span> <span style="color: rgb(132, 182, 203);">null</span>) {</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">return</span> <span style="color: rgb(132, 182, 203);">null</span>;</p>
<p>&nbsp;&nbsp;&nbsp;}</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">return</span> <span style="color: rgb(184, 191, 198);">scheduledTaskQueue</span>.<span style="color: rgb(184, 191, 198);">peek</span>();</p>
<p>&nbsp;}</p>
<p>​</p>
<p>&nbsp;&nbsp;<span style="color: rgb(218, 146, 74);">// 查看任务队列中是否存在可执行的任务：任务存在且已经达到执行的时间</span></p>
<p>&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">protected</span> <span style="color: rgb(200, 143, 208);">final</span> <span style="color: rgb(28, 198, 133);">boolean</span> <span style="color: rgb(184, 191, 198);">hasScheduledTasks</span>() {</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">Queue&lt;ScheduledFutureTask&lt;?&gt;&gt;</span> <span style="color: rgb(184, 191, 198);">scheduledTaskQueue</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(200, 143, 208);">this</span>.<span style="color: rgb(184, 191, 198);">scheduledTaskQueue</span>;</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">ScheduledFutureTask&lt;?&gt;</span> <span style="color: rgb(184, 191, 198);">scheduledTask</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">scheduledTaskQueue</span> <span style="color: rgb(184, 191, 198);">==</span> <span style="color: rgb(132, 182, 203);">null</span> <span style="color: rgb(184, 191, 198);">?</span> <span style="color: rgb(132, 182, 203);">null</span> : <span style="color: rgb(184, 191, 198);">scheduledTaskQueue</span>.<span style="color: rgb(184, 191, 198);">peek</span>();</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">return</span> <span style="color: rgb(184, 191, 198);">scheduledTask</span> <span style="color: rgb(184, 191, 198);">!=</span> <span style="color: rgb(132, 182, 203);">null</span> <span style="color: rgb(184, 191, 198);">&amp;&amp;</span> <span style="color: rgb(184, 191, 198);">scheduledTask</span>.<span style="color: rgb(184, 191, 198);">deadlineNanos</span>() <span style="color: rgb(184, 191, 198);">&lt;=</span> <span style="color: rgb(184, 191, 198);">nanoTime</span>();</p>
<p>&nbsp;}</p>
<p>​</p>
<p>&nbsp;&nbsp;<span style="color: rgb(218, 146, 74);">// 周期性调度实现，可以看到该方法对参数校验后直接调用schedule方法完成</span></p>
<p>&nbsp;&nbsp;<span style="color: rgb(183, 179, 179);">@Override</span></p>
<p>&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">public</span>&nbsp;<span style="color: rgb(184, 191, 198);">ScheduledFuture&lt;?&gt;</span> <span style="color: rgb(184, 191, 198);">schedule</span>(<span style="color: rgb(184, 191, 198);">Runnable</span> <span style="color: rgb(184, 191, 198);">command</span>, <span style="color: rgb(28, 198, 133);">long</span> <span style="color: rgb(184, 191, 198);">delay</span>, <span style="color: rgb(184, 191, 198);">TimeUnit</span> <span style="color: rgb(184, 191, 198);">unit</span>) {</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">ObjectUtil</span>.<span style="color: rgb(184, 191, 198);">checkNotNull</span>(<span style="color: rgb(184, 191, 198);">command</span>, <span style="color: rgb(210, 107, 107);">"command"</span>);</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">ObjectUtil</span>.<span style="color: rgb(184, 191, 198);">checkNotNull</span>(<span style="color: rgb(184, 191, 198);">unit</span>, <span style="color: rgb(210, 107, 107);">"unit"</span>);</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">if</span> (<span style="color: rgb(184, 191, 198);">delay</span> <span style="color: rgb(184, 191, 198);">&lt;</span> <span style="color: rgb(100, 171, 143);">0</span>) {</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">throw</span> <span style="color: rgb(200, 143, 208);">new</span> <span style="color: rgb(184, 191, 198);">IllegalArgumentException</span>(</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(28, 198, 133);">String</span>.<span style="color: rgb(184, 191, 198);">format</span>(<span style="color: rgb(210, 107, 107);">"delay: %d (expected: &gt;= 0)"</span>, <span style="color: rgb(184, 191, 198);">delay</span>));</p>
<p>&nbsp;&nbsp;&nbsp;}</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">return</span> <span style="color: rgb(184, 191, 198);">schedule</span>(<span style="color: rgb(200, 143, 208);">new</span> <span style="color: rgb(184, 191, 198);">ScheduledFutureTask&lt;</span><span style="color: rgb(28, 198, 133);">Void</span><span style="color: rgb(184, 191, 198);">&gt;</span>(</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">this</span>, <span style="color: rgb(184, 191, 198);">command</span>, <span style="color: rgb(132, 182, 203);">null</span>, <span style="color: rgb(184, 191, 198);">ScheduledFutureTask</span>.<span style="color: rgb(184, 191, 198);">deadlineNanos</span>(<span style="color: rgb(184, 191, 198);">unit</span>.<span style="color: rgb(184, 191, 198);">toNanos</span>(<span style="color: rgb(184, 191, 198);">delay</span>))));</p>
<p>&nbsp;}</p>
<p>​</p>
<p>&nbsp;&nbsp;<span style="color: rgb(218, 146, 74);">// 对callable接口支持</span></p>
<p>&nbsp;&nbsp;<span style="color: rgb(183, 179, 179);">@Override</span></p>
<p>&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">public</span> <span style="color: rgb(184, 191, 198);">&lt;V&gt;</span> <span style="color: rgb(184, 191, 198);">ScheduledFuture&lt;V&gt;</span> <span style="color: rgb(184, 191, 198);">schedule</span>(<span style="color: rgb(184, 191, 198);">Callable&lt;V&gt;</span> <span style="color: rgb(184, 191, 198);">callable</span>, <span style="color: rgb(28, 198, 133);">long</span> <span style="color: rgb(184, 191, 198);">delay</span>, <span style="color: rgb(184, 191, 198);">TimeUnit</span> <span style="color: rgb(184, 191, 198);">unit</span>) {</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">ObjectUtil</span>.<span style="color: rgb(184, 191, 198);">checkNotNull</span>(<span style="color: rgb(184, 191, 198);">callable</span>, <span style="color: rgb(210, 107, 107);">"callable"</span>);</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">ObjectUtil</span>.<span style="color: rgb(184, 191, 198);">checkNotNull</span>(<span style="color: rgb(184, 191, 198);">unit</span>, <span style="color: rgb(210, 107, 107);">"unit"</span>);</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">if</span> (<span style="color: rgb(184, 191, 198);">delay</span> <span style="color: rgb(184, 191, 198);">&lt;</span> <span style="color: rgb(100, 171, 143);">0</span>) {</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">throw</span> <span style="color: rgb(200, 143, 208);">new</span> <span style="color: rgb(184, 191, 198);">IllegalArgumentException</span>(</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(28, 198, 133);">String</span>.<span style="color: rgb(184, 191, 198);">format</span>(<span style="color: rgb(210, 107, 107);">"delay: %d (expected: &gt;= 0)"</span>, <span style="color: rgb(184, 191, 198);">delay</span>));</p>
<p>&nbsp;&nbsp;&nbsp;}</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">return</span> <span style="color: rgb(184, 191, 198);">schedule</span>(<span style="color: rgb(200, 143, 208);">new</span> <span style="color: rgb(184, 191, 198);">ScheduledFutureTask&lt;V&gt;</span>(</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">this</span>, <span style="color: rgb(184, 191, 198);">callable</span>, <span style="color: rgb(184, 191, 198);">ScheduledFutureTask</span>.<span style="color: rgb(184, 191, 198);">deadlineNanos</span>(<span style="color: rgb(184, 191, 198);">unit</span>.<span style="color: rgb(184, 191, 198);">toNanos</span>(<span style="color: rgb(184, 191, 198);">delay</span>))));</p>
<p>&nbsp;}</p>
<p>&nbsp;&nbsp;</p>
<p>&nbsp;&nbsp;<span style="color: rgb(218, 146, 74);">// 固定周期执行方法支持</span></p>
<p>&nbsp;&nbsp;<span style="color: rgb(183, 179, 179);">@Override</span></p>
<p>&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">public</span> <span style="color: rgb(184, 191, 198);">ScheduledFuture&lt;?&gt;</span> <span style="color: rgb(184, 191, 198);">scheduleAtFixedRate</span>(<span style="color: rgb(184, 191, 198);">Runnable</span> <span style="color: rgb(184, 191, 198);">command</span>, <span style="color: rgb(28, 198, 133);">long</span> <span style="color: rgb(184, 191, 198);">initialDelay</span>, <span style="color: rgb(28, 198, 133);">long</span> <span style="color: rgb(184, 191, 198);">period</span>, <span style="color: rgb(184, 191, 198);">TimeUnit</span> <span style="color: rgb(184, 191, 198);">unit</span>) {</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">ObjectUtil</span>.<span style="color: rgb(184, 191, 198);">checkNotNull</span>(<span style="color: rgb(184, 191, 198);">command</span>, <span style="color: rgb(210, 107, 107);">"command"</span>);</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">ObjectUtil</span>.<span style="color: rgb(184, 191, 198);">checkNotNull</span>(<span style="color: rgb(184, 191, 198);">unit</span>, <span style="color: rgb(210, 107, 107);">"unit"</span>);</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">if</span> (<span style="color: rgb(184, 191, 198);">initialDelay</span> <span style="color: rgb(184, 191, 198);">&lt;</span> <span style="color: rgb(100, 171, 143);">0</span>) {</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">throw</span> <span style="color: rgb(200, 143, 208);">new</span> <span style="color: rgb(184, 191, 198);">IllegalArgumentException</span>(</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(28, 198, 133);">String</span>.<span style="color: rgb(184, 191, 198);">format</span>(<span style="color: rgb(210, 107, 107);">"initialDelay: %d (expected: &gt;= 0)"</span>, <span style="color: rgb(184, 191, 198);">initialDelay</span>));</p>
<p>&nbsp;&nbsp;&nbsp;}</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">if</span> (<span style="color: rgb(184, 191, 198);">period</span> <span style="color: rgb(184, 191, 198);">&lt;=</span> <span style="color: rgb(100, 171, 143);">0</span>) {</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">throw</span> <span style="color: rgb(200, 143, 208);">new</span> <span style="color: rgb(184, 191, 198);">IllegalArgumentException</span>(</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(28, 198, 133);">String</span>.<span style="color: rgb(184, 191, 198);">format</span>(<span style="color: rgb(210, 107, 107);">"period: %d (expected: &gt; 0)"</span>, <span style="color: rgb(184, 191, 198);">period</span>));</p>
<p>&nbsp;&nbsp;&nbsp;}</p>
<p>​</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">return</span> <span style="color: rgb(184, 191, 198);">schedule</span>(<span style="color: rgb(200, 143, 208);">new</span> <span style="color: rgb(184, 191, 198);">ScheduledFutureTask&lt;</span><span style="color: rgb(28, 198, 133);">Void</span><span style="color: rgb(184, 191, 198);">&gt;</span>(</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">this</span>, <span style="color: rgb(184, 191, 198);">Executors</span>.<span style="color: rgb(184, 191, 198);">&lt;</span><span style="color: rgb(28, 198, 133);">Void</span><span style="color: rgb(184, 191, 198);">&gt;callable</span>(<span style="color: rgb(184, 191, 198);">command</span>, <span style="color: rgb(132, 182, 203);">null</span>),</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">ScheduledFutureTask</span>.<span style="color: rgb(184, 191, 198);">deadlineNanos</span>(<span style="color: rgb(184, 191, 198);">unit</span>.<span style="color: rgb(184, 191, 198);">toNanos</span>(<span style="color: rgb(184, 191, 198);">initialDelay</span>)), <span style="color: rgb(184, 191, 198);">unit</span>.<span style="color: rgb(184, 191, 198);">toNanos</span>(<span style="color: rgb(184, 191, 198);">period</span>)));</p>
<p>&nbsp;}</p>
<p>​</p>
<p>&nbsp;&nbsp;<span style="color: rgb(218, 146, 74);">// 固定周期执行方法支持</span></p>
<p>&nbsp;&nbsp;<span style="color: rgb(183, 179, 179);">@Override</span></p>
<p>&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">public</span> <span style="color: rgb(184, 191, 198);">ScheduledFuture&lt;?&gt;</span> <span style="color: rgb(184, 191, 198);">scheduleWithFixedDelay</span>(<span style="color: rgb(184, 191, 198);">Runnable</span> <span style="color: rgb(184, 191, 198);">command</span>, <span style="color: rgb(28, 198, 133);">long</span> <span style="color: rgb(184, 191, 198);">initialDelay</span>, <span style="color: rgb(28, 198, 133);">long</span> <span style="color: rgb(184, 191, 198);">delay</span>, <span style="color: rgb(184, 191, 198);">TimeUnit</span> <span style="color: rgb(184, 191, 198);">unit</span>) {</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">ObjectUtil</span>.<span style="color: rgb(184, 191, 198);">checkNotNull</span>(<span style="color: rgb(184, 191, 198);">command</span>, <span style="color: rgb(210, 107, 107);">"command"</span>);</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">ObjectUtil</span>.<span style="color: rgb(184, 191, 198);">checkNotNull</span>(<span style="color: rgb(184, 191, 198);">unit</span>, <span style="color: rgb(210, 107, 107);">"unit"</span>);</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">if</span> (<span style="color: rgb(184, 191, 198);">initialDelay</span> <span style="color: rgb(184, 191, 198);">&lt;</span> <span style="color: rgb(100, 171, 143);">0</span>) {</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">throw</span> <span style="color: rgb(200, 143, 208);">new</span> <span style="color: rgb(184, 191, 198);">IllegalArgumentException</span>(</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(28, 198, 133);">String</span>.<span style="color: rgb(184, 191, 198);">format</span>(<span style="color: rgb(210, 107, 107);">"initialDelay: %d (expected: &gt;= 0)"</span>, <span style="color: rgb(184, 191, 198);">initialDelay</span>));</p>
<p>&nbsp;&nbsp;&nbsp;}</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">if</span> (<span style="color: rgb(184, 191, 198);">delay</span> <span style="color: rgb(184, 191, 198);">&lt;=</span> <span style="color: rgb(100, 171, 143);">0</span>) {</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">throw</span> <span style="color: rgb(200, 143, 208);">new</span> <span style="color: rgb(184, 191, 198);">IllegalArgumentException</span>(</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(28, 198, 133);">String</span>.<span style="color: rgb(184, 191, 198);">format</span>(<span style="color: rgb(210, 107, 107);">"delay: %d (expected: &gt; 0)"</span>, <span style="color: rgb(184, 191, 198);">delay</span>));</p>
<p>&nbsp;&nbsp;&nbsp;}</p>
<p>​</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">return</span> <span style="color: rgb(184, 191, 198);">schedule</span>(<span style="color: rgb(200, 143, 208);">new</span> <span style="color: rgb(184, 191, 198);">ScheduledFutureTask&lt;</span><span style="color: rgb(28, 198, 133);">Void</span><span style="color: rgb(184, 191, 198);">&gt;</span>(</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">this</span>, <span style="color: rgb(184, 191, 198);">Executors</span>.<span style="color: rgb(184, 191, 198);">&lt;</span><span style="color: rgb(28, 198, 133);">Void</span><span style="color: rgb(184, 191, 198);">&gt;callable</span>(<span style="color: rgb(184, 191, 198);">command</span>, <span style="color: rgb(132, 182, 203);">null</span>),</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">ScheduledFutureTask</span>.<span style="color: rgb(184, 191, 198);">deadlineNanos</span>(<span style="color: rgb(184, 191, 198);">unit</span>.<span style="color: rgb(184, 191, 198);">toNanos</span>(<span style="color: rgb(184, 191, 198);">initialDelay</span>)), <span style="color: rgb(184, 191, 198);">-unit</span>.<span style="color: rgb(184, 191, 198);">toNanos</span>(<span style="color: rgb(184, 191, 198);">delay</span>)));</p>
<p>&nbsp;}</p>
<p>​</p>
<p>&nbsp;&nbsp;<span style="color: rgb(218, 146, 74);">// 完整实现周期性调度方法</span></p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">&lt;V&gt;</span> <span style="color: rgb(184, 191, 198);">ScheduledFuture&lt;V&gt;</span> <span style="color: rgb(184, 191, 198);">schedule</span>(<span style="color: rgb(200, 143, 208);">final</span> <span style="color: rgb(184, 191, 198);">ScheduledFutureTask&lt;V&gt;</span> <span style="color: rgb(184, 191, 198);">task</span>) {</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">if</span> (<span style="color: rgb(184, 191, 198);">inEventLoop</span>()) { <span style="color: rgb(218, 146, 74);">// 如果当前线程不在事件循环组，那么加入周期性任务队列（只能由当前执行器的线程来完成队列添加操作，这样就可以保证所有操作均由一个线程完成，此时保证了线程安全）</span></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">scheduledTaskQueue</span>().<span style="color: rgb(184, 191, 198);">add</span>(<span style="color: rgb(184, 191, 198);">task</span>);</p>
<p>&nbsp;&nbsp;&nbsp;} <span style="color: rgb(200, 143, 208);">else</span> { <span style="color: rgb(218, 146, 74);">// 否则直接调用execute方法执行（因为我们这里是Executor接口的实例，所以由线程执行的方法当然为Executor接口中定义的execute方法），在该方法中将任务放置到周期性任务队列</span></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">execute</span>(<span style="color: rgb(200, 143, 208);">new</span> <span style="color: rgb(184, 191, 198);">Runnable</span>() {</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(183, 179, 179);">@Override</span></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">public</span> <span style="color: rgb(28, 198, 133);">void</span> <span style="color: rgb(184, 191, 198);">run</span>() {</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">scheduledTaskQueue</span>().<span style="color: rgb(184, 191, 198);">add</span>(<span style="color: rgb(184, 191, 198);">task</span>);</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;});</p>
<p>&nbsp;&nbsp;&nbsp;}</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">return</span> <span style="color: rgb(184, 191, 198);">task</span>;</p>
<p>&nbsp;}</p>
<p>​</p>
<p>&nbsp;&nbsp;<span style="color: rgb(218, 146, 74);">// 将指定的任务task从周期性调度任务队列中移除，同样，这里只能有执行器所属的执行线程来完成该操作，保证线程安全</span></p>
<p>&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">final</span> <span style="color: rgb(28, 198, 133);">void</span> <span style="color: rgb(184, 191, 198);">removeScheduled</span>(<span style="color: rgb(200, 143, 208);">final</span> <span style="color: rgb(184, 191, 198);">ScheduledFutureTask&lt;?&gt;</span> <span style="color: rgb(184, 191, 198);">task</span>) {</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">if</span> (<span style="color: rgb(184, 191, 198);">inEventLoop</span>()) {</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">scheduledTaskQueue</span>().<span style="color: rgb(184, 191, 198);">remove</span>(<span style="color: rgb(184, 191, 198);">task</span>);</p>
<p>&nbsp;&nbsp;&nbsp;} <span style="color: rgb(200, 143, 208);">else</span> {</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">execute</span>(<span style="color: rgb(200, 143, 208);">new</span> <span style="color: rgb(184, 191, 198);">Runnable</span>() {</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(183, 179, 179);">@Override</span></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">public</span> <span style="color: rgb(28, 198, 133);">void</span> <span style="color: rgb(184, 191, 198);">run</span>() {</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">removeScheduled</span>(<span style="color: rgb(184, 191, 198);">task</span>);</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;});</p>
<p>&nbsp;&nbsp;&nbsp;}</p>
<p>&nbsp;}</p>
<p>}</p>
<p><br></p></p>
</body>
</html>