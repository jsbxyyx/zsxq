<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
</head>
<body>
<h1>Redis 深度分析系列二</h1>
<p>2022-06-04T15:16:44.508+0800</p>
<p><p>Redis 深度分析系列一中我们了解到了Redis 使用 ANSI C标准编写而出，没有其他外部依赖项，同时我们知道C语言中，main函数作为入口函数，Redis的初始化和启动肯定也在其中，本节我们来从main函数开始来看看Redis在初始化和启动时完成的操作，同时找到接受并处理客户端请求的入口。</p>
<p><strong>main 函数</strong></p>
<p>通过源码我们得知如下流程信息：</p>
<ol>
 <li>Redis在启动时，将会初始化服务器响应的配置信息，这些配置信息我们在后面用到时再详细讲解</li>
 <li>解析参数并根据客户端参数加载并解析配置文件，然后进一步初始化Redis Server的变量信息</li>
 <li>检测内核的内存分配策略参数</li>
 <li>检测TCP FD与Unix FD</li>
 <li>设置事件循环eventloop并启动主循环处理程序</li>
 <li>结束后删除事件循环结构</li>
</ol>
<p><span style="color: rgb(28, 198, 133);">int</span> <span style="color: rgb(141, 141, 240);">main</span>(<span style="color: rgb(28, 198, 133);">int</span> <span style="color: rgb(184, 191, 198);">argc</span>, <span style="color: rgb(28, 198, 133);">char</span> <span style="color: rgb(28, 198, 133);">**</span><span style="color: rgb(184, 191, 198);">argv</span>) {</p>
<p>&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">struct</span> <span style="color: rgb(141, 141, 240);">timeval</span> <span style="color: rgb(141, 141, 240);">tv</span>;</p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">zmalloc_enable_thread_safeness</span>(); <span style="color: rgb(218, 146, 74);">// 设置变量 static int zmalloc_thread_safe = 1;</span></p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">zmalloc_set_oom_handler</span>(<span style="color: rgb(184, 191, 198);">redisOutOfMemoryHandler</span>); <span style="color: rgb(218, 146, 74);">// 设置发生OOM时回调的函数</span></p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">srand</span>(<span style="color: rgb(184, 191, 198);">time</span>(<span style="color: rgb(184, 191, 198);">NULL</span>)<span style="color: rgb(184, 191, 198);">^getpid</span>()); <span style="color: rgb(218, 146, 74);">// 使用当前进程的ID（getpid()）与当前时间一起初始化随机数种子</span></p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">gettimeofday</span>(<span style="color: rgb(184, 191, 198);">&amp;tv</span>,<span style="color: rgb(184, 191, 198);">NULL</span>); <span style="color: rgb(218, 146, 74);">// 获取当前时间信息，放入timeval结构体</span></p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">dictSetHashFunctionSeed</span>(<span style="color: rgb(184, 191, 198);">tv</span>.<span style="color: rgb(184, 191, 198);">tv_sec^tv</span>.<span style="color: rgb(184, 191, 198);">tv_usec^getpid</span>()); <span style="color: rgb(218, 146, 74);">// 使用当前时间的秒信息（tv_sec）与毫秒信息（tv_usec） 与进程id 设置变量 static uint32_t dict_hash_function_seed = 5381，在hash函数中是用来散列key-value</span></p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">server</span>.<span style="color: rgb(184, 191, 198);">sentinel_mode</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">checkForSentinelMode</span>(<span style="color: rgb(184, 191, 198);">argc</span>,<span style="color: rgb(184, 191, 198);">argv</span>); <span style="color: rgb(218, 146, 74);">// 从参数中解析，看看是否以哨兵模式启动，这里我们忽略</span></p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">initServerConfig</span>(); <span style="color: rgb(218, 146, 74);">// 初始化Redis 服务器的相关配置信息</span></p>
<p>​</p>
<p>&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">if</span> (<span style="color: rgb(184, 191, 198);">server</span>.<span style="color: rgb(184, 191, 198);">sentinel_mode</span>) { <span style="color: rgb(218, 146, 74);">// 初始化哨兵模式（忽略）</span></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">initSentinelConfig</span>();</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">initSentinel</span>();</p>
<p>&nbsp;}</p>
<p>​</p>
<p>&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">if</span> (<span style="color: rgb(184, 191, 198);">argc</span> <span style="color: rgb(184, 191, 198);">&gt;=</span> <span style="color: rgb(100, 171, 143);">2</span>) { <span style="color: rgb(218, 146, 74);">// 解析参数</span></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(28, 198, 133);">int</span> <span style="color: rgb(184, 191, 198);">j</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(100, 171, 143);">1</span>;</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">sds</span> <span style="color: rgb(184, 191, 198);">options</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">sdsempty</span>(); <span style="color: rgb(218, 146, 74);">// 分配一个redis 字符串来保存参数（后面会详细解释sds，现在只需要知道它是一个字符串即可）</span></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(28, 198, 133);">char</span> <span style="color: rgb(28, 198, 133);">*</span><span style="color: rgb(184, 191, 198);">configfile</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">NULL</span>;</p>
<p>​</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(218, 146, 74);">// 根据参数值完成相应处理</span></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">if</span> (<span style="color: rgb(184, 191, 198);">strcmp</span>(<span style="color: rgb(184, 191, 198);">argv</span>[<span style="color: rgb(100, 171, 143);">1</span>], <span style="color: rgb(210, 107, 107);">"-v"</span>) <span style="color: rgb(184, 191, 198);">==</span> <span style="color: rgb(100, 171, 143);">0</span> <span style="color: rgb(184, 191, 198);">||</span></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">strcmp</span>(<span style="color: rgb(184, 191, 198);">argv</span>[<span style="color: rgb(100, 171, 143);">1</span>], <span style="color: rgb(210, 107, 107);">"--version"</span>) <span style="color: rgb(184, 191, 198);">==</span> <span style="color: rgb(100, 171, 143);">0</span>) <span style="color: rgb(184, 191, 198);">version</span>();</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">if</span> (<span style="color: rgb(184, 191, 198);">strcmp</span>(<span style="color: rgb(184, 191, 198);">argv</span>[<span style="color: rgb(100, 171, 143);">1</span>], <span style="color: rgb(210, 107, 107);">"--help"</span>) <span style="color: rgb(184, 191, 198);">==</span> <span style="color: rgb(100, 171, 143);">0</span> <span style="color: rgb(184, 191, 198);">||</span></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">strcmp</span>(<span style="color: rgb(184, 191, 198);">argv</span>[<span style="color: rgb(100, 171, 143);">1</span>], <span style="color: rgb(210, 107, 107);">"-h"</span>) <span style="color: rgb(184, 191, 198);">==</span> <span style="color: rgb(100, 171, 143);">0</span>) <span style="color: rgb(184, 191, 198);">usage</span>();</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">if</span> (<span style="color: rgb(184, 191, 198);">strcmp</span>(<span style="color: rgb(184, 191, 198);">argv</span>[<span style="color: rgb(100, 171, 143);">1</span>], <span style="color: rgb(210, 107, 107);">"--test-memory"</span>) <span style="color: rgb(184, 191, 198);">==</span> <span style="color: rgb(100, 171, 143);">0</span>) {</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">if</span> (<span style="color: rgb(184, 191, 198);">argc</span> <span style="color: rgb(184, 191, 198);">==</span> <span style="color: rgb(100, 171, 143);">3</span>) {</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">memtest</span>(<span style="color: rgb(184, 191, 198);">atoi</span>(<span style="color: rgb(184, 191, 198);">argv</span>[<span style="color: rgb(100, 171, 143);">2</span>]),<span style="color: rgb(100, 171, 143);">50</span>);</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">exit</span>(<span style="color: rgb(100, 171, 143);">0</span>);</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} <span style="color: rgb(200, 143, 208);">else</span> {</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">fprintf</span>(<span style="color: rgb(184, 191, 198);">stderr</span>,<span style="color: rgb(210, 107, 107);">"Please specify the amount of memory to test in megabytes.\n"</span>);</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">fprintf</span>(<span style="color: rgb(184, 191, 198);">stderr</span>,<span style="color: rgb(210, 107, 107);">"Example: ./redis-server --test-memory 4096\n\n"</span>);</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">exit</span>(<span style="color: rgb(100, 171, 143);">1</span>);</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</p>
<p>&nbsp;&nbsp;&nbsp;}</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">if</span> (<span style="color: rgb(184, 191, 198);">argv</span>[<span style="color: rgb(184, 191, 198);">j</span>][<span style="color: rgb(100, 171, 143);">0</span>] <span style="color: rgb(184, 191, 198);">!=</span> <span style="color: rgb(210, 107, 107);">'-'</span> <span style="color: rgb(184, 191, 198);">||</span> <span style="color: rgb(184, 191, 198);">argv</span>[<span style="color: rgb(184, 191, 198);">j</span>][<span style="color: rgb(100, 171, 143);">1</span>] <span style="color: rgb(184, 191, 198);">!=</span> <span style="color: rgb(210, 107, 107);">'-'</span>)</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">configfile</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">argv</span>[<span style="color: rgb(184, 191, 198);">j++</span>];</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">while</span>(<span style="color: rgb(184, 191, 198);">j</span> <span style="color: rgb(184, 191, 198);">!=</span> <span style="color: rgb(184, 191, 198);">argc</span>) {</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">if</span> (<span style="color: rgb(184, 191, 198);">argv</span>[<span style="color: rgb(184, 191, 198);">j</span>][<span style="color: rgb(100, 171, 143);">0</span>] <span style="color: rgb(184, 191, 198);">==</span> <span style="color: rgb(210, 107, 107);">'-'</span> <span style="color: rgb(184, 191, 198);">&amp;&amp;</span> <span style="color: rgb(184, 191, 198);">argv</span>[<span style="color: rgb(184, 191, 198);">j</span>][<span style="color: rgb(100, 171, 143);">1</span>] <span style="color: rgb(184, 191, 198);">==</span> <span style="color: rgb(210, 107, 107);">'-'</span>) {</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(218, 146, 74);">// 解析参数名</span></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">if</span> (<span style="color: rgb(184, 191, 198);">sdslen</span>(<span style="color: rgb(184, 191, 198);">options</span>)) <span style="color: rgb(184, 191, 198);">options</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">sdscat</span>(<span style="color: rgb(184, 191, 198);">options</span>,<span style="color: rgb(210, 107, 107);">"\n"</span>);</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">options</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">sdscat</span>(<span style="color: rgb(184, 191, 198);">options</span>,<span style="color: rgb(184, 191, 198);">argv</span>[<span style="color: rgb(184, 191, 198);">j</span>]<span style="color: rgb(184, 191, 198);">+</span><span style="color: rgb(100, 171, 143);">2</span>);</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">options</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">sdscat</span>(<span style="color: rgb(184, 191, 198);">options</span>,<span style="color: rgb(210, 107, 107);">" "</span>);</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} <span style="color: rgb(200, 143, 208);">else</span> {</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(218, 146, 74);">// 解析参数值</span></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">options</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">sdscatrepr</span>(<span style="color: rgb(184, 191, 198);">options</span>,<span style="color: rgb(184, 191, 198);">argv</span>[<span style="color: rgb(184, 191, 198);">j</span>],<span style="color: rgb(184, 191, 198);">strlen</span>(<span style="color: rgb(184, 191, 198);">argv</span>[<span style="color: rgb(184, 191, 198);">j</span>]));</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">options</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">sdscat</span>(<span style="color: rgb(184, 191, 198);">options</span>,<span style="color: rgb(210, 107, 107);">" "</span>);</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">j++</span>;</p>
<p>&nbsp;&nbsp;&nbsp;}</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">resetServerSaveParams</span>(); <span style="color: rgb(218, 146, 74);">// 重置服务器参数：server.saveparams = NULL</span></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">loadServerConfig</span>(<span style="color: rgb(184, 191, 198);">configfile</span>,<span style="color: rgb(184, 191, 198);">options</span>); <span style="color: rgb(218, 146, 74);">// 根据参数中指定的配置文件和参数初始化服务器配置</span></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">sdsfree</span>(<span style="color: rgb(184, 191, 198);">options</span>); <span style="color: rgb(218, 146, 74);">// 启动参数主要用于初始化服务器配置，使用完毕后释放其占用空间</span></p>
<p>&nbsp;} <span style="color: rgb(200, 143, 208);">else</span> { <span style="color: rgb(218, 146, 74);">// 没有指定配置文件，那么打印警告日志</span></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">redisLog</span>(<span style="color: rgb(184, 191, 198);">REDIS_WARNING</span>, <span style="color: rgb(210, 107, 107);">"Warning: no config file specified, using the default config. In order to specify a config file use %s /path/to/%s.conf"</span>, <span style="color: rgb(184, 191, 198);">argv</span>[<span style="color: rgb(100, 171, 143);">0</span>], <span style="color: rgb(184, 191, 198);">server</span>.<span style="color: rgb(184, 191, 198);">sentinel_mode</span> <span style="color: rgb(184, 191, 198);">?</span> <span style="color: rgb(210, 107, 107);">"sentinel"</span> : <span style="color: rgb(210, 107, 107);">"redis"</span>);</p>
<p>&nbsp;}</p>
<p>&nbsp;&nbsp;<span style="color: rgb(218, 146, 74);">// 如果指定Redis 作为后台进程运行，那么调用daemonize fork出另外的进程在后台执行</span></p>
<p>&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">if</span> (<span style="color: rgb(184, 191, 198);">server</span>.<span style="color: rgb(184, 191, 198);">daemonize</span>) <span style="color: rgb(184, 191, 198);">daemonize</span>();</p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">initServer</span>(); <span style="color: rgb(218, 146, 74);">// 完成Redis Server的剩余变量初始化</span></p>
<p>&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">if</span> (<span style="color: rgb(184, 191, 198);">server</span>.<span style="color: rgb(184, 191, 198);">daemonize</span>) <span style="color: rgb(184, 191, 198);">createPidFile</span>(); <span style="color: rgb(218, 146, 74);">// 若Redis在后台执行，那么创建pid文件，告知当前正在后台执行的Redis pid信息</span></p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">redisAsciiArt</span>(); <span style="color: rgb(218, 146, 74);">// 打印Redis ascii编码的图形（忽略）</span></p>
<p>​</p>
<p>&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">if</span> (<span style="color: rgb(184, 191, 198);">!server</span>.<span style="color: rgb(184, 191, 198);">sentinel_mode</span>) { <span style="color: rgb(218, 146, 74);">// 执行只有在不运行在哨兵模式时才需要的动作</span></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">redisLog</span>(<span style="color: rgb(184, 191, 198);">REDIS_WARNING</span>,<span style="color: rgb(210, 107, 107);">"Server started, Redis version "</span> <span style="color: rgb(184, 191, 198);">REDIS_VERSION</span>);</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(218, 146, 74);">// 如果在Linux平台下，指定了 OvercommitMemory 为 0，那么打印警告日志（注：overcommit_memory=0， 表示内核将检查是否有足够的可用内存供应用进程使用，如果有足够 的可用内存，内存申请允许，否则，内存申请失败，并把错误返回给应用进程。 overcommit_memory=1， 表示内核允许分配所有的物理内存，而不管当前的内存状态如何。 overcommit_memory=2， 表示内核允许分配超过所有物理内存和swap空间总和的内存）</span></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(183, 179, 179);">#ifdef __linux__ </span></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">linuxOvercommitMemoryWarning</span>();</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(183, 179, 179);">#endif</span></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">loadDataFromDisk</span>(); <span style="color: rgb(218, 146, 74);">// 从磁盘中加载之前保存的RDB或者AOF文件</span></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">if</span> (<span style="color: rgb(184, 191, 198);">server</span>.<span style="color: rgb(184, 191, 198);">ipfd</span> <span style="color: rgb(184, 191, 198);">&gt;</span> <span style="color: rgb(100, 171, 143);">0</span>) <span style="color: rgb(218, 146, 74);">// 正确设置TCP socket FD 文件描述符，表明当前可以正确接收来自客户端的TCP连接</span></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">redisLog</span>(<span style="color: rgb(184, 191, 198);">REDIS_NOTICE</span>,<span style="color: rgb(210, 107, 107);">"The server is now ready to accept connections on port %d"</span>, <span style="color: rgb(184, 191, 198);">server</span>.<span style="color: rgb(184, 191, 198);">port</span>);</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">if</span> (<span style="color: rgb(184, 191, 198);">server</span>.<span style="color: rgb(184, 191, 198);">sofd</span> <span style="color: rgb(184, 191, 198);">&gt;</span> <span style="color: rgb(100, 171, 143);">0</span>) <span style="color: rgb(218, 146, 74);">// 正确设置Unix socket FD 文件描述符，表明当前可以正确接收来自本机进程的Unix套接字连接（什么是Unix套接字？一种本地进程通讯的方式，不经过协议栈，但可以使用Socket来完成通讯）</span></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">redisLog</span>(<span style="color: rgb(184, 191, 198);">REDIS_NOTICE</span>,<span style="color: rgb(210, 107, 107);">"The server is now ready to accept connections at %s"</span>, <span style="color: rgb(184, 191, 198);">server</span>.<span style="color: rgb(184, 191, 198);">unixsocket</span>);</p>
<p>&nbsp;}</p>
<p>​</p>
<p>&nbsp;&nbsp;<span style="color: rgb(218, 146, 74);">// 检查用户设置的内存是否足够，需要大于1M</span></p>
<p>&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">if</span> (<span style="color: rgb(184, 191, 198);">server</span>.<span style="color: rgb(184, 191, 198);">maxmemory</span> <span style="color: rgb(184, 191, 198);">&gt;</span> <span style="color: rgb(100, 171, 143);">0</span> <span style="color: rgb(184, 191, 198);">&amp;&amp;</span> <span style="color: rgb(184, 191, 198);">server</span>.<span style="color: rgb(184, 191, 198);">maxmemory</span> <span style="color: rgb(184, 191, 198);">&lt;</span> <span style="color: rgb(100, 171, 143);">1024</span><span style="color: rgb(184, 191, 198);">*</span><span style="color: rgb(100, 171, 143);">1024</span>) {</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">redisLog</span>(<span style="color: rgb(184, 191, 198);">REDIS_WARNING</span>,<span style="color: rgb(210, 107, 107);">"WARNING: You specified a maxmemory value that is less than 1MB (current value is %llu bytes). Are you sure this is what you really want?"</span>, <span style="color: rgb(184, 191, 198);">server</span>.<span style="color: rgb(184, 191, 198);">maxmemory</span>);</p>
<p>&nbsp;}</p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">aeSetBeforeSleepProc</span>(<span style="color: rgb(184, 191, 198);">server</span>.<span style="color: rgb(184, 191, 198);">el</span>,<span style="color: rgb(184, 191, 198);">beforeSleep</span>); <span style="color: rgb(218, 146, 74);">// 设置执行睡眠前的回调函数：eventLoop-&gt;beforesleep = beforesleep;</span></p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">aeMain</span>(<span style="color: rgb(184, 191, 198);">server</span>.<span style="color: rgb(184, 191, 198);">el</span>); <span style="color: rgb(218, 146, 74);">// 执行主事件循环，处理准备好的事件</span></p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">aeDeleteEventLoop</span>(<span style="color: rgb(184, 191, 198);">server</span>.<span style="color: rgb(184, 191, 198);">el</span>); <span style="color: rgb(218, 146, 74);">// 退出循环，表明当前需要关闭Redis，那么关闭打开的事件循环</span></p>
<p>&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">return</span> <span style="color: rgb(100, 171, 143);">0</span>;</p>
<p>}</p>
<p><strong>initServerConfig 函数</strong></p>
<p>该函数用于初始化全局结构redisServer的变量，读者这里只需要观察初始化了哪些变量即可，不需要关注初始化的细节，因为这里面的值都是写死的默认值，对于可配置的变量将可以通过后面解析config文件的变量进行覆盖，当我们不需要使用这些变量时，不需要了解其意思，在后面函数中用到对应参数时，再详细讲解。源码如下。</p>
<p><span style="color: rgb(218, 146, 74);">// Redis 服务器全局结构，其中的变量，我们在用到时在分析，这里只需要了解拥有该结构即可</span></p>
<p><span style="color: rgb(200, 143, 208);">struct</span> <span style="color: rgb(141, 141, 240);">redisServer</span> {</p>
<p>};</p>
<p><span style="color: rgb(200, 143, 208);">struct</span> <span style="color: rgb(141, 141, 240);">redisServer</span> <span style="color: rgb(141, 141, 240);">server</span>;</p>
<p><span style="color: rgb(28, 198, 133);">void</span> <span style="color: rgb(141, 141, 240);">initServerConfig</span>() {</p>
<p>&nbsp;... <span style="color: rgb(218, 146, 74);">// 初始化普通变量</span></p>
<p>&nbsp;&nbsp;<span style="color: rgb(218, 146, 74);">/* 初始化副本集配置 */</span></p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">server</span>.<span style="color: rgb(184, 191, 198);">masterauth</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">NULL</span>;</p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">server</span>.<span style="color: rgb(184, 191, 198);">masterhost</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">NULL</span>;</p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">server</span>.<span style="color: rgb(184, 191, 198);">masterport</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(100, 171, 143);">6379</span>;</p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">server</span>.<span style="color: rgb(184, 191, 198);">master</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">NULL</span>;</p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">server</span>.<span style="color: rgb(184, 191, 198);">repl_state</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">REDIS_REPL_NONE</span>;</p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">server</span>.<span style="color: rgb(184, 191, 198);">repl_syncio_timeout</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">REDIS_REPL_SYNCIO_TIMEOUT</span>;</p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">server</span>.<span style="color: rgb(184, 191, 198);">repl_serve_stale_data</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(100, 171, 143);">1</span>;</p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">server</span>.<span style="color: rgb(184, 191, 198);">repl_slave_ro</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(100, 171, 143);">1</span>;</p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">server</span>.<span style="color: rgb(184, 191, 198);">repl_down_since</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">time</span>(<span style="color: rgb(184, 191, 198);">NULL</span>);</p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">server</span>.<span style="color: rgb(184, 191, 198);">slave_priority</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">REDIS_DEFAULT_SLAVE_PRIORITY</span>;</p>
<p>​</p>
<p>&nbsp;&nbsp;<span style="color: rgb(218, 146, 74);">/* 初始化客户端输出缓冲区限制值 */</span></p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">server</span>.<span style="color: rgb(184, 191, 198);">client_obuf_limits</span>[<span style="color: rgb(184, 191, 198);">REDIS_CLIENT_LIMIT_CLASS_NORMAL</span>].<span style="color: rgb(184, 191, 198);">hard_limit_bytes</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(100, 171, 143);">0</span>;</p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">server</span>.<span style="color: rgb(184, 191, 198);">client_obuf_limits</span>[<span style="color: rgb(184, 191, 198);">REDIS_CLIENT_LIMIT_CLASS_NORMAL</span>].<span style="color: rgb(184, 191, 198);">soft_limit_bytes</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(100, 171, 143);">0</span>;</p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">server</span>.<span style="color: rgb(184, 191, 198);">client_obuf_limits</span>[<span style="color: rgb(184, 191, 198);">REDIS_CLIENT_LIMIT_CLASS_NORMAL</span>].<span style="color: rgb(184, 191, 198);">soft_limit_seconds</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(100, 171, 143);">0</span>;</p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">server</span>.<span style="color: rgb(184, 191, 198);">client_obuf_limits</span>[<span style="color: rgb(184, 191, 198);">REDIS_CLIENT_LIMIT_CLASS_SLAVE</span>].<span style="color: rgb(184, 191, 198);">hard_limit_bytes</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(100, 171, 143);">1024</span><span style="color: rgb(184, 191, 198);">*</span><span style="color: rgb(100, 171, 143);">1024</span><span style="color: rgb(184, 191, 198);">*</span><span style="color: rgb(100, 171, 143);">256</span>;</p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">server</span>.<span style="color: rgb(184, 191, 198);">client_obuf_limits</span>[<span style="color: rgb(184, 191, 198);">REDIS_CLIENT_LIMIT_CLASS_SLAVE</span>].<span style="color: rgb(184, 191, 198);">soft_limit_bytes</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(100, 171, 143);">1024</span><span style="color: rgb(184, 191, 198);">*</span><span style="color: rgb(100, 171, 143);">1024</span><span style="color: rgb(184, 191, 198);">*</span><span style="color: rgb(100, 171, 143);">64</span>;</p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">server</span>.<span style="color: rgb(184, 191, 198);">client_obuf_limits</span>[<span style="color: rgb(184, 191, 198);">REDIS_CLIENT_LIMIT_CLASS_SLAVE</span>].<span style="color: rgb(184, 191, 198);">soft_limit_seconds</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(100, 171, 143);">60</span>;</p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">server</span>.<span style="color: rgb(184, 191, 198);">client_obuf_limits</span>[<span style="color: rgb(184, 191, 198);">REDIS_CLIENT_LIMIT_CLASS_PUBSUB</span>].<span style="color: rgb(184, 191, 198);">hard_limit_bytes</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(100, 171, 143);">1024</span><span style="color: rgb(184, 191, 198);">*</span><span style="color: rgb(100, 171, 143);">1024</span><span style="color: rgb(184, 191, 198);">*</span><span style="color: rgb(100, 171, 143);">32</span>;</p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">server</span>.<span style="color: rgb(184, 191, 198);">client_obuf_limits</span>[<span style="color: rgb(184, 191, 198);">REDIS_CLIENT_LIMIT_CLASS_PUBSUB</span>].<span style="color: rgb(184, 191, 198);">soft_limit_bytes</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(100, 171, 143);">1024</span><span style="color: rgb(184, 191, 198);">*</span><span style="color: rgb(100, 171, 143);">1024</span><span style="color: rgb(184, 191, 198);">*</span><span style="color: rgb(100, 171, 143);">8</span>;</p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">server</span>.<span style="color: rgb(184, 191, 198);">client_obuf_limits</span>[<span style="color: rgb(184, 191, 198);">REDIS_CLIENT_LIMIT_CLASS_PUBSUB</span>].<span style="color: rgb(184, 191, 198);">soft_limit_seconds</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(100, 171, 143);">60</span>;</p>
<p>​</p>
<p>&nbsp;&nbsp;<span style="color: rgb(218, 146, 74);">/* 初始化浮点值计算变量 */</span></p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">R_Zero</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(100, 171, 143);">0.0</span>;</p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">R_PosInf</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(100, 171, 143);">1.0</span><span style="color: rgb(184, 191, 198);">/R_Zero</span>;</p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">R_NegInf</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">-</span><span style="color: rgb(100, 171, 143);">1.0</span><span style="color: rgb(184, 191, 198);">/R_Zero</span>;</p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">R_Nan</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">R_Zero/R_Zero</span>;</p>
<p>​</p>
<p>&nbsp;&nbsp;<span style="color: rgb(218, 146, 74);">/* 初始化命令行参数表（采用hash表结构来存储） */</span></p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">server</span>.<span style="color: rgb(184, 191, 198);">commands</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">dictCreate</span>(<span style="color: rgb(184, 191, 198);">&amp;commandTableDictType</span>,<span style="color: rgb(184, 191, 198);">NULL</span>);</p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">populateCommandTable</span>();</p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">server</span>.<span style="color: rgb(184, 191, 198);">delCommand</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">lookupCommandByCString</span>(<span style="color: rgb(210, 107, 107);">"del"</span>);</p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">server</span>.<span style="color: rgb(184, 191, 198);">multiCommand</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">lookupCommandByCString</span>(<span style="color: rgb(210, 107, 107);">"multi"</span>);</p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">server</span>.<span style="color: rgb(184, 191, 198);">lpushCommand</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">lookupCommandByCString</span>(<span style="color: rgb(210, 107, 107);">"lpush"</span>);</p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">server</span>.<span style="color: rgb(184, 191, 198);">lpopCommand</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">lookupCommandByCString</span>(<span style="color: rgb(210, 107, 107);">"lpop"</span>);</p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">server</span>.<span style="color: rgb(184, 191, 198);">rpopCommand</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">lookupCommandByCString</span>(<span style="color: rgb(210, 107, 107);">"rpop"</span>);</p>
<p>​</p>
<p>&nbsp;&nbsp;<span style="color: rgb(218, 146, 74);">/* 初始化慢日志参数 */</span></p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">server</span>.<span style="color: rgb(184, 191, 198);">slowlog_log_slower_than</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">REDIS_SLOWLOG_LOG_SLOWER_THAN</span>;</p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">server</span>.<span style="color: rgb(184, 191, 198);">slowlog_max_len</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">REDIS_SLOWLOG_MAX_LEN</span>;</p>
<p>​</p>
<p>&nbsp;&nbsp;<span style="color: rgb(218, 146, 74);">/* 初始化调试参数 */</span></p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">server</span>.<span style="color: rgb(184, 191, 198);">assert_failed</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(210, 107, 107);">"&lt;no assertion failed&gt;"</span>;</p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">server</span>.<span style="color: rgb(184, 191, 198);">assert_file</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(210, 107, 107);">"&lt;no file&gt;"</span>;</p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">server</span>.<span style="color: rgb(184, 191, 198);">assert_line</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(100, 171, 143);">0</span>;</p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">server</span>.<span style="color: rgb(184, 191, 198);">bug_report_start</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(100, 171, 143);">0</span>;</p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">server</span>.<span style="color: rgb(184, 191, 198);">watchdog_period</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(100, 171, 143);">0</span>;</p>
<p>}</p>
<p><strong>initServer 函数</strong></p>
<p>该函数用于初始化RedisServer结构的剩余参数。该函数将会把Redis的动态信息进行初始化：</p>
<ol>
 <li>信号处理相关</li>
 <li>全局结构</li>
 <li>处理客户端连接的TCP端口、Unix端口和对应的处理函数：acceptTcpHandler、acceptUnixHandler（至此：我们看到客户端的输入事件将会在这两个函数处理，而该两个函数如何注册到事件循环中，以及事件循环如何接收客户端连接，我们下一篇详细讲解，这里了解即可，因为我们的目的是观察Redis的启动流程，以及涉及到的全局结构）</li>
 <li>Redis 数据库</li>
 <li>LUA 执行脚本</li>
 <li>慢查询日志</li>
 <li>后台执行线程</li>
</ol>
<p><span style="color: rgb(28, 198, 133);">void</span> <span style="color: rgb(141, 141, 240);">initServer</span>() {</p>
<p>&nbsp;&nbsp;<span style="color: rgb(28, 198, 133);">int</span> <span style="color: rgb(184, 191, 198);">j</span>;</p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">signal</span>(<span style="color: rgb(184, 191, 198);">SIGHUP</span>, <span style="color: rgb(184, 191, 198);">SIG_IGN</span>); <span style="color: rgb(218, 146, 74);">// 屏蔽SIGHUP信号，SIG_IGN表示 SIG_IGNORE 忽略该信号（该信号讲在控制进程或者终端退出时发出。手册描述：Hangup detected on controlling terminal or death of controlling process）</span></p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">signal</span>(<span style="color: rgb(184, 191, 198);">SIGPIPE</span>, <span style="color: rgb(184, 191, 198);">SIG_IGN</span>);<span style="color: rgb(218, 146, 74);">// 屏蔽SIGPIPE信号（该信号： 在写入pipe管道时，没有进程读取数据时发出。手册描述：Broken pipe: write to pipe with no readers）</span></p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">setupSignalHandlers</span>(); <span style="color: rgb(218, 146, 74);">// 设置其他信号的处理函数</span></p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">server</span>.<span style="color: rgb(184, 191, 198);">current_client</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">NULL</span>;</p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">server</span>.<span style="color: rgb(184, 191, 198);">clients</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">listCreate</span>();</p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">server</span>.<span style="color: rgb(184, 191, 198);">clients_to_close</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">listCreate</span>();</p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">server</span>.<span style="color: rgb(184, 191, 198);">slaves</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">listCreate</span>();</p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">server</span>.<span style="color: rgb(184, 191, 198);">monitors</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">listCreate</span>();</p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">server</span>.<span style="color: rgb(184, 191, 198);">unblocked_clients</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">listCreate</span>();</p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">server</span>.<span style="color: rgb(184, 191, 198);">ready_keys</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">listCreate</span>();</p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">createSharedObjects</span>(); <span style="color: rgb(218, 146, 74);">// 创建redis共享对象：struct sharedObjectsStruct {},节省每次在使用共享对象时都需要分配和释放内存导致的性能损耗，考虑下常量池的设计</span></p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">adjustOpenFilesLimit</span>();<span style="color: rgb(218, 146, 74);">// 调整redis 打开文件描述符的限制</span></p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">server</span>.<span style="color: rgb(184, 191, 198);">el</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">aeCreateEventLoop</span>(<span style="color: rgb(184, 191, 198);">server</span>.<span style="color: rgb(184, 191, 198);">maxclients+</span><span style="color: rgb(100, 171, 143);">1024</span>); <span style="color: rgb(218, 146, 74);">// 创建事件循环线程</span></p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">server</span>.<span style="color: rgb(184, 191, 198);">db</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">zmalloc</span>(<span style="color: rgb(200, 143, 208);">sizeof</span>(<span style="color: rgb(184, 191, 198);">redisDb</span>)<span style="color: rgb(184, 191, 198);">*server</span>.<span style="color: rgb(184, 191, 198);">dbnum</span>); <span style="color: rgb(218, 146, 74);">// 创建redis 数据库对象：typedef struct redisDb {} redisDb</span></p>
<p>&nbsp;&nbsp;<span style="color: rgb(218, 146, 74);">// 初始化 TCP 端口</span></p>
<p>&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">if</span> (<span style="color: rgb(184, 191, 198);">server</span>.<span style="color: rgb(184, 191, 198);">port</span> <span style="color: rgb(184, 191, 198);">!=</span> <span style="color: rgb(100, 171, 143);">0</span>) {</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">server</span>.<span style="color: rgb(184, 191, 198);">ipfd</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">anetTcpServer</span>(<span style="color: rgb(184, 191, 198);">server</span>.<span style="color: rgb(184, 191, 198);">neterr</span>,<span style="color: rgb(184, 191, 198);">server</span>.<span style="color: rgb(184, 191, 198);">port</span>,<span style="color: rgb(184, 191, 198);">server</span>.<span style="color: rgb(184, 191, 198);">bindaddr</span>);</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">if</span> (<span style="color: rgb(184, 191, 198);">server</span>.<span style="color: rgb(184, 191, 198);">ipfd</span> <span style="color: rgb(184, 191, 198);">==</span> <span style="color: rgb(184, 191, 198);">ANET_ERR</span>) {</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">redisLog</span>(<span style="color: rgb(184, 191, 198);">REDIS_WARNING</span>, <span style="color: rgb(210, 107, 107);">"Opening port %d: %s"</span>,</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">server</span>.<span style="color: rgb(184, 191, 198);">port</span>, <span style="color: rgb(184, 191, 198);">server</span>.<span style="color: rgb(184, 191, 198);">neterr</span>);</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">exit</span>(<span style="color: rgb(100, 171, 143);">1</span>);</p>
<p>&nbsp;&nbsp;&nbsp;}</p>
<p>&nbsp;}</p>
<p>&nbsp;&nbsp;<span style="color: rgb(218, 146, 74);">// 初始化Unix 端口</span></p>
<p>&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">if</span> (<span style="color: rgb(184, 191, 198);">server</span>.<span style="color: rgb(184, 191, 198);">unixsocket</span> <span style="color: rgb(184, 191, 198);">!=</span> <span style="color: rgb(184, 191, 198);">NULL</span>) {</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">unlink</span>(<span style="color: rgb(184, 191, 198);">server</span>.<span style="color: rgb(184, 191, 198);">unixsocket</span>); <span style="color: rgb(218, 146, 74);">/* don't care if this fails */</span></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">server</span>.<span style="color: rgb(184, 191, 198);">sofd</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">anetUnixServer</span>(<span style="color: rgb(184, 191, 198);">server</span>.<span style="color: rgb(184, 191, 198);">neterr</span>,<span style="color: rgb(184, 191, 198);">server</span>.<span style="color: rgb(184, 191, 198);">unixsocket</span>,<span style="color: rgb(184, 191, 198);">server</span>.<span style="color: rgb(184, 191, 198);">unixsocketperm</span>);</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">if</span> (<span style="color: rgb(184, 191, 198);">server</span>.<span style="color: rgb(184, 191, 198);">sofd</span> <span style="color: rgb(184, 191, 198);">==</span> <span style="color: rgb(184, 191, 198);">ANET_ERR</span>) {</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">redisLog</span>(<span style="color: rgb(184, 191, 198);">REDIS_WARNING</span>, <span style="color: rgb(210, 107, 107);">"Opening socket: %s"</span>, <span style="color: rgb(184, 191, 198);">server</span>.<span style="color: rgb(184, 191, 198);">neterr</span>);</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">exit</span>(<span style="color: rgb(100, 171, 143);">1</span>);</p>
<p>&nbsp;&nbsp;&nbsp;}</p>
<p>&nbsp;}</p>
<p>&nbsp;&nbsp;<span style="color: rgb(218, 146, 74);">// 检测端口是否有效</span></p>
<p>&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">if</span> (<span style="color: rgb(184, 191, 198);">server</span>.<span style="color: rgb(184, 191, 198);">ipfd</span> <span style="color: rgb(184, 191, 198);">&lt;</span> <span style="color: rgb(100, 171, 143);">0</span> <span style="color: rgb(184, 191, 198);">&amp;&amp;</span> <span style="color: rgb(184, 191, 198);">server</span>.<span style="color: rgb(184, 191, 198);">sofd</span> <span style="color: rgb(184, 191, 198);">&lt;</span> <span style="color: rgb(100, 171, 143);">0</span>) {</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">redisLog</span>(<span style="color: rgb(184, 191, 198);">REDIS_WARNING</span>, <span style="color: rgb(210, 107, 107);">"Configured to not listen anywhere, exiting."</span>);</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">exit</span>(<span style="color: rgb(100, 171, 143);">1</span>);</p>
<p>&nbsp;}</p>
<p>&nbsp;&nbsp;<span style="color: rgb(218, 146, 74);">// 创建Redis 数据库</span></p>
<p>&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">for</span> (<span style="color: rgb(184, 191, 198);">j</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(100, 171, 143);">0</span>; <span style="color: rgb(184, 191, 198);">j</span> <span style="color: rgb(184, 191, 198);">&lt;</span> <span style="color: rgb(184, 191, 198);">server</span>.<span style="color: rgb(184, 191, 198);">dbnum</span>; <span style="color: rgb(184, 191, 198);">j++</span>) {</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">server</span>.<span style="color: rgb(184, 191, 198);">db</span>[<span style="color: rgb(184, 191, 198);">j</span>].<span style="color: rgb(184, 191, 198);">dict</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">dictCreate</span>(<span style="color: rgb(184, 191, 198);">&amp;dbDictType</span>,<span style="color: rgb(184, 191, 198);">NULL</span>);</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">server</span>.<span style="color: rgb(184, 191, 198);">db</span>[<span style="color: rgb(184, 191, 198);">j</span>].<span style="color: rgb(184, 191, 198);">expires</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">dictCreate</span>(<span style="color: rgb(184, 191, 198);">&amp;keyptrDictType</span>,<span style="color: rgb(184, 191, 198);">NULL</span>);</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">server</span>.<span style="color: rgb(184, 191, 198);">db</span>[<span style="color: rgb(184, 191, 198);">j</span>].<span style="color: rgb(184, 191, 198);">blocking_keys</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">dictCreate</span>(<span style="color: rgb(184, 191, 198);">&amp;keylistDictType</span>,<span style="color: rgb(184, 191, 198);">NULL</span>);</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">server</span>.<span style="color: rgb(184, 191, 198);">db</span>[<span style="color: rgb(184, 191, 198);">j</span>].<span style="color: rgb(184, 191, 198);">ready_keys</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">dictCreate</span>(<span style="color: rgb(184, 191, 198);">&amp;setDictType</span>,<span style="color: rgb(184, 191, 198);">NULL</span>);</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">server</span>.<span style="color: rgb(184, 191, 198);">db</span>[<span style="color: rgb(184, 191, 198);">j</span>].<span style="color: rgb(184, 191, 198);">watched_keys</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">dictCreate</span>(<span style="color: rgb(184, 191, 198);">&amp;keylistDictType</span>,<span style="color: rgb(184, 191, 198);">NULL</span>);</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">server</span>.<span style="color: rgb(184, 191, 198);">db</span>[<span style="color: rgb(184, 191, 198);">j</span>].<span style="color: rgb(184, 191, 198);">id</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">j</span>;</p>
<p>&nbsp;}</p>
<p>&nbsp;&nbsp;<span style="color: rgb(218, 146, 74);">// 初始化其他参数</span></p>
<p>&nbsp;...</p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">aeCreateTimeEvent</span>(<span style="color: rgb(184, 191, 198);">server</span>.<span style="color: rgb(184, 191, 198);">el</span>, <span style="color: rgb(100, 171, 143);">1</span>, <span style="color: rgb(184, 191, 198);">serverCron</span>, <span style="color: rgb(184, 191, 198);">NULL</span>, <span style="color: rgb(184, 191, 198);">NULL</span>); <span style="color: rgb(218, 146, 74);">// 创建时间事件函数 ：serverCron</span></p>
<p>&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">if</span> (<span style="color: rgb(184, 191, 198);">server</span>.<span style="color: rgb(184, 191, 198);">ipfd</span> <span style="color: rgb(184, 191, 198);">&gt;</span> <span style="color: rgb(100, 171, 143);">0</span> <span style="color: rgb(184, 191, 198);">&amp;&amp;</span> <span style="color: rgb(184, 191, 198);">aeCreateFileEvent</span>(<span style="color: rgb(184, 191, 198);">server</span>.<span style="color: rgb(184, 191, 198);">el</span>,<span style="color: rgb(184, 191, 198);">server</span>.<span style="color: rgb(184, 191, 198);">ipfd</span>,<span style="color: rgb(184, 191, 198);">AE_READABLE</span>,</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">acceptTcpHandler</span>,<span style="color: rgb(184, 191, 198);">NULL</span>) <span style="color: rgb(184, 191, 198);">==</span> <span style="color: rgb(184, 191, 198);">AE_ERR</span>) <span style="color: rgb(184, 191, 198);">redisPanic</span>(<span style="color: rgb(210, 107, 107);">"Unrecoverable error creating server.ipfd file event."</span>); <span style="color: rgb(218, 146, 74);">// 创建处理TCP客户端连接事件处理函数：acceptTcpHandler</span></p>
<p>&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">if</span> (<span style="color: rgb(184, 191, 198);">server</span>.<span style="color: rgb(184, 191, 198);">sofd</span> <span style="color: rgb(184, 191, 198);">&gt;</span> <span style="color: rgb(100, 171, 143);">0</span> <span style="color: rgb(184, 191, 198);">&amp;&amp;</span> <span style="color: rgb(184, 191, 198);">aeCreateFileEvent</span>(<span style="color: rgb(184, 191, 198);">server</span>.<span style="color: rgb(184, 191, 198);">el</span>,<span style="color: rgb(184, 191, 198);">server</span>.<span style="color: rgb(184, 191, 198);">sofd</span>,<span style="color: rgb(184, 191, 198);">AE_READABLE</span>,</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">acceptUnixHandler</span>,<span style="color: rgb(184, 191, 198);">NULL</span>) <span style="color: rgb(184, 191, 198);">==</span> <span style="color: rgb(184, 191, 198);">AE_ERR</span>) <span style="color: rgb(184, 191, 198);">redisPanic</span>(<span style="color: rgb(210, 107, 107);">"Unrecoverable error creating server.sofd file event."</span>); <span style="color: rgb(218, 146, 74);">// 创建处理unix客户端连接处理函数：acceptUnixHandler</span></p>
<p>&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">if</span> (<span style="color: rgb(184, 191, 198);">server</span>.<span style="color: rgb(184, 191, 198);">aof_state</span> <span style="color: rgb(184, 191, 198);">==</span> <span style="color: rgb(184, 191, 198);">REDIS_AOF_ON</span>) { <span style="color: rgb(218, 146, 74);">// 打开AOF持久化文件</span></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">server</span>.<span style="color: rgb(184, 191, 198);">aof_fd</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">open</span>(<span style="color: rgb(184, 191, 198);">server</span>.<span style="color: rgb(184, 191, 198);">aof_filename</span>,</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">O_WRONLY|O_APPEND|O_CREAT</span>,<span style="color: rgb(100, 171, 143);">0644</span>);</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">if</span> (<span style="color: rgb(184, 191, 198);">server</span>.<span style="color: rgb(184, 191, 198);">aof_fd</span> <span style="color: rgb(184, 191, 198);">==</span> <span style="color: rgb(184, 191, 198);">-</span><span style="color: rgb(100, 171, 143);">1</span>) {</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">redisLog</span>(<span style="color: rgb(184, 191, 198);">REDIS_WARNING</span>, <span style="color: rgb(210, 107, 107);">"Can't open the append-only file: %s"</span>,</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">strerror</span>(<span style="color: rgb(184, 191, 198);">errno</span>));</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">exit</span>(<span style="color: rgb(100, 171, 143);">1</span>);</p>
<p>&nbsp;&nbsp;&nbsp;}</p>
<p>&nbsp;}</p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">scriptingInit</span>(); <span style="color: rgb(218, 146, 74);">// 初始化LUA 脚本执行环境</span></p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">slowlogInit</span>(); <span style="color: rgb(218, 146, 74);">// 初始化慢查询日志模块</span></p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">bioInit</span>(); <span style="color: rgb(218, 146, 74);">// 创建后台执行线程</span></p>
<p>}</p>
<p><strong>setupSignalHandlers 函数</strong></p>
<p>该函数主要用于设置进程信号处理函数。响应描述如下。该函数不重要，如果读者没有OS信号处理机制，较难理解它干了什么，这里只需要知道信号对应处理函数即可，等后面了解了进程如何处理信号时，将手到擒来。源码如下。</p>
<p><span style="color: rgb(200, 143, 208);">static</span> <span style="color: rgb(28, 198, 133);">void</span> <span style="color: rgb(141, 141, 240);">sigtermHandler</span>(<span style="color: rgb(28, 198, 133);">int</span> <span style="color: rgb(184, 191, 198);">sig</span>) { <span style="color: rgb(218, 146, 74);">// 接收到终止信号时调用，打印日志</span></p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">REDIS_NOTUSED</span>(<span style="color: rgb(184, 191, 198);">sig</span>);</p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">redisLogFromHandler</span>(<span style="color: rgb(184, 191, 198);">REDIS_WARNING</span>,<span style="color: rgb(210, 107, 107);">"Received SIGTERM, scheduling shutdown..."</span>);</p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">server</span>.<span style="color: rgb(184, 191, 198);">shutdown_asap</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(100, 171, 143);">1</span>;</p>
<p>}</p>
<p>​</p>
<p><span style="color: rgb(28, 198, 133);">void</span> <span style="color: rgb(141, 141, 240);">setupSignalHandlers</span>(<span style="color: rgb(28, 198, 133);">void</span>) {</p>
<p>&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">struct</span> <span style="color: rgb(141, 141, 240);">sigaction</span> <span style="color: rgb(141, 141, 240);">act</span>;</p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">sigemptyset</span>(<span style="color: rgb(184, 191, 198);">&amp;act</span>.<span style="color: rgb(184, 191, 198);">sa_mask</span>);</p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">act</span>.<span style="color: rgb(184, 191, 198);">sa_flags</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(100, 171, 143);">0</span>;</p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">act</span>.<span style="color: rgb(184, 191, 198);">sa_handler</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">sigtermHandler</span>;</p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">sigaction</span>(<span style="color: rgb(184, 191, 198);">SIGTERM</span>, <span style="color: rgb(184, 191, 198);">&amp;act</span>, <span style="color: rgb(184, 191, 198);">NULL</span>); <span style="color: rgb(218, 146, 74);">// 设置SIGTERM信号处理函数（接收终止信号时发出该信号）</span></p>
<p>&nbsp;&nbsp;<span style="color: rgb(183, 179, 179);">#ifdef HAVE_BACKTRACE&nbsp;</span><span style="color: rgb(218, 146, 74);">// 使用backtrace函数时设置处理函数为：sigsegvHandler</span></p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">sigemptyset</span>(<span style="color: rgb(184, 191, 198);">&amp;act</span>.<span style="color: rgb(184, 191, 198);">sa_mask</span>);</p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">act</span>.<span style="color: rgb(184, 191, 198);">sa_flags</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">SA_NODEFER</span> <span style="color: rgb(184, 191, 198);">|</span> <span style="color: rgb(184, 191, 198);">SA_RESETHAND</span> <span style="color: rgb(184, 191, 198);">|</span> <span style="color: rgb(184, 191, 198);">SA_SIGINFO</span>;</p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">act</span>.<span style="color: rgb(184, 191, 198);">sa_sigaction</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">sigsegvHandler</span>;</p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">sigaction</span>(<span style="color: rgb(184, 191, 198);">SIGSEGV</span>, <span style="color: rgb(184, 191, 198);">&amp;act</span>, <span style="color: rgb(184, 191, 198);">NULL</span>);</p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">sigaction</span>(<span style="color: rgb(184, 191, 198);">SIGBUS</span>, <span style="color: rgb(184, 191, 198);">&amp;act</span>, <span style="color: rgb(184, 191, 198);">NULL</span>);</p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">sigaction</span>(<span style="color: rgb(184, 191, 198);">SIGFPE</span>, <span style="color: rgb(184, 191, 198);">&amp;act</span>, <span style="color: rgb(184, 191, 198);">NULL</span>);</p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">sigaction</span>(<span style="color: rgb(184, 191, 198);">SIGILL</span>, <span style="color: rgb(184, 191, 198);">&amp;act</span>, <span style="color: rgb(184, 191, 198);">NULL</span>);</p>
<p>&nbsp;&nbsp;<span style="color: rgb(183, 179, 179);">#endif</span></p>
<p>&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">return</span>;</p>
<p>}</p>
<p><strong>createSharedObjects 函数</strong></p>
<p>该函数较为简单，就是常量池的设计，将公用的、不变的数据初始化，后面用到时不需要分配和释放。这些公用的对象较多为字符串对象，对于Redis的对象表示和字符串表示这里先暂时不需要管，我们主要看主流程，对于对象的表示将放到下一篇描述。源码如下。</p>
<p><span style="color: rgb(28, 198, 133);">void</span> <span style="color: rgb(141, 141, 240);">createSharedObjects</span>(<span style="color: rgb(28, 198, 133);">void</span>) {</p>
<p>&nbsp;&nbsp;<span style="color: rgb(28, 198, 133);">int</span> <span style="color: rgb(184, 191, 198);">j</span>;</p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">shared</span>.<span style="color: rgb(184, 191, 198);">crlf</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">createObject</span>(<span style="color: rgb(184, 191, 198);">REDIS_STRING</span>,<span style="color: rgb(184, 191, 198);">sdsnew</span>(<span style="color: rgb(210, 107, 107);">"\r\n"</span>));</p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">shared</span>.<span style="color: rgb(184, 191, 198);">ok</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">createObject</span>(<span style="color: rgb(184, 191, 198);">REDIS_STRING</span>,<span style="color: rgb(184, 191, 198);">sdsnew</span>(<span style="color: rgb(210, 107, 107);">"+OK\r\n"</span>));</p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">shared</span>.<span style="color: rgb(184, 191, 198);">err</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">createObject</span>(<span style="color: rgb(184, 191, 198);">REDIS_STRING</span>,<span style="color: rgb(184, 191, 198);">sdsnew</span>(<span style="color: rgb(210, 107, 107);">"-ERR\r\n"</span>));</p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">shared</span>.<span style="color: rgb(184, 191, 198);">emptybulk</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">createObject</span>(<span style="color: rgb(184, 191, 198);">REDIS_STRING</span>,<span style="color: rgb(184, 191, 198);">sdsnew</span>(<span style="color: rgb(210, 107, 107);">"$0\r\n\r\n"</span>));</p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">shared</span>.<span style="color: rgb(184, 191, 198);">czero</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">createObject</span>(<span style="color: rgb(184, 191, 198);">REDIS_STRING</span>,<span style="color: rgb(184, 191, 198);">sdsnew</span>(<span style="color: rgb(210, 107, 107);">":0\r\n"</span>));</p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">shared</span>.<span style="color: rgb(184, 191, 198);">cone</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">createObject</span>(<span style="color: rgb(184, 191, 198);">REDIS_STRING</span>,<span style="color: rgb(184, 191, 198);">sdsnew</span>(<span style="color: rgb(210, 107, 107);">":1\r\n"</span>));</p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">shared</span>.<span style="color: rgb(184, 191, 198);">cnegone</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">createObject</span>(<span style="color: rgb(184, 191, 198);">REDIS_STRING</span>,<span style="color: rgb(184, 191, 198);">sdsnew</span>(<span style="color: rgb(210, 107, 107);">":-1\r\n"</span>));</p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">shared</span>.<span style="color: rgb(184, 191, 198);">nullbulk</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">createObject</span>(<span style="color: rgb(184, 191, 198);">REDIS_STRING</span>,<span style="color: rgb(184, 191, 198);">sdsnew</span>(<span style="color: rgb(210, 107, 107);">"$-1\r\n"</span>));</p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">shared</span>.<span style="color: rgb(184, 191, 198);">nullmultibulk</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">createObject</span>(<span style="color: rgb(184, 191, 198);">REDIS_STRING</span>,<span style="color: rgb(184, 191, 198);">sdsnew</span>(<span style="color: rgb(210, 107, 107);">"*-1\r\n"</span>));</p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">shared</span>.<span style="color: rgb(184, 191, 198);">emptymultibulk</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">createObject</span>(<span style="color: rgb(184, 191, 198);">REDIS_STRING</span>,<span style="color: rgb(184, 191, 198);">sdsnew</span>(<span style="color: rgb(210, 107, 107);">"*0\r\n"</span>));</p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">shared</span>.<span style="color: rgb(184, 191, 198);">pong</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">createObject</span>(<span style="color: rgb(184, 191, 198);">REDIS_STRING</span>,<span style="color: rgb(184, 191, 198);">sdsnew</span>(<span style="color: rgb(210, 107, 107);">"+PONG\r\n"</span>));</p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">shared</span>.<span style="color: rgb(184, 191, 198);">queued</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">createObject</span>(<span style="color: rgb(184, 191, 198);">REDIS_STRING</span>,<span style="color: rgb(184, 191, 198);">sdsnew</span>(<span style="color: rgb(210, 107, 107);">"+QUEUED\r\n"</span>));</p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">shared</span>.<span style="color: rgb(184, 191, 198);">wrongtypeerr</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">createObject</span>(<span style="color: rgb(184, 191, 198);">REDIS_STRING</span>,<span style="color: rgb(184, 191, 198);">sdsnew</span>(</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(210, 107, 107);">"-ERR Operation against a key holding the wrong kind of value\r\n"</span>));</p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">shared</span>.<span style="color: rgb(184, 191, 198);">nokeyerr</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">createObject</span>(<span style="color: rgb(184, 191, 198);">REDIS_STRING</span>,<span style="color: rgb(184, 191, 198);">sdsnew</span>(</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(210, 107, 107);">"-ERR no such key\r\n"</span>));</p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">shared</span>.<span style="color: rgb(184, 191, 198);">syntaxerr</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">createObject</span>(<span style="color: rgb(184, 191, 198);">REDIS_STRING</span>,<span style="color: rgb(184, 191, 198);">sdsnew</span>(</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(210, 107, 107);">"-ERR syntax error\r\n"</span>));</p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">shared</span>.<span style="color: rgb(184, 191, 198);">sameobjecterr</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">createObject</span>(<span style="color: rgb(184, 191, 198);">REDIS_STRING</span>,<span style="color: rgb(184, 191, 198);">sdsnew</span>(</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(210, 107, 107);">"-ERR source and destination objects are the same\r\n"</span>));</p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">shared</span>.<span style="color: rgb(184, 191, 198);">outofrangeerr</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">createObject</span>(<span style="color: rgb(184, 191, 198);">REDIS_STRING</span>,<span style="color: rgb(184, 191, 198);">sdsnew</span>(</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(210, 107, 107);">"-ERR index out of range\r\n"</span>));</p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">shared</span>.<span style="color: rgb(184, 191, 198);">noscripterr</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">createObject</span>(<span style="color: rgb(184, 191, 198);">REDIS_STRING</span>,<span style="color: rgb(184, 191, 198);">sdsnew</span>(</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(210, 107, 107);">"-NOSCRIPT No matching script. Please use EVAL.\r\n"</span>));</p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">shared</span>.<span style="color: rgb(184, 191, 198);">loadingerr</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">createObject</span>(<span style="color: rgb(184, 191, 198);">REDIS_STRING</span>,<span style="color: rgb(184, 191, 198);">sdsnew</span>(</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(210, 107, 107);">"-LOADING Redis is loading the dataset in memory\r\n"</span>));</p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">shared</span>.<span style="color: rgb(184, 191, 198);">slowscripterr</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">createObject</span>(<span style="color: rgb(184, 191, 198);">REDIS_STRING</span>,<span style="color: rgb(184, 191, 198);">sdsnew</span>(</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(210, 107, 107);">"-BUSY Redis is busy running a script. You can only call SCRIPT KILL or SHUTDOWN NOSAVE.\r\n"</span>));</p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">shared</span>.<span style="color: rgb(184, 191, 198);">masterdownerr</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">createObject</span>(<span style="color: rgb(184, 191, 198);">REDIS_STRING</span>,<span style="color: rgb(184, 191, 198);">sdsnew</span>(</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(210, 107, 107);">"-MASTERDOWN Link with MASTER is down and slave-serve-stale-data is set to 'no'.\r\n"</span>));</p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">shared</span>.<span style="color: rgb(184, 191, 198);">bgsaveerr</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">createObject</span>(<span style="color: rgb(184, 191, 198);">REDIS_STRING</span>,<span style="color: rgb(184, 191, 198);">sdsnew</span>(</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(210, 107, 107);">"-MISCONF Redis is configured to save RDB snapshots, but is currently not able to persist on disk. Commands that may modify the data set are disabled. Please check Redis logs for details about the error.\r\n"</span>));</p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">shared</span>.<span style="color: rgb(184, 191, 198);">roslaveerr</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">createObject</span>(<span style="color: rgb(184, 191, 198);">REDIS_STRING</span>,<span style="color: rgb(184, 191, 198);">sdsnew</span>(</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(210, 107, 107);">"-READONLY You can't write against a read only slave.\r\n"</span>));</p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">shared</span>.<span style="color: rgb(184, 191, 198);">oomerr</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">createObject</span>(<span style="color: rgb(184, 191, 198);">REDIS_STRING</span>,<span style="color: rgb(184, 191, 198);">sdsnew</span>(</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(210, 107, 107);">"-OOM command not allowed when used memory &gt; 'maxmemory'.\r\n"</span>));</p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">shared</span>.<span style="color: rgb(184, 191, 198);">space</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">createObject</span>(<span style="color: rgb(184, 191, 198);">REDIS_STRING</span>,<span style="color: rgb(184, 191, 198);">sdsnew</span>(<span style="color: rgb(210, 107, 107);">" "</span>));</p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">shared</span>.<span style="color: rgb(184, 191, 198);">colon</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">createObject</span>(<span style="color: rgb(184, 191, 198);">REDIS_STRING</span>,<span style="color: rgb(184, 191, 198);">sdsnew</span>(<span style="color: rgb(210, 107, 107);">":"</span>));</p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">shared</span>.<span style="color: rgb(184, 191, 198);">plus</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">createObject</span>(<span style="color: rgb(184, 191, 198);">REDIS_STRING</span>,<span style="color: rgb(184, 191, 198);">sdsnew</span>(<span style="color: rgb(210, 107, 107);">"+"</span>));</p>
<p>​</p>
<p>&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">for</span> (<span style="color: rgb(184, 191, 198);">j</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(100, 171, 143);">0</span>; <span style="color: rgb(184, 191, 198);">j</span> <span style="color: rgb(184, 191, 198);">&lt;</span> <span style="color: rgb(184, 191, 198);">REDIS_SHARED_SELECT_CMDS</span>; <span style="color: rgb(184, 191, 198);">j++</span>) {</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">shared</span>.<span style="color: rgb(184, 191, 198);">select</span>[<span style="color: rgb(184, 191, 198);">j</span>] <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">createObject</span>(<span style="color: rgb(184, 191, 198);">REDIS_STRING</span>,</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">sdscatprintf</span>(<span style="color: rgb(184, 191, 198);">sdsempty</span>(),<span style="color: rgb(210, 107, 107);">"select %d\r\n"</span>, <span style="color: rgb(184, 191, 198);">j</span>));</p>
<p>&nbsp;}</p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">shared</span>.<span style="color: rgb(184, 191, 198);">messagebulk</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">createStringObject</span>(<span style="color: rgb(210, 107, 107);">"$7\r\nmessage\r\n"</span>,<span style="color: rgb(100, 171, 143);">13</span>);</p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">shared</span>.<span style="color: rgb(184, 191, 198);">pmessagebulk</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">createStringObject</span>(<span style="color: rgb(210, 107, 107);">"$8\r\npmessage\r\n"</span>,<span style="color: rgb(100, 171, 143);">14</span>);</p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">shared</span>.<span style="color: rgb(184, 191, 198);">subscribebulk</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">createStringObject</span>(<span style="color: rgb(210, 107, 107);">"$9\r\nsubscribe\r\n"</span>,<span style="color: rgb(100, 171, 143);">15</span>);</p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">shared</span>.<span style="color: rgb(184, 191, 198);">unsubscribebulk</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">createStringObject</span>(<span style="color: rgb(210, 107, 107);">"$11\r\nunsubscribe\r\n"</span>,<span style="color: rgb(100, 171, 143);">18</span>);</p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">shared</span>.<span style="color: rgb(184, 191, 198);">psubscribebulk</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">createStringObject</span>(<span style="color: rgb(210, 107, 107);">"$10\r\npsubscribe\r\n"</span>,<span style="color: rgb(100, 171, 143);">17</span>);</p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">shared</span>.<span style="color: rgb(184, 191, 198);">punsubscribebulk</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">createStringObject</span>(<span style="color: rgb(210, 107, 107);">"$12\r\npunsubscribe\r\n"</span>,<span style="color: rgb(100, 171, 143);">19</span>);</p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">shared</span>.<span style="color: rgb(184, 191, 198);">del</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">createStringObject</span>(<span style="color: rgb(210, 107, 107);">"DEL"</span>,<span style="color: rgb(100, 171, 143);">3</span>);</p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">shared</span>.<span style="color: rgb(184, 191, 198);">rpop</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">createStringObject</span>(<span style="color: rgb(210, 107, 107);">"RPOP"</span>,<span style="color: rgb(100, 171, 143);">4</span>);</p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">shared</span>.<span style="color: rgb(184, 191, 198);">lpop</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">createStringObject</span>(<span style="color: rgb(210, 107, 107);">"LPOP"</span>,<span style="color: rgb(100, 171, 143);">4</span>);</p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">shared</span>.<span style="color: rgb(184, 191, 198);">lpush</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">createStringObject</span>(<span style="color: rgb(210, 107, 107);">"LPUSH"</span>,<span style="color: rgb(100, 171, 143);">5</span>);</p>
<p>&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">for</span> (<span style="color: rgb(184, 191, 198);">j</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(100, 171, 143);">0</span>; <span style="color: rgb(184, 191, 198);">j</span> <span style="color: rgb(184, 191, 198);">&lt;</span> <span style="color: rgb(184, 191, 198);">REDIS_SHARED_INTEGERS</span>; <span style="color: rgb(184, 191, 198);">j++</span>) {</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">shared</span>.<span style="color: rgb(184, 191, 198);">integers</span>[<span style="color: rgb(184, 191, 198);">j</span>] <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">createObject</span>(<span style="color: rgb(184, 191, 198);">REDIS_STRING</span>,(<span style="color: rgb(28, 198, 133);">void*</span>)(<span style="color: rgb(28, 198, 133);">long</span>)<span style="color: rgb(184, 191, 198);">j</span>);</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">shared</span>.<span style="color: rgb(184, 191, 198);">integers</span>[<span style="color: rgb(184, 191, 198);">j</span>]<span style="color: rgb(184, 191, 198);">-&gt;encoding</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">REDIS_ENCODING_INT</span>;</p>
<p>&nbsp;}</p>
<p>&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">for</span> (<span style="color: rgb(184, 191, 198);">j</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(100, 171, 143);">0</span>; <span style="color: rgb(184, 191, 198);">j</span> <span style="color: rgb(184, 191, 198);">&lt;</span> <span style="color: rgb(184, 191, 198);">REDIS_SHARED_BULKHDR_LEN</span>; <span style="color: rgb(184, 191, 198);">j++</span>) {</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">shared</span>.<span style="color: rgb(184, 191, 198);">mbulkhdr</span>[<span style="color: rgb(184, 191, 198);">j</span>] <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">createObject</span>(<span style="color: rgb(184, 191, 198);">REDIS_STRING</span>,</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">sdscatprintf</span>(<span style="color: rgb(184, 191, 198);">sdsempty</span>(),<span style="color: rgb(210, 107, 107);">"*%d\r\n"</span>,<span style="color: rgb(184, 191, 198);">j</span>));</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">shared</span>.<span style="color: rgb(184, 191, 198);">bulkhdr</span>[<span style="color: rgb(184, 191, 198);">j</span>] <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">createObject</span>(<span style="color: rgb(184, 191, 198);">REDIS_STRING</span>,</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">sdscatprintf</span>(<span style="color: rgb(184, 191, 198);">sdsempty</span>(),<span style="color: rgb(210, 107, 107);">"$%d\r\n"</span>,<span style="color: rgb(184, 191, 198);">j</span>));</p>
<p>&nbsp;}</p>
<p>}</p>
<p><strong>adjustOpenFilesLimit 函数</strong></p>
<p>我们知道Linux操作系统将会在rlimit中限制进程打开的文件数，该函数将尝试根据配置的最大客户端数来提高打开文件的最大数量。 它还将包含32个额外的文件描述符，因为Redis还需要一些文件描述符用于持久性、侦听套接字、日志文件等。 如果不能将限制相应地设置为配置的最大客户端数量，该函数将执行保留当前服务器的设置。源码如下。</p>
<p><span style="color: rgb(28, 198, 133);">void</span> <span style="color: rgb(141, 141, 240);">adjustOpenFilesLimit</span>(<span style="color: rgb(28, 198, 133);">void</span>) {</p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">rlim_t</span> <span style="color: rgb(184, 191, 198);">maxfiles</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">server</span>.<span style="color: rgb(184, 191, 198);">maxclients+</span><span style="color: rgb(100, 171, 143);">32</span>; <span style="color: rgb(218, 146, 74);">// 增加描述符数量</span></p>
<p>&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">struct</span> <span style="color: rgb(141, 141, 240);">rlimit</span> <span style="color: rgb(141, 141, 240);">limit</span>;</p>
<p>&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">if</span> (<span style="color: rgb(184, 191, 198);">getrlimit</span>(<span style="color: rgb(184, 191, 198);">RLIMIT_NOFILE</span>,<span style="color: rgb(184, 191, 198);">&amp;limit</span>) <span style="color: rgb(184, 191, 198);">==</span> <span style="color: rgb(184, 191, 198);">-</span><span style="color: rgb(100, 171, 143);">1</span>) { <span style="color: rgb(218, 146, 74);">// 获取当前系统的描述符信息</span></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">redisLog</span>(<span style="color: rgb(184, 191, 198);">REDIS_WARNING</span>,<span style="color: rgb(210, 107, 107);">"Unable to obtain the current NOFILE limit (%s), assuming 1024 and setting the max clients configuration accordingly."</span>,</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">strerror</span>(<span style="color: rgb(184, 191, 198);">errno</span>));</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">server</span>.<span style="color: rgb(184, 191, 198);">maxclients</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(100, 171, 143);">1024</span><span style="color: rgb(184, 191, 198);">-</span><span style="color: rgb(100, 171, 143);">32</span>;</p>
<p>&nbsp;} <span style="color: rgb(200, 143, 208);">else</span> { <span style="color: rgb(218, 146, 74);">// 尝试修改当前进程的FD配置</span></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">rlim_t</span> <span style="color: rgb(184, 191, 198);">oldlimit</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">limit</span>.<span style="color: rgb(184, 191, 198);">rlim_cur</span>;</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">if</span> (<span style="color: rgb(184, 191, 198);">oldlimit</span> <span style="color: rgb(184, 191, 198);">&lt;</span> <span style="color: rgb(184, 191, 198);">maxfiles</span>) {</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">rlim_t</span> <span style="color: rgb(184, 191, 198);">f</span>;</p>
<p>​</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">f</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">maxfiles</span>;</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">while</span>(<span style="color: rgb(184, 191, 198);">f</span> <span style="color: rgb(184, 191, 198);">&gt;</span> <span style="color: rgb(184, 191, 198);">oldlimit</span>) {</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">limit</span>.<span style="color: rgb(184, 191, 198);">rlim_cur</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">f</span>;</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">limit</span>.<span style="color: rgb(184, 191, 198);">rlim_max</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">f</span>;</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">if</span> (<span style="color: rgb(184, 191, 198);">setrlimit</span>(<span style="color: rgb(184, 191, 198);">RLIMIT_NOFILE</span>,<span style="color: rgb(184, 191, 198);">&amp;limit</span>) <span style="color: rgb(184, 191, 198);">!=</span> <span style="color: rgb(184, 191, 198);">-</span><span style="color: rgb(100, 171, 143);">1</span>) <span style="color: rgb(200, 143, 208);">break</span>;</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">f</span> <span style="color: rgb(184, 191, 198);">-=</span> <span style="color: rgb(100, 171, 143);">128</span>;</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">if</span> (<span style="color: rgb(184, 191, 198);">f</span> <span style="color: rgb(184, 191, 198);">&lt;</span> <span style="color: rgb(184, 191, 198);">oldlimit</span>) <span style="color: rgb(184, 191, 198);">f</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">oldlimit</span>;</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">if</span> (<span style="color: rgb(184, 191, 198);">f</span> <span style="color: rgb(184, 191, 198);">!=</span> <span style="color: rgb(184, 191, 198);">maxfiles</span>) {</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">server</span>.<span style="color: rgb(184, 191, 198);">maxclients</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">f-</span><span style="color: rgb(100, 171, 143);">32</span>;</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">redisLog</span>(<span style="color: rgb(184, 191, 198);">REDIS_WARNING</span>,<span style="color: rgb(210, 107, 107);">"Unable to set the max number of files limit to %d (%s), setting the max clients configuration to %d."</span>,</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span style="color: rgb(28, 198, 133);">int</span>) <span style="color: rgb(184, 191, 198);">maxfiles</span>, <span style="color: rgb(184, 191, 198);">strerror</span>(<span style="color: rgb(184, 191, 198);">errno</span>), (<span style="color: rgb(28, 198, 133);">int</span>) <span style="color: rgb(184, 191, 198);">server</span>.<span style="color: rgb(184, 191, 198);">maxclients</span>);</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} <span style="color: rgb(200, 143, 208);">else</span> {</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">redisLog</span>(<span style="color: rgb(184, 191, 198);">REDIS_NOTICE</span>,<span style="color: rgb(210, 107, 107);">"Max number of open files set to %d"</span>,</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span style="color: rgb(28, 198, 133);">int</span>) <span style="color: rgb(184, 191, 198);">maxfiles</span>);</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</p>
<p>&nbsp;&nbsp;&nbsp;}</p>
<p>&nbsp;}</p>
<p>}</p>
<p><strong>slowlogInit 函数</strong></p>
<p>该函数用于初始化慢查询日志，可以看到这里将使用list列表来完成日志的存储。同样，对于列表对象的组织，我们在下一篇进行讲解。</p>
<p><span style="color: rgb(28, 198, 133);">void</span> <span style="color: rgb(141, 141, 240);">slowlogInit</span>(<span style="color: rgb(28, 198, 133);">void</span>) {</p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">server</span>.<span style="color: rgb(184, 191, 198);">slowlog</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">listCreate</span>();</p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">server</span>.<span style="color: rgb(184, 191, 198);">slowlog_entry_id</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(100, 171, 143);">0</span>;</p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">listSetFreeMethod</span>(<span style="color: rgb(184, 191, 198);">server</span>.<span style="color: rgb(184, 191, 198);">slowlog</span>,<span style="color: rgb(184, 191, 198);">slowlogFreeEntry</span>);</p>
<p>}</p>
<p><strong>bioInit 函数</strong></p>
<p>该函数用于创建后台任务执行线程，可以看到所谓Redis是单线程，指的仅仅是响应客户端的线程为单线程，并不代表Redis进程本身只有一个线程。该方法将利用pthread 线程库完成相应处理，读者了解pthread线程编程技术将更容易理解，不理解也没关系，跟着笔者的注释即可~。相关描述如下。</p>
<p><span style="color: rgb(28, 198, 133);">void</span> <span style="color: rgb(141, 141, 240);">bioInit</span>(<span style="color: rgb(28, 198, 133);">void</span>) {</p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">pthread_attr_t</span> <span style="color: rgb(184, 191, 198);">attr</span>;</p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">pthread_t</span> <span style="color: rgb(184, 191, 198);">thread</span>;</p>
<p>&nbsp;&nbsp;<span style="color: rgb(28, 198, 133);">size_t</span> <span style="color: rgb(184, 191, 198);">stacksize</span>;</p>
<p>&nbsp;&nbsp;<span style="color: rgb(28, 198, 133);">int</span> <span style="color: rgb(184, 191, 198);">j</span>;</p>
<p>​</p>
<p>&nbsp;&nbsp;<span style="color: rgb(218, 146, 74);">/* 初始化线程互斥锁和条件变量，也即：控制线程互斥的结构 */</span></p>
<p>&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">for</span> (<span style="color: rgb(184, 191, 198);">j</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(100, 171, 143);">0</span>; <span style="color: rgb(184, 191, 198);">j</span> <span style="color: rgb(184, 191, 198);">&lt;</span> <span style="color: rgb(184, 191, 198);">REDIS_BIO_NUM_OPS</span>; <span style="color: rgb(184, 191, 198);">j++</span>) {</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">pthread_mutex_init</span>(<span style="color: rgb(184, 191, 198);">&amp;bio_mutex</span>[<span style="color: rgb(184, 191, 198);">j</span>],<span style="color: rgb(184, 191, 198);">NULL</span>);</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">pthread_cond_init</span>(<span style="color: rgb(184, 191, 198);">&amp;bio_condvar</span>[<span style="color: rgb(184, 191, 198);">j</span>],<span style="color: rgb(184, 191, 198);">NULL</span>);</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">bio_jobs</span>[<span style="color: rgb(184, 191, 198);">j</span>] <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">listCreate</span>(); <span style="color: rgb(218, 146, 74);">// 初始化每个线程的任务队列列表</span></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">bio_pending</span>[<span style="color: rgb(184, 191, 198);">j</span>] <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(100, 171, 143);">0</span>;</p>
<p>&nbsp;}</p>
<p>​</p>
<p>&nbsp;&nbsp;<span style="color: rgb(218, 146, 74);">/* 初始化线程栈大小 */</span></p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">pthread_attr_init</span>(<span style="color: rgb(184, 191, 198);">&amp;attr</span>);</p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">pthread_attr_getstacksize</span>(<span style="color: rgb(184, 191, 198);">&amp;attr</span>,<span style="color: rgb(184, 191, 198);">&amp;stacksize</span>);</p>
<p>&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">if</span> (<span style="color: rgb(184, 191, 198);">!stacksize</span>) <span style="color: rgb(184, 191, 198);">stacksize</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(100, 171, 143);">1</span>;</p>
<p>&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">while</span> (<span style="color: rgb(184, 191, 198);">stacksize</span> <span style="color: rgb(184, 191, 198);">&lt;</span> <span style="color: rgb(184, 191, 198);">REDIS_THREAD_STACK_SIZE</span>) <span style="color: rgb(184, 191, 198);">stacksize</span> <span style="color: rgb(184, 191, 198);">*=</span> <span style="color: rgb(100, 171, 143);">2</span>;</p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">pthread_attr_setstacksize</span>(<span style="color: rgb(184, 191, 198);">&amp;attr</span>, <span style="color: rgb(184, 191, 198);">stacksize</span>);</p>
<p>​</p>
<p>&nbsp;&nbsp;<span style="color: rgb(218, 146, 74);">/* 创建线程，参数为：当前线程的序号，函数执行函数为 bioProcessBackgroundJobs */</span></p>
<p>&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">for</span> (<span style="color: rgb(184, 191, 198);">j</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(100, 171, 143);">0</span>; <span style="color: rgb(184, 191, 198);">j</span> <span style="color: rgb(184, 191, 198);">&lt;</span> <span style="color: rgb(184, 191, 198);">REDIS_BIO_NUM_OPS</span>; <span style="color: rgb(184, 191, 198);">j++</span>) {</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(28, 198, 133);">void</span> <span style="color: rgb(28, 198, 133);">*</span><span style="color: rgb(184, 191, 198);">arg</span> <span style="color: rgb(184, 191, 198);">=</span> (<span style="color: rgb(28, 198, 133);">void*</span>)(<span style="color: rgb(28, 198, 133);">unsigned</span> <span style="color: rgb(28, 198, 133);">long</span>) <span style="color: rgb(184, 191, 198);">j</span>;</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">if</span> (<span style="color: rgb(184, 191, 198);">pthread_create</span>(<span style="color: rgb(184, 191, 198);">&amp;thread</span>,<span style="color: rgb(184, 191, 198);">&amp;attr</span>,<span style="color: rgb(184, 191, 198);">bioProcessBackgroundJobs</span>,<span style="color: rgb(184, 191, 198);">arg</span>) <span style="color: rgb(184, 191, 198);">!=</span> <span style="color: rgb(100, 171, 143);">0</span>) {</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">redisLog</span>(<span style="color: rgb(184, 191, 198);">REDIS_WARNING</span>,<span style="color: rgb(210, 107, 107);">"Fatal: Can't initialize Background Jobs."</span>);</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">exit</span>(<span style="color: rgb(100, 171, 143);">1</span>);</p>
<p>&nbsp;&nbsp;&nbsp;}</p>
<p>&nbsp;}</p>
<p>}</p>
<p>​</p>
<p><span style="color: rgb(218, 146, 74);">// 每个线程执行的函数</span></p>
<p><span style="color: rgb(28, 198, 133);">void</span> <span style="color: rgb(28, 198, 133);">*</span><span style="color: rgb(141, 141, 240);">bioProcessBackgroundJobs</span>(<span style="color: rgb(28, 198, 133);">void</span> <span style="color: rgb(28, 198, 133);">*</span><span style="color: rgb(184, 191, 198);">arg</span>) {</p>
<p>&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">struct</span> <span style="color: rgb(141, 141, 240);">bio_job</span> <span style="color: rgb(184, 191, 198);">*job</span>;</p>
<p>&nbsp;&nbsp;<span style="color: rgb(28, 198, 133);">unsigned</span> <span style="color: rgb(28, 198, 133);">long</span> <span style="color: rgb(184, 191, 198);">type</span> <span style="color: rgb(184, 191, 198);">=</span> (<span style="color: rgb(28, 198, 133);">unsigned</span> <span style="color: rgb(28, 198, 133);">long</span>) <span style="color: rgb(184, 191, 198);">arg</span>; <span style="color: rgb(218, 146, 74);">// 该值为线程序号，上面看到过，可用于获取当前线程的互斥锁信息</span></p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">sigset_t</span> <span style="color: rgb(184, 191, 198);">sigset</span>;</p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">pthread_detach</span>(<span style="color: rgb(184, 191, 198);">pthread_self</span>());</p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">pthread_mutex_lock</span>(<span style="color: rgb(184, 191, 198);">&amp;bio_mutex</span>[<span style="color: rgb(184, 191, 198);">type</span>]); <span style="color: rgb(218, 146, 74);">// 获取当前线程自己的互斥锁</span></p>
<p>&nbsp;&nbsp;<span style="color: rgb(218, 146, 74);">// 设置线程处理信号</span></p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">sigemptyset</span>(<span style="color: rgb(184, 191, 198);">&amp;sigset</span>);</p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">sigaddset</span>(<span style="color: rgb(184, 191, 198);">&amp;sigset</span>, <span style="color: rgb(184, 191, 198);">SIGALRM</span>);</p>
<p>&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">if</span> (<span style="color: rgb(184, 191, 198);">pthread_sigmask</span>(<span style="color: rgb(184, 191, 198);">SIG_BLOCK</span>, <span style="color: rgb(184, 191, 198);">&amp;sigset</span>, <span style="color: rgb(184, 191, 198);">NULL</span>))</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">redisLog</span>(<span style="color: rgb(184, 191, 198);">REDIS_WARNING</span>,</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(210, 107, 107);">"Warning: can't mask SIGALRM in bio.c thread: %s"</span>, <span style="color: rgb(184, 191, 198);">strerror</span>(<span style="color: rgb(184, 191, 198);">errno</span>));</p>
<p>&nbsp;&nbsp;<span style="color: rgb(218, 146, 74);">// 循环处理任务列表中放入的任务</span></p>
<p>&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">while</span>(<span style="color: rgb(100, 171, 143);">1</span>) {</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">listNode</span> <span style="color: rgb(184, 191, 198);">*ln</span>;</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">if</span> (<span style="color: rgb(184, 191, 198);">listLength</span>(<span style="color: rgb(184, 191, 198);">bio_jobs</span>[<span style="color: rgb(184, 191, 198);">type</span>]) <span style="color: rgb(184, 191, 198);">==</span> <span style="color: rgb(100, 171, 143);">0</span>) {</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">pthread_cond_wait</span>(<span style="color: rgb(184, 191, 198);">&amp;bio_condvar</span>[<span style="color: rgb(184, 191, 198);">type</span>],<span style="color: rgb(184, 191, 198);">&amp;bio_mutex</span>[<span style="color: rgb(184, 191, 198);">type</span>]);</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">continue</span>;</p>
<p>&nbsp;&nbsp;&nbsp;}</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">ln</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">listFirst</span>(<span style="color: rgb(184, 191, 198);">bio_jobs</span>[<span style="color: rgb(184, 191, 198);">type</span>]);</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">job</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">ln-&gt;value</span>;</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">pthread_mutex_unlock</span>(<span style="color: rgb(184, 191, 198);">&amp;bio_mutex</span>[<span style="color: rgb(184, 191, 198);">type</span>]);</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">if</span> (<span style="color: rgb(184, 191, 198);">type</span> <span style="color: rgb(184, 191, 198);">==</span> <span style="color: rgb(184, 191, 198);">REDIS_BIO_CLOSE_FILE</span>) { <span style="color: rgb(218, 146, 74);">// 当前线程类型为执行BIO关闭文件操作</span></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">close</span>((<span style="color: rgb(28, 198, 133);">long</span>)<span style="color: rgb(184, 191, 198);">job-&gt;arg1</span>);</p>
<p>&nbsp;&nbsp;&nbsp;} <span style="color: rgb(200, 143, 208);">else</span> <span style="color: rgb(200, 143, 208);">if</span> (<span style="color: rgb(184, 191, 198);">type</span> <span style="color: rgb(184, 191, 198);">==</span> <span style="color: rgb(184, 191, 198);">REDIS_BIO_AOF_FSYNC</span>) {<span style="color: rgb(218, 146, 74);">// 当前线程类型为执行AOF操作</span></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">aof_fsync</span>((<span style="color: rgb(28, 198, 133);">long</span>)<span style="color: rgb(184, 191, 198);">job-&gt;arg1</span>);</p>
<p>&nbsp;&nbsp;&nbsp;} <span style="color: rgb(200, 143, 208);">else</span> {</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">redisPanic</span>(<span style="color: rgb(210, 107, 107);">"Wrong job type in bioProcessBackgroundJobs()."</span>);</p>
<p>&nbsp;&nbsp;&nbsp;}</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">zfree</span>(<span style="color: rgb(184, 191, 198);">job</span>);</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">pthread_mutex_lock</span>(<span style="color: rgb(184, 191, 198);">&amp;bio_mutex</span>[<span style="color: rgb(184, 191, 198);">type</span>]);</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">listDelNode</span>(<span style="color: rgb(184, 191, 198);">bio_jobs</span>[<span style="color: rgb(184, 191, 198);">type</span>],<span style="color: rgb(184, 191, 198);">ln</span>);</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">bio_pending</span>[<span style="color: rgb(184, 191, 198);">type</span>]<span style="color: rgb(184, 191, 198);">--</span>;</p>
<p>&nbsp;}</p>
<p>}</p>
<p><strong>aeSetBeforeSleepProc 函数</strong></p>
<p>该函数较为简单，仅仅保留一个函数指针而已。在事件循环线程执行sleep操作之前回调。这里的回调实现较为简单，仅仅处理未处理的命令并写入AOF数据，因为每次执行后，如果配置了AOF，那么需要持久化到磁盘。</p>
<p><span style="color: rgb(28, 198, 133);">void</span> <span style="color: rgb(141, 141, 240);">aeSetBeforeSleepProc</span>(<span style="color: rgb(184, 191, 198);">aeEventLoop</span> <span style="color: rgb(184, 191, 198);">*eventLoop</span>, <span style="color: rgb(184, 191, 198);">aeBeforeSleepProc</span> <span style="color: rgb(184, 191, 198);">*beforesleep</span>) {</p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">eventLoop-&gt;beforesleep</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">beforesleep</span>;</p>
<p>}</p>
<p>​</p>
<p><span style="color: rgb(218, 146, 74);">// 回调函数实现</span></p>
<p><span style="color: rgb(28, 198, 133);">void</span> <span style="color: rgb(141, 141, 240);">beforeSleep</span>(<span style="color: rgb(200, 143, 208);">struct</span> <span style="color: rgb(141, 141, 240);">aeEventLoop</span> <span style="color: rgb(184, 191, 198);">*eventLoop</span>) {</p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">REDIS_NOTUSED</span>(<span style="color: rgb(184, 191, 198);">eventLoop</span>);</p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">listNode</span> <span style="color: rgb(184, 191, 198);">*ln</span>;</p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">redisClient</span> <span style="color: rgb(184, 191, 198);">*c</span>;</p>
<p>&nbsp;&nbsp;<span style="color: rgb(218, 146, 74);">/* 尝试为刚刚解除阻塞的客户端处理未执行的命令 */</span></p>
<p>&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">while</span> (<span style="color: rgb(184, 191, 198);">listLength</span>(<span style="color: rgb(184, 191, 198);">server</span>.<span style="color: rgb(184, 191, 198);">unblocked_clients</span>)) {</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">ln</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">listFirst</span>(<span style="color: rgb(184, 191, 198);">server</span>.<span style="color: rgb(184, 191, 198);">unblocked_clients</span>);</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">redisAssert</span>(<span style="color: rgb(184, 191, 198);">ln</span> <span style="color: rgb(184, 191, 198);">!=</span> <span style="color: rgb(184, 191, 198);">NULL</span>);</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">c</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">ln-&gt;value</span>;</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">listDelNode</span>(<span style="color: rgb(184, 191, 198);">server</span>.<span style="color: rgb(184, 191, 198);">unblocked_clients</span>,<span style="color: rgb(184, 191, 198);">ln</span>);</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">c-&gt;flags</span> <span style="color: rgb(184, 191, 198);">&amp;=</span> <span style="color: rgb(184, 191, 198);">~REDIS_UNBLOCKED</span>;</p>
<p>​</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(218, 146, 74);">/* 处理客户端输入缓冲区中的剩余数据 */</span></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">if</span> (<span style="color: rgb(184, 191, 198);">c-&gt;querybuf</span> <span style="color: rgb(184, 191, 198);">&amp;&amp;</span> <span style="color: rgb(184, 191, 198);">sdslen</span>(<span style="color: rgb(184, 191, 198);">c-&gt;querybuf</span>) <span style="color: rgb(184, 191, 198);">&gt;</span> <span style="color: rgb(100, 171, 143);">0</span>) {</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">server</span>.<span style="color: rgb(184, 191, 198);">current_client</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">c</span>;</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">processInputBuffer</span>(<span style="color: rgb(184, 191, 198);">c</span>);</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">server</span>.<span style="color: rgb(184, 191, 198);">current_client</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">NULL</span>;</p>
<p>&nbsp;&nbsp;&nbsp;}</p>
<p>&nbsp;}</p>
<p>&nbsp;&nbsp;<span style="color: rgb(218, 146, 74);">/* 将AOF缓冲区的数据写入磁盘 */</span></p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">flushAppendOnlyFile</span>(<span style="color: rgb(100, 171, 143);">0</span>);</p>
<p>}</p>
<p><strong>aeMain 函数</strong></p>
<p>该函数将有主线程完成调用，接收事件循环的事件完成相应处理。我们看到aeProcessEvents(eventLoop, AE_ALL_EVENTS)为主执行入口，那么我们下一篇将从该点开始，看看Redis的事件循环原理和具体处理的细节。</p>
<p><span style="color: rgb(28, 198, 133);">void</span> <span style="color: rgb(141, 141, 240);">aeMain</span>(<span style="color: rgb(184, 191, 198);">aeEventLoop</span> <span style="color: rgb(184, 191, 198);">*eventLoop</span>) {</p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">eventLoop-&gt;stop</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(100, 171, 143);">0</span>;</p>
<p>&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">while</span> (<span style="color: rgb(184, 191, 198);">!eventLoop-&gt;stop</span>) { <span style="color: rgb(218, 146, 74);">// 当没有显示标志停止时不断循环处理事件循环中的线程</span></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">if</span> (<span style="color: rgb(184, 191, 198);">eventLoop-&gt;beforesleep</span> <span style="color: rgb(184, 191, 198);">!=</span> <span style="color: rgb(184, 191, 198);">NULL</span>) <span style="color: rgb(218, 146, 74);">// 在执行处理事件时回调beforesleep，因为操作底层IO事件时可能导致线程阻塞</span></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">eventLoop-&gt;beforesleep</span>(<span style="color: rgb(184, 191, 198);">eventLoop</span>);</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">aeProcessEvents</span>(<span style="color: rgb(184, 191, 198);">eventLoop</span>, <span style="color: rgb(184, 191, 198);">AE_ALL_EVENTS</span>); <span style="color: rgb(218, 146, 74);">// 完成实际事件处理，可以看到这里将处理所有类型的事件（AE_ALL_EVENTS (AE_FILE_EVENTS|AE_TIME_EVENTS) #define AE_FILE_EVENTS 1 #define AE_TIME_EVENTS 2 ，事件类型分为：文件fd的事件、时间超时事件）</span></p>
<p>&nbsp;}</p>
<p>}</p>
<p><strong>aeDeleteEventLoop 函数</strong></p>
<p>该函数将在主线程完成处理后退出，然后释放事件循环结构。</p>
<p><span style="color: rgb(28, 198, 133);">void</span> <span style="color: rgb(141, 141, 240);">aeDeleteEventLoop</span>(<span style="color: rgb(184, 191, 198);">aeEventLoop</span> <span style="color: rgb(184, 191, 198);">*eventLoop</span>) {</p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">aeApiFree</span>(<span style="color: rgb(184, 191, 198);">eventLoop</span>); <span style="color: rgb(218, 146, 74);">// 处理实际事件循环fd的处理，比如：关闭epll的fd</span></p>
<p>&nbsp;&nbsp;<span style="color: rgb(218, 146, 74);">// 释放结构占用空间</span></p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">zfree</span>(<span style="color: rgb(184, 191, 198);">eventLoop-&gt;events</span>);</p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">zfree</span>(<span style="color: rgb(184, 191, 198);">eventLoop-&gt;fired</span>);</p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">zfree</span>(<span style="color: rgb(184, 191, 198);">eventLoop</span>);</p>
<p>}</p>
<p><br></p></p>
</body>
</html>