<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
</head>
<body>
<h1>Redis RDB 复制原理</h1>
<p>2022-07-08T11:35:26.562+0800</p>
<p><p>我们知道Redis 是一个内存数据库，所以我们需要做的就是将内存中的数据dump到磁盘即可，这通常有两种方式：</p>
<ol>
 <li>在dump时，redis不可用</li>
 <li>在dump时，redis可用。这时，就需要保证读写互斥，那么为了保证在开始dump数据时的快照，那么就需要将当前进程dump时刻的数据形成一个快照，这件事如果由Redis来实现的话，有些难，同时也会导致实现复杂，那么很明显我们通过OS提供的fork机制来实现即可</li>
</ol>
<p>在类Unix中，fork系统调用，通常用于创建进程，新创建的进程为当前进程的子进程，同时父子进程的数据相互隔离，所以很明显的满足了我们的需求：保存快照并dump到磁盘。</p>
<p>还记得如下代码么？在Redis初始化时放入事件循环中的时间事件。我们很容易想到：RDB的机制肯定具备某种触发条件，而这个条件往往与时间相关，所以我们直接将关注点放到该函数serverCron中，同时我们可以看到Redis将每1毫秒执行一次该函数，当然，由于Redis将会在处理完用户请求后才会触发该函数，所以，将会大于1毫秒。</p>
<p><span style="color: rgb(28, 198, 133);">void</span> <span style="color: rgb(141, 141, 240);">initServer</span>() {</p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">aeCreateTimeEvent</span>(<span style="color: rgb(184, 191, 198);">server</span>.<span style="color: rgb(184, 191, 198);">el</span>, <span style="color: rgb(100, 171, 143);">1</span>, <span style="color: rgb(184, 191, 198);">serverCron</span>, <span style="color: rgb(184, 191, 198);">NULL</span>, <span style="color: rgb(184, 191, 198);">NULL</span>);</p>
<p>}</p>
<p><strong>serverCron 函数</strong></p>
<p>那么，我们直接将目光放到serverCron函数即可。我们看到在Redis初始化时将会设置rdb参数，将设置三个阈值：</p>
<ol>
 <li>1 小时以内发生至少 1 次内存数据修改</li>
 <li>5 分钟以内发生至少 100 次内存数据修改</li>
 <li>1 分钟以内发生至少 10000 次内存数据修改</li>
</ol>
<p>这些数值如何带来的？考虑下：内存中的数据与磁盘中的数据的异同个数，如果太少，那么没必要rdb浪费性能，如果太多，那么尽早完成rdb，减少数据丢失量。</p>
<p><span style="color: rgb(28, 198, 133);">void</span> <span style="color: rgb(141, 141, 240);">initServerConfig</span>() {</p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">appendServerSaveParams</span>(<span style="color: rgb(100, 171, 143);">60</span><span style="color: rgb(184, 191, 198);">*</span><span style="color: rgb(100, 171, 143);">60</span>,<span style="color: rgb(100, 171, 143);">1</span>);&nbsp;<span style="color: rgb(218, 146, 74);">/* save after 1 hour and 1 change */</span></p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">appendServerSaveParams</span>(<span style="color: rgb(100, 171, 143);">300</span>,<span style="color: rgb(100, 171, 143);">100</span>);&nbsp;<span style="color: rgb(218, 146, 74);">/* save after 5 minutes and 100 changes */</span></p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">appendServerSaveParams</span>(<span style="color: rgb(100, 171, 143);">60</span>,<span style="color: rgb(100, 171, 143);">10000</span>); <span style="color: rgb(218, 146, 74);">/* save after 1 minute and 10000 changes */</span></p>
<p>}</p>
<p>​</p>
<p><span style="color: rgb(28, 198, 133);">void</span> <span style="color: rgb(141, 141, 240);">appendServerSaveParams</span>(<span style="color: rgb(184, 191, 198);">time_t</span> <span style="color: rgb(184, 191, 198);">seconds</span>, <span style="color: rgb(28, 198, 133);">int</span> <span style="color: rgb(184, 191, 198);">changes</span>) {</p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">server</span>.<span style="color: rgb(184, 191, 198);">saveparams</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">zrealloc</span>(<span style="color: rgb(184, 191, 198);">server</span>.<span style="color: rgb(184, 191, 198);">saveparams</span>,<span style="color: rgb(200, 143, 208);">sizeof</span>(<span style="color: rgb(200, 143, 208);">struct</span> <span style="color: rgb(141, 141, 240);">saveparam</span>)<span style="color: rgb(184, 191, 198);">*</span>(<span style="color: rgb(184, 191, 198);">server</span>.<span style="color: rgb(184, 191, 198);">saveparamslen+</span><span style="color: rgb(100, 171, 143);">1</span>));</p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">server</span>.<span style="color: rgb(184, 191, 198);">saveparams</span>[<span style="color: rgb(184, 191, 198);">server</span>.<span style="color: rgb(184, 191, 198);">saveparamslen</span>].<span style="color: rgb(184, 191, 198);">seconds</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">seconds</span>;</p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">server</span>.<span style="color: rgb(184, 191, 198);">saveparams</span>[<span style="color: rgb(184, 191, 198);">server</span>.<span style="color: rgb(184, 191, 198);">saveparamslen</span>].<span style="color: rgb(184, 191, 198);">changes</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">changes</span>;</p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">server</span>.<span style="color: rgb(184, 191, 198);">saveparamslen++</span>;</p>
<p>}</p>
<p>​</p>
<p><span style="color: rgb(28, 198, 133);">int</span> <span style="color: rgb(141, 141, 240);">serverCron</span>(<span style="color: rgb(200, 143, 208);">struct</span> <span style="color: rgb(141, 141, 240);">aeEventLoop</span> <span style="color: rgb(184, 191, 198);">*eventLoop</span>, <span style="color: rgb(28, 198, 133);">long</span> <span style="color: rgb(28, 198, 133);">long</span> <span style="color: rgb(184, 191, 198);">id</span>, <span style="color: rgb(28, 198, 133);">void</span> <span style="color: rgb(28, 198, 133);">*</span><span style="color: rgb(184, 191, 198);">clientData</span>) {</p>
<p>&nbsp;&nbsp;<span style="color: rgb(218, 146, 74);">// 传入参数都不使用</span></p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">REDIS_NOTUSED</span>(<span style="color: rgb(184, 191, 198);">eventLoop</span>);</p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">REDIS_NOTUSED</span>(<span style="color: rgb(184, 191, 198);">id</span>);</p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">REDIS_NOTUSED</span>(<span style="color: rgb(184, 191, 198);">clientData</span>);</p>
<p>&nbsp;...</p>
<p>&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">for</span> (<span style="color: rgb(184, 191, 198);">j</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(100, 171, 143);">0</span>; <span style="color: rgb(184, 191, 198);">j</span> <span style="color: rgb(184, 191, 198);">&lt;</span> <span style="color: rgb(184, 191, 198);">server</span>.<span style="color: rgb(184, 191, 198);">saveparamslen</span>; <span style="color: rgb(184, 191, 198);">j++</span>) { <span style="color: rgb(218, 146, 74);">// 遍历rdb参数并检测，是否触发RDB</span></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">struct</span> <span style="color: rgb(141, 141, 240);">saveparam</span> <span style="color: rgb(184, 191, 198);">*sp</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">server</span>.<span style="color: rgb(184, 191, 198);">saveparams+j</span>; <span style="color: rgb(218, 146, 74);">// 获取当前参数</span></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">if</span> (<span style="color: rgb(184, 191, 198);">server</span>.<span style="color: rgb(184, 191, 198);">dirty</span> <span style="color: rgb(184, 191, 198);">&gt;=</span> <span style="color: rgb(184, 191, 198);">sp-&gt;changes</span> <span style="color: rgb(184, 191, 198);">&amp;&amp;</span> <span style="color: rgb(218, 146, 74);">// 当前修改数据量大于设置的触发阈值</span></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">server</span>.<span style="color: rgb(184, 191, 198);">unixtime-server</span>.<span style="color: rgb(184, 191, 198);">lastsave</span> <span style="color: rgb(184, 191, 198);">&gt;</span> <span style="color: rgb(184, 191, 198);">sp-&gt;seconds</span>) { <span style="color: rgb(218, 146, 74);">// 当前时间到达设置的触发阈值</span></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">rdbSaveBackground</span>(<span style="color: rgb(184, 191, 198);">server</span>.<span style="color: rgb(184, 191, 198);">rdb_filename</span>); <span style="color: rgb(218, 146, 74);">// 执行RDB</span></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">break</span>;</p>
<p>&nbsp;&nbsp;&nbsp;}</p>
<p>&nbsp;}</p>
<p>}</p>
<p><strong>rdbSaveBackground 函数</strong></p>
<p>该函数将会调用fork系统调用，完成子进程的创建，同时通过 if else 改变父子进程的执行路线：子进程完成RDB，父进程继续相应客户端事件。</p>
<p><span style="color: rgb(28, 198, 133);">int</span> <span style="color: rgb(141, 141, 240);">rdbSaveBackground</span>(<span style="color: rgb(28, 198, 133);">char</span> <span style="color: rgb(28, 198, 133);">*</span><span style="color: rgb(184, 191, 198);">filename</span>) {</p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">pid_t</span> <span style="color: rgb(184, 191, 198);">childpid</span>;</p>
<p>&nbsp;&nbsp;<span style="color: rgb(28, 198, 133);">long</span> <span style="color: rgb(28, 198, 133);">long</span> <span style="color: rgb(184, 191, 198);">start</span>;</p>
<p>&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">if</span> (<span style="color: rgb(184, 191, 198);">server</span>.<span style="color: rgb(184, 191, 198);">rdb_child_pid</span> <span style="color: rgb(184, 191, 198);">!=</span> <span style="color: rgb(184, 191, 198);">-</span><span style="color: rgb(100, 171, 143);">1</span>) <span style="color: rgb(200, 143, 208);">return</span> <span style="color: rgb(184, 191, 198);">REDIS_ERR</span>; <span style="color: rgb(218, 146, 74);">// 当前已经存在RDB进程，不允许同时存在多个RDB进程</span></p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">server</span>.<span style="color: rgb(184, 191, 198);">dirty_before_bgsave</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">server</span>.<span style="color: rgb(184, 191, 198);">dirty</span>; <span style="color: rgb(218, 146, 74);">// 记录RDB前脏数据个数</span></p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">start</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">ustime</span>(); <span style="color: rgb(218, 146, 74);">// 记录开始时间</span></p>
<p>&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">if</span> ((<span style="color: rgb(184, 191, 198);">childpid</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">fork</span>()) <span style="color: rgb(184, 191, 198);">==</span> <span style="color: rgb(100, 171, 143);">0</span>) { <span style="color: rgb(218, 146, 74);">// 调用fork 调用，子进程将返回 0 </span></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(28, 198, 133);">int</span> <span style="color: rgb(184, 191, 198);">retval</span>;</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(218, 146, 74);">// 子进程不需要fd，因为只需要完成dump操作</span></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">if</span> (<span style="color: rgb(184, 191, 198);">server</span>.<span style="color: rgb(184, 191, 198);">ipfd</span> <span style="color: rgb(184, 191, 198);">&gt;</span> <span style="color: rgb(100, 171, 143);">0</span>) <span style="color: rgb(184, 191, 198);">close</span>(<span style="color: rgb(184, 191, 198);">server</span>.<span style="color: rgb(184, 191, 198);">ipfd</span>);</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">if</span> (<span style="color: rgb(184, 191, 198);">server</span>.<span style="color: rgb(184, 191, 198);">sofd</span> <span style="color: rgb(184, 191, 198);">&gt;</span> <span style="color: rgb(100, 171, 143);">0</span>) <span style="color: rgb(184, 191, 198);">close</span>(<span style="color: rgb(184, 191, 198);">server</span>.<span style="color: rgb(184, 191, 198);">sofd</span>);</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">retval</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">rdbSave</span>(<span style="color: rgb(184, 191, 198);">filename</span>); <span style="color: rgb(218, 146, 74);">// 执行保存</span></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">exitFromChild</span>((<span style="color: rgb(184, 191, 198);">retval</span> <span style="color: rgb(184, 191, 198);">==</span> <span style="color: rgb(184, 191, 198);">REDIS_OK</span>) <span style="color: rgb(184, 191, 198);">?</span> <span style="color: rgb(100, 171, 143);">0</span> : <span style="color: rgb(100, 171, 143);">1</span>); <span style="color: rgb(218, 146, 74);">// 退出子进程</span></p>
<p>&nbsp;} <span style="color: rgb(200, 143, 208);">else</span> {</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(218, 146, 74);">// 父进程代码，将记录状态返回继续处理客户都安事件</span></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">server</span>.<span style="color: rgb(184, 191, 198);">stat_fork_time</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">ustime</span>()<span style="color: rgb(184, 191, 198);">-start</span>;</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">if</span> (<span style="color: rgb(184, 191, 198);">childpid</span> <span style="color: rgb(184, 191, 198);">==</span> <span style="color: rgb(184, 191, 198);">-</span><span style="color: rgb(100, 171, 143);">1</span>) {</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">redisLog</span>(<span style="color: rgb(184, 191, 198);">REDIS_WARNING</span>,<span style="color: rgb(210, 107, 107);">"Can't save in background: fork: %s"</span>,</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">strerror</span>(<span style="color: rgb(184, 191, 198);">errno</span>));</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">return</span> <span style="color: rgb(184, 191, 198);">REDIS_ERR</span>;</p>
<p>&nbsp;&nbsp;&nbsp;}</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">redisLog</span>(<span style="color: rgb(184, 191, 198);">REDIS_NOTICE</span>,<span style="color: rgb(210, 107, 107);">"Background saving started by pid %d"</span>,<span style="color: rgb(184, 191, 198);">childpid</span>);</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">server</span>.<span style="color: rgb(184, 191, 198);">rdb_save_time_start</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">time</span>(<span style="color: rgb(184, 191, 198);">NULL</span>);</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">server</span>.<span style="color: rgb(184, 191, 198);">rdb_child_pid</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">childpid</span>;</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">updateDictResizePolicy</span>();</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">return</span> <span style="color: rgb(184, 191, 198);">REDIS_OK</span>;</p>
<p>&nbsp;}</p>
<p>&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">return</span> <span style="color: rgb(184, 191, 198);">REDIS_OK</span>;</p>
<p>}</p>
<p><strong>rdbSave 函数</strong></p>
<p>该函数将完成实际RDB过程，filename为rdb 存储文件名。可以看到这里将会打开临时rdb文件，然后将db中的数据写入到文件中，然后重命名临时rdb文件为filename，然后关闭资源。源码如下。</p>
<p><span style="color: rgb(28, 198, 133);">int</span> <span style="color: rgb(141, 141, 240);">rdbSave</span>(<span style="color: rgb(28, 198, 133);">char</span> <span style="color: rgb(28, 198, 133);">*</span><span style="color: rgb(184, 191, 198);">filename</span>) {</p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">dictIterator</span> <span style="color: rgb(184, 191, 198);">*di</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">NULL</span>;</p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">dictEntry</span> <span style="color: rgb(184, 191, 198);">*de</span>;</p>
<p>&nbsp;&nbsp;<span style="color: rgb(28, 198, 133);">char</span> <span style="color: rgb(184, 191, 198);">tmpfile</span>[<span style="color: rgb(100, 171, 143);">256</span>];</p>
<p>&nbsp;&nbsp;<span style="color: rgb(28, 198, 133);">char</span> <span style="color: rgb(184, 191, 198);">magic</span>[<span style="color: rgb(100, 171, 143);">10</span>];</p>
<p>&nbsp;&nbsp;<span style="color: rgb(28, 198, 133);">int</span> <span style="color: rgb(184, 191, 198);">j</span>;</p>
<p>&nbsp;&nbsp;<span style="color: rgb(28, 198, 133);">long</span> <span style="color: rgb(28, 198, 133);">long</span> <span style="color: rgb(184, 191, 198);">now</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">mstime</span>();</p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">FILE</span> <span style="color: rgb(184, 191, 198);">*fp</span>;</p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">rio</span> <span style="color: rgb(184, 191, 198);">rdb</span>;</p>
<p>&nbsp;&nbsp;<span style="color: rgb(28, 198, 133);">uint64_t</span> <span style="color: rgb(184, 191, 198);">cksum</span>;</p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">snprintf</span>(<span style="color: rgb(184, 191, 198);">tmpfile</span>,<span style="color: rgb(100, 171, 143);">256</span>,<span style="color: rgb(210, 107, 107);">"</span><a href="http://temp-%d.rdb" target="_blank" style="color: rgb(210, 107, 107);">temp-%d.rdb</a><span style="color: rgb(210, 107, 107);">"</span>, (<span style="color: rgb(28, 198, 133);">int</span>) <span style="color: rgb(184, 191, 198);">getpid</span>()); <span style="color: rgb(218, 146, 74);">// 将格式化字符串写入到tmpfile数组中</span></p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">fp</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">fopen</span>(<span style="color: rgb(184, 191, 198);">tmpfile</span>,<span style="color: rgb(210, 107, 107);">"w"</span>);&nbsp;<span style="color: rgb(218, 146, 74);">// 以写文件打开rdb文件</span></p>
<p>&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">if</span> (<span style="color: rgb(184, 191, 198);">!fp</span>) {</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">redisLog</span>(<span style="color: rgb(184, 191, 198);">REDIS_WARNING</span>, <span style="color: rgb(210, 107, 107);">"Failed opening .rdb for saving: %s"</span>,</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">strerror</span>(<span style="color: rgb(184, 191, 198);">errno</span>));</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">return</span> <span style="color: rgb(184, 191, 198);">REDIS_ERR</span>;</p>
<p>&nbsp;}</p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">rioInitWithFile</span>(<span style="color: rgb(184, 191, 198);">&amp;rdb</span>,<span style="color: rgb(184, 191, 198);">fp</span>); <span style="color: rgb(218, 146, 74);">// 初始化</span></p>
<p>&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">if</span> (<span style="color: rgb(184, 191, 198);">server</span>.<span style="color: rgb(184, 191, 198);">rdb_checksum</span>) <span style="color: rgb(218, 146, 74);">// 写入校验号</span></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">rdb</span>.<span style="color: rgb(184, 191, 198);">update_cksum</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">rioGenericUpdateChecksum</span>;</p>
<p>&nbsp;&nbsp;<span style="color: rgb(218, 146, 74);">// 将版本信息写入到文件中</span></p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">snprintf</span>(<span style="color: rgb(184, 191, 198);">magic</span>,<span style="color: rgb(200, 143, 208);">sizeof</span>(<span style="color: rgb(184, 191, 198);">magic</span>),<span style="color: rgb(210, 107, 107);">"REDIS%04d"</span>,<span style="color: rgb(184, 191, 198);">REDIS_RDB_VERSION</span>);</p>
<p>&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">if</span> (<span style="color: rgb(184, 191, 198);">rdbWriteRaw</span>(<span style="color: rgb(184, 191, 198);">&amp;rdb</span>,<span style="color: rgb(184, 191, 198);">magic</span>,<span style="color: rgb(100, 171, 143);">9</span>) <span style="color: rgb(184, 191, 198);">==</span> <span style="color: rgb(184, 191, 198);">-</span><span style="color: rgb(100, 171, 143);">1</span>) <span style="color: rgb(200, 143, 208);">goto</span> <span style="color: rgb(184, 191, 198);">werr</span>;</p>
<p>​</p>
<p>&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">for</span> (<span style="color: rgb(184, 191, 198);">j</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(100, 171, 143);">0</span>; <span style="color: rgb(184, 191, 198);">j</span> <span style="color: rgb(184, 191, 198);">&lt;</span> <span style="color: rgb(184, 191, 198);">server</span>.<span style="color: rgb(184, 191, 198);">dbnum</span>; <span style="color: rgb(184, 191, 198);">j++</span>) { <span style="color: rgb(218, 146, 74);">// 遍历redis db，通常我们只有一个db。将其中的数据写入文件中</span></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">redisDb</span> <span style="color: rgb(184, 191, 198);">*db</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">server</span>.<span style="color: rgb(184, 191, 198);">db+j</span>;</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">dict</span> <span style="color: rgb(184, 191, 198);">*d</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">db-&gt;dict</span>;</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">if</span> (<span style="color: rgb(184, 191, 198);">dictSize</span>(<span style="color: rgb(184, 191, 198);">d</span>) <span style="color: rgb(184, 191, 198);">==</span> <span style="color: rgb(100, 171, 143);">0</span>) <span style="color: rgb(200, 143, 208);">continue</span>;</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">di</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">dictGetSafeIterator</span>(<span style="color: rgb(184, 191, 198);">d</span>);</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">if</span> (<span style="color: rgb(184, 191, 198);">!di</span>) {</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">fclose</span>(<span style="color: rgb(184, 191, 198);">fp</span>);</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">return</span> <span style="color: rgb(184, 191, 198);">REDIS_ERR</span>;</p>
<p>&nbsp;&nbsp;&nbsp;}</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(218, 146, 74);">// 写入所属db信息</span></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">if</span> (<span style="color: rgb(184, 191, 198);">rdbSaveType</span>(<span style="color: rgb(184, 191, 198);">&amp;rdb</span>,<span style="color: rgb(184, 191, 198);">REDIS_RDB_OPCODE_SELECTDB</span>) <span style="color: rgb(184, 191, 198);">==</span> <span style="color: rgb(184, 191, 198);">-</span><span style="color: rgb(100, 171, 143);">1</span>) <span style="color: rgb(200, 143, 208);">goto</span> <span style="color: rgb(184, 191, 198);">werr</span>;</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">if</span> (<span style="color: rgb(184, 191, 198);">rdbSaveLen</span>(<span style="color: rgb(184, 191, 198);">&amp;rdb</span>,<span style="color: rgb(184, 191, 198);">j</span>) <span style="color: rgb(184, 191, 198);">==</span> <span style="color: rgb(184, 191, 198);">-</span><span style="color: rgb(100, 171, 143);">1</span>) <span style="color: rgb(200, 143, 208);">goto</span> <span style="color: rgb(184, 191, 198);">werr</span>;</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(218, 146, 74);">// 迭代db中的信息，获取所有的 key - value 写入文件中</span></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">while</span>((<span style="color: rgb(184, 191, 198);">de</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">dictNext</span>(<span style="color: rgb(184, 191, 198);">di</span>)) <span style="color: rgb(184, 191, 198);">!=</span> <span style="color: rgb(184, 191, 198);">NULL</span>) { <span style="color: rgb(218, 146, 74);">// 这里的写法参考下java的map中的entryset，混沌学堂的学员务必考虑下二级指针如何实现map</span></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">sds</span> <span style="color: rgb(184, 191, 198);">keystr</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">dictGetKey</span>(<span style="color: rgb(184, 191, 198);">de</span>);</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">robj</span> <span style="color: rgb(184, 191, 198);">key</span>, <span style="color: rgb(184, 191, 198);">*o</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">dictGetVal</span>(<span style="color: rgb(184, 191, 198);">de</span>);</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(28, 198, 133);">long</span> <span style="color: rgb(28, 198, 133);">long</span> <span style="color: rgb(184, 191, 198);">expire</span>;</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">initStaticStringObject</span>(<span style="color: rgb(184, 191, 198);">key</span>,<span style="color: rgb(184, 191, 198);">keystr</span>); <span style="color: rgb(218, 146, 74);">// 将key 转为 redis 的 String 类型的 robj</span></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">expire</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">getExpire</span>(<span style="color: rgb(184, 191, 198);">db</span>,<span style="color: rgb(184, 191, 198);">&amp;key</span>); <span style="color: rgb(218, 146, 74);">// 获取过期时间</span></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">if</span> (<span style="color: rgb(184, 191, 198);">rdbSaveKeyValuePair</span>(<span style="color: rgb(184, 191, 198);">&amp;rdb</span>,<span style="color: rgb(184, 191, 198);">&amp;key</span>,<span style="color: rgb(184, 191, 198);">o</span>,<span style="color: rgb(184, 191, 198);">expire</span>,<span style="color: rgb(184, 191, 198);">now</span>) <span style="color: rgb(184, 191, 198);">==</span> <span style="color: rgb(184, 191, 198);">-</span><span style="color: rgb(100, 171, 143);">1</span>) <span style="color: rgb(200, 143, 208);">goto</span> <span style="color: rgb(184, 191, 198);">werr</span>;</p>
<p>&nbsp;&nbsp;&nbsp;}</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">dictReleaseIterator</span>(<span style="color: rgb(184, 191, 198);">di</span>); <span style="color: rgb(218, 146, 74);">// 释放迭代器</span></p>
<p>&nbsp;}</p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">di</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">NULL</span>;</p>
<p>&nbsp;&nbsp;<span style="color: rgb(218, 146, 74);">/* 写入结束号 */</span></p>
<p>&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">if</span> (<span style="color: rgb(184, 191, 198);">rdbSaveType</span>(<span style="color: rgb(184, 191, 198);">&amp;rdb</span>,<span style="color: rgb(184, 191, 198);">REDIS_RDB_OPCODE_EOF</span>) <span style="color: rgb(184, 191, 198);">==</span> <span style="color: rgb(184, 191, 198);">-</span><span style="color: rgb(100, 171, 143);">1</span>) <span style="color: rgb(200, 143, 208);">goto</span> <span style="color: rgb(184, 191, 198);">werr</span>;</p>
<p>&nbsp;&nbsp;<span style="color: rgb(218, 146, 74);">// 写入CRC64校验号，保证文件数据正确性</span></p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">cksum</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">rdb</span>.<span style="color: rgb(184, 191, 198);">cksum</span>;</p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">memrev64ifbe</span>(<span style="color: rgb(184, 191, 198);">&amp;cksum</span>);</p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">rioWrite</span>(<span style="color: rgb(184, 191, 198);">&amp;rdb</span>,<span style="color: rgb(184, 191, 198);">&amp;cksum</span>,<span style="color: rgb(100, 171, 143);">8</span>);</p>
<p>&nbsp;&nbsp;<span style="color: rgb(218, 146, 74);">// 保证数据落盘：刷新写缓冲区、将page cache 数据写入磁盘、关闭fd</span></p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">fflush</span>(<span style="color: rgb(184, 191, 198);">fp</span>);</p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">fsync</span>(<span style="color: rgb(184, 191, 198);">fileno</span>(<span style="color: rgb(184, 191, 198);">fp</span>));</p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">fclose</span>(<span style="color: rgb(184, 191, 198);">fp</span>);</p>
<p>&nbsp;&nbsp;<span style="color: rgb(218, 146, 74);">// 将临时文件名修改为正确文件名</span></p>
<p>&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">if</span> (<span style="color: rgb(184, 191, 198);">rename</span>(<span style="color: rgb(184, 191, 198);">tmpfile</span>,<span style="color: rgb(184, 191, 198);">filename</span>) <span style="color: rgb(184, 191, 198);">==</span> <span style="color: rgb(184, 191, 198);">-</span><span style="color: rgb(100, 171, 143);">1</span>) {</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">redisLog</span>(<span style="color: rgb(184, 191, 198);">REDIS_WARNING</span>,<span style="color: rgb(210, 107, 107);">"Error moving temp DB file on the final destination: %s"</span>, <span style="color: rgb(184, 191, 198);">strerror</span>(<span style="color: rgb(184, 191, 198);">errno</span>));</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">unlink</span>(<span style="color: rgb(184, 191, 198);">tmpfile</span>);</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">return</span> <span style="color: rgb(184, 191, 198);">REDIS_ERR</span>;</p>
<p>&nbsp;}</p>
<p>&nbsp;&nbsp;<span style="color: rgb(218, 146, 74);">// 重置所有数据，并关闭资源</span></p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">redisLog</span>(<span style="color: rgb(184, 191, 198);">REDIS_NOTICE</span>,<span style="color: rgb(210, 107, 107);">"DB saved on disk"</span>);</p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">server</span>.<span style="color: rgb(184, 191, 198);">dirty</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(100, 171, 143);">0</span>;</p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">server</span>.<span style="color: rgb(184, 191, 198);">lastsave</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">time</span>(<span style="color: rgb(184, 191, 198);">NULL</span>);</p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">server</span>.<span style="color: rgb(184, 191, 198);">lastbgsave_status</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">REDIS_OK</span>;</p>
<p>&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">return</span> <span style="color: rgb(184, 191, 198);">REDIS_OK</span>;</p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">werr</span>:</p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">fclose</span>(<span style="color: rgb(184, 191, 198);">fp</span>);</p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">unlink</span>(<span style="color: rgb(184, 191, 198);">tmpfile</span>);</p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">redisLog</span>(<span style="color: rgb(184, 191, 198);">REDIS_WARNING</span>,<span style="color: rgb(210, 107, 107);">"Write error saving DB on disk: %s"</span>, <span style="color: rgb(184, 191, 198);">strerror</span>(<span style="color: rgb(184, 191, 198);">errno</span>));</p>
<p>&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">if</span> (<span style="color: rgb(184, 191, 198);">di</span>) <span style="color: rgb(184, 191, 198);">dictReleaseIterator</span>(<span style="color: rgb(184, 191, 198);">di</span>);</p>
<p>&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">return</span> <span style="color: rgb(184, 191, 198);">REDIS_ERR</span>;</p>
<p>}</p>
<p>​</p>
<p><span style="color: rgb(218, 146, 74);">// 初始化 rio *r</span></p>
<p><span style="color: rgb(200, 143, 208);">static</span> <span style="color: rgb(200, 143, 208);">const</span> <span style="color: rgb(184, 191, 198);">rio</span> <span style="color: rgb(184, 191, 198);">rioFileIO</span> <span style="color: rgb(184, 191, 198);">=</span> {</p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">rioFileRead</span>, <span style="color: rgb(218, 146, 74);">// 指定rio读操作</span></p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">rioFileWrite</span>, <span style="color: rgb(218, 146, 74);">// 指定rio写操作</span></p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">rioFileTell</span>, <span style="color: rgb(218, 146, 74);">// 指定获取文件读写position位置的操作</span></p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">NULL</span>,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</p>
<p>&nbsp;&nbsp;<span style="color: rgb(100, 171, 143);">0</span>,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</p>
<p>&nbsp;{ { <span style="color: rgb(184, 191, 198);">NULL</span>, <span style="color: rgb(100, 171, 143);">0</span> } }</p>
<p>};</p>
<p>​</p>
<p><span style="color: rgb(218, 146, 74);">// 三个函数，均是直接调用 系统函数库 中的函数，非常简单~ 不懂的话 man 一下就行</span></p>
<p><span style="color: rgb(200, 143, 208);">static</span> <span style="color: rgb(184, 191, 198);">inline</span> <span style="color: rgb(28, 198, 133);">size_t</span> <span style="color: rgb(141, 141, 240);">rioWrite</span>(<span style="color: rgb(184, 191, 198);">rio</span> <span style="color: rgb(184, 191, 198);">*r</span>, <span style="color: rgb(200, 143, 208);">const</span> <span style="color: rgb(28, 198, 133);">void</span> <span style="color: rgb(28, 198, 133);">*</span><span style="color: rgb(184, 191, 198);">buf</span>, <span style="color: rgb(28, 198, 133);">size_t</span> <span style="color: rgb(184, 191, 198);">len</span>) {</p>
<p>&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">if</span> (<span style="color: rgb(184, 191, 198);">r-&gt;update_cksum</span>) <span style="color: rgb(184, 191, 198);">r-&gt;update_cksum</span>(<span style="color: rgb(184, 191, 198);">r</span>,<span style="color: rgb(184, 191, 198);">buf</span>,<span style="color: rgb(184, 191, 198);">len</span>);</p>
<p>&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">return</span> <span style="color: rgb(184, 191, 198);">r-&gt;write</span>(<span style="color: rgb(184, 191, 198);">r</span>,<span style="color: rgb(184, 191, 198);">buf</span>,<span style="color: rgb(184, 191, 198);">len</span>);</p>
<p>}</p>
<p>​</p>
<p><span style="color: rgb(200, 143, 208);">static</span> <span style="color: rgb(184, 191, 198);">inline</span> <span style="color: rgb(28, 198, 133);">size_t</span> <span style="color: rgb(141, 141, 240);">rioRead</span>(<span style="color: rgb(184, 191, 198);">rio</span> <span style="color: rgb(184, 191, 198);">*r</span>, <span style="color: rgb(28, 198, 133);">void</span> <span style="color: rgb(28, 198, 133);">*</span><span style="color: rgb(184, 191, 198);">buf</span>, <span style="color: rgb(28, 198, 133);">size_t</span> <span style="color: rgb(184, 191, 198);">len</span>) {</p>
<p>&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">if</span> (<span style="color: rgb(184, 191, 198);">r-&gt;read</span>(<span style="color: rgb(184, 191, 198);">r</span>,<span style="color: rgb(184, 191, 198);">buf</span>,<span style="color: rgb(184, 191, 198);">len</span>) <span style="color: rgb(184, 191, 198);">==</span> <span style="color: rgb(100, 171, 143);">1</span>) {</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">if</span> (<span style="color: rgb(184, 191, 198);">r-&gt;update_cksum</span>) <span style="color: rgb(184, 191, 198);">r-&gt;update_cksum</span>(<span style="color: rgb(184, 191, 198);">r</span>,<span style="color: rgb(184, 191, 198);">buf</span>,<span style="color: rgb(184, 191, 198);">len</span>);</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">return</span> <span style="color: rgb(100, 171, 143);">1</span>;</p>
<p>&nbsp;}</p>
<p>&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">return</span> <span style="color: rgb(100, 171, 143);">0</span>;</p>
<p>}</p>
<p>​</p>
<p><span style="color: rgb(200, 143, 208);">static</span> <span style="color: rgb(184, 191, 198);">inline</span> <span style="color: rgb(184, 191, 198);">off_t</span> <span style="color: rgb(141, 141, 240);">rioTell</span>(<span style="color: rgb(184, 191, 198);">rio</span> <span style="color: rgb(184, 191, 198);">*r</span>) {</p>
<p>&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">return</span> <span style="color: rgb(184, 191, 198);">r-&gt;tell</span>(<span style="color: rgb(184, 191, 198);">r</span>);</p>
<p>}</p>
<p>​</p>
<p><span style="color: rgb(28, 198, 133);">void</span> <span style="color: rgb(141, 141, 240);">rioInitWithFile</span>(<span style="color: rgb(184, 191, 198);">rio</span> <span style="color: rgb(184, 191, 198);">*r</span>, <span style="color: rgb(184, 191, 198);">FILE</span> <span style="color: rgb(184, 191, 198);">*fp</span>) {</p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">*r</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">rioFileIO</span>;</p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">r-&gt;io</span>.<span style="color: rgb(184, 191, 198);">file</span>.<span style="color: rgb(184, 191, 198);">fp</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">fp</span>;</p>
<p>}</p>
<p>​</p>
<p><span style="color: rgb(218, 146, 74);">// 将指针p处的数据写入文件，len指明写入长度</span></p>
<p><span style="color: rgb(200, 143, 208);">static</span> <span style="color: rgb(28, 198, 133);">int</span> <span style="color: rgb(141, 141, 240);">rdbWriteRaw</span>(<span style="color: rgb(184, 191, 198);">rio</span> <span style="color: rgb(184, 191, 198);">*rdb</span>, <span style="color: rgb(28, 198, 133);">void</span> <span style="color: rgb(28, 198, 133);">*</span><span style="color: rgb(184, 191, 198);">p</span>, <span style="color: rgb(28, 198, 133);">size_t</span> <span style="color: rgb(184, 191, 198);">len</span>) {</p>
<p>&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">if</span> (<span style="color: rgb(184, 191, 198);">rdb</span> <span style="color: rgb(184, 191, 198);">&amp;&amp;</span> <span style="color: rgb(184, 191, 198);">rioWrite</span>(<span style="color: rgb(184, 191, 198);">rdb</span>,<span style="color: rgb(184, 191, 198);">p</span>,<span style="color: rgb(184, 191, 198);">len</span>) <span style="color: rgb(184, 191, 198);">==</span> <span style="color: rgb(100, 171, 143);">0</span>) <span style="color: rgb(218, 146, 74);">// 直接调用rdb结构中的 rioFileWrite 函数</span></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">return</span> <span style="color: rgb(184, 191, 198);">-</span><span style="color: rgb(100, 171, 143);">1</span>;</p>
<p>&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">return</span> <span style="color: rgb(184, 191, 198);">len</span>;</p>
<p>}</p>
<p>​</p>
<p><span style="color: rgb(218, 146, 74);">// 该宏定义用于初始化在栈上分配的String类型的robj</span></p>
<p><span style="color: rgb(183, 179, 179);">#define initStaticStringObject(_var,_ptr) do { \</span></p>
<p>&nbsp;&nbsp;<span style="color: rgb(183, 179, 179);">_var.refcount = 1; \</span></p>
<p>&nbsp;&nbsp;<a href="http://_var.type" target="_blank" style="color: rgb(183, 179, 179);">_var.type</a><span style="color: rgb(183, 179, 179);"> = REDIS_STRING; \</span></p>
<p>&nbsp;&nbsp;<span style="color: rgb(183, 179, 179);">_var.encoding = REDIS_ENCODING_RAW; \</span></p>
<p>&nbsp;&nbsp;<a href="http://_var.ptr" target="_blank" style="color: rgb(183, 179, 179);">_var.ptr</a><span style="color: rgb(183, 179, 179);"> = _ptr; \</span></p>
<p><span style="color: rgb(183, 179, 179);">} while(0);</span></p>
<p><strong>相关写入函数</strong></p>
<p>本节将罗列并注释相关写入函数。rdbSaveKeyValuePair 为主入口函数，保存传入的key - value 、过期时间、类型信息，并将它们记录到rdb中，这些函数较为简单：根据类型遍历写入（读者注意其中为了节约内存使用的压缩列表和整形编码字符串、int 编码的 set 表）。源码如下。</p>
<p>​</p>
<p><span style="color: rgb(218, 146, 74);">// 将 key - value 、过期时间、类型 写入文件</span></p>
<p><span style="color: rgb(28, 198, 133);">int</span> <span style="color: rgb(141, 141, 240);">rdbSaveKeyValuePair</span>(<span style="color: rgb(184, 191, 198);">rio</span> <span style="color: rgb(184, 191, 198);">*rdb</span>, <span style="color: rgb(184, 191, 198);">robj</span> <span style="color: rgb(184, 191, 198);">*key</span>, <span style="color: rgb(184, 191, 198);">robj</span> <span style="color: rgb(184, 191, 198);">*val</span>,</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(28, 198, 133);">long</span> <span style="color: rgb(28, 198, 133);">long</span> <span style="color: rgb(184, 191, 198);">expiretime</span>, <span style="color: rgb(28, 198, 133);">long</span> <span style="color: rgb(28, 198, 133);">long</span> <span style="color: rgb(184, 191, 198);">now</span>)</p>
<p>{</p>
<p>&nbsp;&nbsp;<span style="color: rgb(218, 146, 74);">// 存在过期时间，那么保存国企时间即可</span></p>
<p>&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">if</span> (<span style="color: rgb(184, 191, 198);">expiretime</span> <span style="color: rgb(184, 191, 198);">!=</span> <span style="color: rgb(184, 191, 198);">-</span><span style="color: rgb(100, 171, 143);">1</span>) {</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(218, 146, 74);">// 如果key 已经过期，那么直接忽略</span></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">if</span> (<span style="color: rgb(184, 191, 198);">expiretime</span> <span style="color: rgb(184, 191, 198);">&lt;</span> <span style="color: rgb(184, 191, 198);">now</span>) <span style="color: rgb(200, 143, 208);">return</span> <span style="color: rgb(100, 171, 143);">0</span>;</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">if</span> (<span style="color: rgb(184, 191, 198);">rdbSaveType</span>(<span style="color: rgb(184, 191, 198);">rdb</span>,<span style="color: rgb(184, 191, 198);">REDIS_RDB_OPCODE_EXPIRETIME_MS</span>) <span style="color: rgb(184, 191, 198);">==</span> <span style="color: rgb(184, 191, 198);">-</span><span style="color: rgb(100, 171, 143);">1</span>) <span style="color: rgb(200, 143, 208);">return</span> <span style="color: rgb(184, 191, 198);">-</span><span style="color: rgb(100, 171, 143);">1</span>;</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">if</span> (<span style="color: rgb(184, 191, 198);">rdbSaveMillisecondTime</span>(<span style="color: rgb(184, 191, 198);">rdb</span>,<span style="color: rgb(184, 191, 198);">expiretime</span>) <span style="color: rgb(184, 191, 198);">==</span> <span style="color: rgb(184, 191, 198);">-</span><span style="color: rgb(100, 171, 143);">1</span>) <span style="color: rgb(200, 143, 208);">return</span> <span style="color: rgb(184, 191, 198);">-</span><span style="color: rgb(100, 171, 143);">1</span>;</p>
<p>&nbsp;}</p>
<p>&nbsp;&nbsp;<span style="color: rgb(218, 146, 74);">// 保存 type, key, value</span></p>
<p>&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">if</span> (<span style="color: rgb(184, 191, 198);">rdbSaveObjectType</span>(<span style="color: rgb(184, 191, 198);">rdb</span>,<span style="color: rgb(184, 191, 198);">val</span>) <span style="color: rgb(184, 191, 198);">==</span> <span style="color: rgb(184, 191, 198);">-</span><span style="color: rgb(100, 171, 143);">1</span>) <span style="color: rgb(200, 143, 208);">return</span> <span style="color: rgb(184, 191, 198);">-</span><span style="color: rgb(100, 171, 143);">1</span>;</p>
<p>&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">if</span> (<span style="color: rgb(184, 191, 198);">rdbSaveStringObject</span>(<span style="color: rgb(184, 191, 198);">rdb</span>,<span style="color: rgb(184, 191, 198);">key</span>) <span style="color: rgb(184, 191, 198);">==</span> <span style="color: rgb(184, 191, 198);">-</span><span style="color: rgb(100, 171, 143);">1</span>) <span style="color: rgb(200, 143, 208);">return</span> <span style="color: rgb(184, 191, 198);">-</span><span style="color: rgb(100, 171, 143);">1</span>;</p>
<p>&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">if</span> (<span style="color: rgb(184, 191, 198);">rdbSaveObject</span>(<span style="color: rgb(184, 191, 198);">rdb</span>,<span style="color: rgb(184, 191, 198);">val</span>) <span style="color: rgb(184, 191, 198);">==</span> <span style="color: rgb(184, 191, 198);">-</span><span style="color: rgb(100, 171, 143);">1</span>) <span style="color: rgb(200, 143, 208);">return</span> <span style="color: rgb(184, 191, 198);">-</span><span style="color: rgb(100, 171, 143);">1</span>;</p>
<p>&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">return</span> <span style="color: rgb(100, 171, 143);">1</span>;</p>
<p>}</p>
<p>​</p>
<p><span style="color: rgb(218, 146, 74);">// 保存robj的类型，根据类型写入1字节长度的类型值</span></p>
<p><span style="color: rgb(28, 198, 133);">int</span> <span style="color: rgb(141, 141, 240);">rdbSaveObjectType</span>(<span style="color: rgb(184, 191, 198);">rio</span> <span style="color: rgb(184, 191, 198);">*rdb</span>, <span style="color: rgb(184, 191, 198);">robj</span> <span style="color: rgb(184, 191, 198);">*o</span>) {</p>
<p>&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">switch</span> (<span style="color: rgb(184, 191, 198);">o-&gt;type</span>) {</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">case</span> <span style="color: rgb(184, 191, 198);">REDIS_STRING</span>: <span style="color: rgb(218, 146, 74);">// 写入字符串</span></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">return</span> <span style="color: rgb(184, 191, 198);">rdbSaveType</span>(<span style="color: rgb(184, 191, 198);">rdb</span>,<span style="color: rgb(184, 191, 198);">REDIS_RDB_TYPE_STRING</span>);</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">case</span> <span style="color: rgb(184, 191, 198);">REDIS_LIST</span>: <span style="color: rgb(218, 146, 74);">// 写入列表</span></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">if</span> (<span style="color: rgb(184, 191, 198);">o-&gt;encoding</span> <span style="color: rgb(184, 191, 198);">==</span> <span style="color: rgb(184, 191, 198);">REDIS_ENCODING_ZIPLIST</span>)</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">return</span> <span style="color: rgb(184, 191, 198);">rdbSaveType</span>(<span style="color: rgb(184, 191, 198);">rdb</span>,<span style="color: rgb(184, 191, 198);">REDIS_RDB_TYPE_LIST_ZIPLIST</span>);</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">else</span> <span style="color: rgb(200, 143, 208);">if</span> (<span style="color: rgb(184, 191, 198);">o-&gt;encoding</span> <span style="color: rgb(184, 191, 198);">==</span> <span style="color: rgb(184, 191, 198);">REDIS_ENCODING_LINKEDLIST</span>)</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">return</span> <span style="color: rgb(184, 191, 198);">rdbSaveType</span>(<span style="color: rgb(184, 191, 198);">rdb</span>,<span style="color: rgb(184, 191, 198);">REDIS_RDB_TYPE_LIST</span>);</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">else</span></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">redisPanic</span>(<span style="color: rgb(210, 107, 107);">"Unknown list encoding"</span>);</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">case</span> <span style="color: rgb(184, 191, 198);">REDIS_SET</span>: <span style="color: rgb(218, 146, 74);">// 写入集合</span></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">if</span> (<span style="color: rgb(184, 191, 198);">o-&gt;encoding</span> <span style="color: rgb(184, 191, 198);">==</span> <span style="color: rgb(184, 191, 198);">REDIS_ENCODING_INTSET</span>)</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">return</span> <span style="color: rgb(184, 191, 198);">rdbSaveType</span>(<span style="color: rgb(184, 191, 198);">rdb</span>,<span style="color: rgb(184, 191, 198);">REDIS_RDB_TYPE_SET_INTSET</span>);</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">else</span> <span style="color: rgb(200, 143, 208);">if</span> (<span style="color: rgb(184, 191, 198);">o-&gt;encoding</span> <span style="color: rgb(184, 191, 198);">==</span> <span style="color: rgb(184, 191, 198);">REDIS_ENCODING_HT</span>)</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">return</span> <span style="color: rgb(184, 191, 198);">rdbSaveType</span>(<span style="color: rgb(184, 191, 198);">rdb</span>,<span style="color: rgb(184, 191, 198);">REDIS_RDB_TYPE_SET</span>);</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">else</span></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">redisPanic</span>(<span style="color: rgb(210, 107, 107);">"Unknown set encoding"</span>);</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">case</span> <span style="color: rgb(184, 191, 198);">REDIS_ZSET</span>: <span style="color: rgb(218, 146, 74);">// 写入排序集合</span></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">if</span> (<span style="color: rgb(184, 191, 198);">o-&gt;encoding</span> <span style="color: rgb(184, 191, 198);">==</span> <span style="color: rgb(184, 191, 198);">REDIS_ENCODING_ZIPLIST</span>)</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">return</span> <span style="color: rgb(184, 191, 198);">rdbSaveType</span>(<span style="color: rgb(184, 191, 198);">rdb</span>,<span style="color: rgb(184, 191, 198);">REDIS_RDB_TYPE_ZSET_ZIPLIST</span>);</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">else</span> <span style="color: rgb(200, 143, 208);">if</span> (<span style="color: rgb(184, 191, 198);">o-&gt;encoding</span> <span style="color: rgb(184, 191, 198);">==</span> <span style="color: rgb(184, 191, 198);">REDIS_ENCODING_SKIPLIST</span>)</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">return</span> <span style="color: rgb(184, 191, 198);">rdbSaveType</span>(<span style="color: rgb(184, 191, 198);">rdb</span>,<span style="color: rgb(184, 191, 198);">REDIS_RDB_TYPE_ZSET</span>);</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">else</span></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">redisPanic</span>(<span style="color: rgb(210, 107, 107);">"Unknown sorted set encoding"</span>);</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">case</span> <span style="color: rgb(184, 191, 198);">REDIS_HASH</span>: <span style="color: rgb(218, 146, 74);">// 写入hash</span></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">if</span> (<span style="color: rgb(184, 191, 198);">o-&gt;encoding</span> <span style="color: rgb(184, 191, 198);">==</span> <span style="color: rgb(184, 191, 198);">REDIS_ENCODING_ZIPLIST</span>)</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">return</span> <span style="color: rgb(184, 191, 198);">rdbSaveType</span>(<span style="color: rgb(184, 191, 198);">rdb</span>,<span style="color: rgb(184, 191, 198);">REDIS_RDB_TYPE_HASH_ZIPLIST</span>);</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">else</span> <span style="color: rgb(200, 143, 208);">if</span> (<span style="color: rgb(184, 191, 198);">o-&gt;encoding</span> <span style="color: rgb(184, 191, 198);">==</span> <span style="color: rgb(184, 191, 198);">REDIS_ENCODING_HT</span>)</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">return</span> <span style="color: rgb(184, 191, 198);">rdbSaveType</span>(<span style="color: rgb(184, 191, 198);">rdb</span>,<span style="color: rgb(184, 191, 198);">REDIS_RDB_TYPE_HASH</span>);</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">else</span></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">redisPanic</span>(<span style="color: rgb(210, 107, 107);">"Unknown hash encoding"</span>);</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">default</span>:</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">redisPanic</span>(<span style="color: rgb(210, 107, 107);">"Unknown object type"</span>);</p>
<p>&nbsp;}</p>
<p>&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">return</span> <span style="color: rgb(184, 191, 198);">-</span><span style="color: rgb(100, 171, 143);">1</span>;</p>
<p>}</p>
<p>​</p>
<p><span style="color: rgb(218, 146, 74);">// 类型写入只需要1个字节长度即可</span></p>
<p><span style="color: rgb(28, 198, 133);">int</span> <span style="color: rgb(141, 141, 240);">rdbSaveType</span>(<span style="color: rgb(184, 191, 198);">rio</span> <span style="color: rgb(184, 191, 198);">*rdb</span>, <span style="color: rgb(28, 198, 133);">unsigned</span> <span style="color: rgb(28, 198, 133);">char</span> <span style="color: rgb(184, 191, 198);">type</span>) {</p>
<p>&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">return</span> <span style="color: rgb(184, 191, 198);">rdbWriteRaw</span>(<span style="color: rgb(184, 191, 198);">rdb</span>,<span style="color: rgb(184, 191, 198);">&amp;type</span>,<span style="color: rgb(100, 171, 143);">1</span>);</p>
<p>}</p>
<p>​</p>
<p><span style="color: rgb(218, 146, 74);">// 写入字符串对象</span></p>
<p><span style="color: rgb(28, 198, 133);">int</span> <span style="color: rgb(141, 141, 240);">rdbSaveStringObject</span>(<span style="color: rgb(184, 191, 198);">rio</span> <span style="color: rgb(184, 191, 198);">*rdb</span>, <span style="color: rgb(184, 191, 198);">robj</span> <span style="color: rgb(184, 191, 198);">*obj</span>) {</p>
<p>&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">if</span> (<span style="color: rgb(184, 191, 198);">obj-&gt;encoding</span> <span style="color: rgb(184, 191, 198);">==</span> <span style="color: rgb(184, 191, 198);">REDIS_ENCODING_INT</span>) { <span style="color: rgb(218, 146, 74);">// 整形编码</span></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">return</span> <span style="color: rgb(184, 191, 198);">rdbSaveLongLongAsStringObject</span>(<span style="color: rgb(184, 191, 198);">rdb</span>,(<span style="color: rgb(28, 198, 133);">long</span>)<span style="color: rgb(184, 191, 198);">obj-&gt;ptr</span>);</p>
<p>&nbsp;} <span style="color: rgb(200, 143, 208);">else</span> { <span style="color: rgb(218, 146, 74);">// 正常编码，直接按照C语言的字符串写入即可</span></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">redisAssertWithInfo</span>(<span style="color: rgb(184, 191, 198);">NULL</span>,<span style="color: rgb(184, 191, 198);">obj</span>,<span style="color: rgb(184, 191, 198);">obj-&gt;encoding</span> <span style="color: rgb(184, 191, 198);">==</span> <span style="color: rgb(184, 191, 198);">REDIS_ENCODING_RAW</span>);</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">return</span> <span style="color: rgb(184, 191, 198);">rdbSaveRawString</span>(<span style="color: rgb(184, 191, 198);">rdb</span>,<span style="color: rgb(184, 191, 198);">obj-&gt;ptr</span>,<span style="color: rgb(184, 191, 198);">sdslen</span>(<span style="color: rgb(184, 191, 198);">obj-&gt;ptr</span>));</p>
<p>&nbsp;}</p>
<p>}</p>
<p>​</p>
<p><span style="color: rgb(218, 146, 74);">// 将整形值直接写入或者转为字符串再写入</span></p>
<p><span style="color: rgb(28, 198, 133);">int</span> <span style="color: rgb(141, 141, 240);">rdbSaveLongLongAsStringObject</span>(<span style="color: rgb(184, 191, 198);">rio</span> <span style="color: rgb(184, 191, 198);">*rdb</span>, <span style="color: rgb(28, 198, 133);">long</span> <span style="color: rgb(28, 198, 133);">long</span> <span style="color: rgb(184, 191, 198);">value</span>) {</p>
<p>&nbsp;&nbsp;<span style="color: rgb(28, 198, 133);">unsigned</span> <span style="color: rgb(28, 198, 133);">char</span> <span style="color: rgb(184, 191, 198);">buf</span>[<span style="color: rgb(100, 171, 143);">32</span>];</p>
<p>&nbsp;&nbsp;<span style="color: rgb(28, 198, 133);">int</span> <span style="color: rgb(184, 191, 198);">n</span>, <span style="color: rgb(184, 191, 198);">nwritten</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(100, 171, 143);">0</span>;</p>
<p>&nbsp;&nbsp;<span style="color: rgb(28, 198, 133);">int</span> <span style="color: rgb(184, 191, 198);">enclen</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">rdbEncodeInteger</span>(<span style="color: rgb(184, 191, 198);">value</span>,<span style="color: rgb(184, 191, 198);">buf</span>);</p>
<p>&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">if</span> (<span style="color: rgb(184, 191, 198);">enclen</span> <span style="color: rgb(184, 191, 198);">&gt;</span> <span style="color: rgb(100, 171, 143);">0</span>) {&nbsp;<span style="color: rgb(218, 146, 74);">// 整形编码直接写入 buf 即可</span></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">return</span> <span style="color: rgb(184, 191, 198);">rdbWriteRaw</span>(<span style="color: rgb(184, 191, 198);">rdb</span>,<span style="color: rgb(184, 191, 198);">buf</span>,<span style="color: rgb(184, 191, 198);">enclen</span>);</p>
<p>&nbsp;} <span style="color: rgb(200, 143, 208);">else</span> { <span style="color: rgb(218, 146, 74);">// 否则编码为字符串</span></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">enclen</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">ll2string</span>((<span style="color: rgb(28, 198, 133);">char*</span>)<span style="color: rgb(184, 191, 198);">buf</span>,<span style="color: rgb(100, 171, 143);">32</span>,<span style="color: rgb(184, 191, 198);">value</span>);</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">redisAssert</span>(<span style="color: rgb(184, 191, 198);">enclen</span> <span style="color: rgb(184, 191, 198);">&lt;</span> <span style="color: rgb(100, 171, 143);">32</span>);</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">if</span> ((<span style="color: rgb(184, 191, 198);">n</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">rdbSaveLen</span>(<span style="color: rgb(184, 191, 198);">rdb</span>,<span style="color: rgb(184, 191, 198);">enclen</span>)) <span style="color: rgb(184, 191, 198);">==</span> <span style="color: rgb(184, 191, 198);">-</span><span style="color: rgb(100, 171, 143);">1</span>) <span style="color: rgb(200, 143, 208);">return</span> <span style="color: rgb(184, 191, 198);">-</span><span style="color: rgb(100, 171, 143);">1</span>;</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">nwritten</span> <span style="color: rgb(184, 191, 198);">+=</span> <span style="color: rgb(184, 191, 198);">n</span>;</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">if</span> ((<span style="color: rgb(184, 191, 198);">n</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">rdbWriteRaw</span>(<span style="color: rgb(184, 191, 198);">rdb</span>,<span style="color: rgb(184, 191, 198);">buf</span>,<span style="color: rgb(184, 191, 198);">enclen</span>)) <span style="color: rgb(184, 191, 198);">==</span> <span style="color: rgb(184, 191, 198);">-</span><span style="color: rgb(100, 171, 143);">1</span>) <span style="color: rgb(200, 143, 208);">return</span> <span style="color: rgb(184, 191, 198);">-</span><span style="color: rgb(100, 171, 143);">1</span>;</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">nwritten</span> <span style="color: rgb(184, 191, 198);">+=</span> <span style="color: rgb(184, 191, 198);">n</span>;</p>
<p>&nbsp;}</p>
<p>&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">return</span> <span style="color: rgb(184, 191, 198);">nwritten</span>;</p>
<p>}</p>
<p>​</p>
<p><span style="color: rgb(218, 146, 74);">// 所有类型的结构写入</span></p>
<p><span style="color: rgb(28, 198, 133);">int</span> <span style="color: rgb(141, 141, 240);">rdbSaveObject</span>(<span style="color: rgb(184, 191, 198);">rio</span> <span style="color: rgb(184, 191, 198);">*rdb</span>, <span style="color: rgb(184, 191, 198);">robj</span> <span style="color: rgb(184, 191, 198);">*o</span>) {</p>
<p>&nbsp;&nbsp;<span style="color: rgb(28, 198, 133);">int</span> <span style="color: rgb(184, 191, 198);">n</span>, <span style="color: rgb(184, 191, 198);">nwritten</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(100, 171, 143);">0</span>;</p>
<p>​</p>
<p>&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">if</span> (<span style="color: rgb(184, 191, 198);">o-&gt;type</span> <span style="color: rgb(184, 191, 198);">==</span> <span style="color: rgb(184, 191, 198);">REDIS_STRING</span>) { <span style="color: rgb(218, 146, 74);">// 写入字符串</span></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">if</span> ((<span style="color: rgb(184, 191, 198);">n</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">rdbSaveStringObject</span>(<span style="color: rgb(184, 191, 198);">rdb</span>,<span style="color: rgb(184, 191, 198);">o</span>)) <span style="color: rgb(184, 191, 198);">==</span> <span style="color: rgb(184, 191, 198);">-</span><span style="color: rgb(100, 171, 143);">1</span>) <span style="color: rgb(200, 143, 208);">return</span> <span style="color: rgb(184, 191, 198);">-</span><span style="color: rgb(100, 171, 143);">1</span>;</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">nwritten</span> <span style="color: rgb(184, 191, 198);">+=</span> <span style="color: rgb(184, 191, 198);">n</span>;</p>
<p>&nbsp;} <span style="color: rgb(200, 143, 208);">else</span> <span style="color: rgb(200, 143, 208);">if</span> (<span style="color: rgb(184, 191, 198);">o-&gt;type</span> <span style="color: rgb(184, 191, 198);">==</span> <span style="color: rgb(184, 191, 198);">REDIS_LIST</span>) { <span style="color: rgb(218, 146, 74);">// 写入列表</span></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">if</span> (<span style="color: rgb(184, 191, 198);">o-&gt;encoding</span> <span style="color: rgb(184, 191, 198);">==</span> <span style="color: rgb(184, 191, 198);">REDIS_ENCODING_ZIPLIST</span>) { <span style="color: rgb(218, 146, 74);">// 压缩列表，由于是数组保存，那么直接保存整个数组即可</span></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(28, 198, 133);">size_t</span> <span style="color: rgb(184, 191, 198);">l</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">ziplistBlobLen</span>((<span style="color: rgb(28, 198, 133);">unsigned</span> <span style="color: rgb(28, 198, 133);">char*</span>)<span style="color: rgb(184, 191, 198);">o-&gt;ptr</span>);</p>
<p>​</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">if</span> ((<span style="color: rgb(184, 191, 198);">n</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">rdbSaveRawString</span>(<span style="color: rgb(184, 191, 198);">rdb</span>,<span style="color: rgb(184, 191, 198);">o-&gt;ptr</span>,<span style="color: rgb(184, 191, 198);">l</span>)) <span style="color: rgb(184, 191, 198);">==</span> <span style="color: rgb(184, 191, 198);">-</span><span style="color: rgb(100, 171, 143);">1</span>) <span style="color: rgb(200, 143, 208);">return</span> <span style="color: rgb(184, 191, 198);">-</span><span style="color: rgb(100, 171, 143);">1</span>;</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">nwritten</span> <span style="color: rgb(184, 191, 198);">+=</span> <span style="color: rgb(184, 191, 198);">n</span>;</p>
<p>&nbsp;&nbsp;&nbsp;} <span style="color: rgb(200, 143, 208);">else</span> <span style="color: rgb(200, 143, 208);">if</span> (<span style="color: rgb(184, 191, 198);">o-&gt;encoding</span> <span style="color: rgb(184, 191, 198);">==</span> <span style="color: rgb(184, 191, 198);">REDIS_ENCODING_LINKEDLIST</span>) { <span style="color: rgb(218, 146, 74);">// 链表存储，那么遍历链表并写入</span></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">list</span> <span style="color: rgb(184, 191, 198);">*list</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">o-&gt;ptr</span>;</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">listIter</span> <span style="color: rgb(184, 191, 198);">li</span>;</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">listNode</span> <span style="color: rgb(184, 191, 198);">*ln</span>;</p>
<p>​</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">if</span> ((<span style="color: rgb(184, 191, 198);">n</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">rdbSaveLen</span>(<span style="color: rgb(184, 191, 198);">rdb</span>,<span style="color: rgb(184, 191, 198);">listLength</span>(<span style="color: rgb(184, 191, 198);">list</span>))) <span style="color: rgb(184, 191, 198);">==</span> <span style="color: rgb(184, 191, 198);">-</span><span style="color: rgb(100, 171, 143);">1</span>) <span style="color: rgb(200, 143, 208);">return</span> <span style="color: rgb(184, 191, 198);">-</span><span style="color: rgb(100, 171, 143);">1</span>;</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">nwritten</span> <span style="color: rgb(184, 191, 198);">+=</span> <span style="color: rgb(184, 191, 198);">n</span>;</p>
<p>​</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">listRewind</span>(<span style="color: rgb(184, 191, 198);">list</span>,<span style="color: rgb(184, 191, 198);">&amp;li</span>);</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">while</span>((<span style="color: rgb(184, 191, 198);">ln</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">listNext</span>(<span style="color: rgb(184, 191, 198);">&amp;li</span>))) {</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">robj</span> <span style="color: rgb(184, 191, 198);">*eleobj</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">listNodeValue</span>(<span style="color: rgb(184, 191, 198);">ln</span>);</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">if</span> ((<span style="color: rgb(184, 191, 198);">n</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">rdbSaveStringObject</span>(<span style="color: rgb(184, 191, 198);">rdb</span>,<span style="color: rgb(184, 191, 198);">eleobj</span>)) <span style="color: rgb(184, 191, 198);">==</span> <span style="color: rgb(184, 191, 198);">-</span><span style="color: rgb(100, 171, 143);">1</span>) <span style="color: rgb(200, 143, 208);">return</span> <span style="color: rgb(184, 191, 198);">-</span><span style="color: rgb(100, 171, 143);">1</span>;</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">nwritten</span> <span style="color: rgb(184, 191, 198);">+=</span> <span style="color: rgb(184, 191, 198);">n</span>;</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</p>
<p>&nbsp;&nbsp;&nbsp;} <span style="color: rgb(200, 143, 208);">else</span> {</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">redisPanic</span>(<span style="color: rgb(210, 107, 107);">"Unknown list encoding"</span>);</p>
<p>&nbsp;&nbsp;&nbsp;}</p>
<p>&nbsp;} <span style="color: rgb(200, 143, 208);">else</span> <span style="color: rgb(200, 143, 208);">if</span> (<span style="color: rgb(184, 191, 198);">o-&gt;type</span> <span style="color: rgb(184, 191, 198);">==</span> <span style="color: rgb(184, 191, 198);">REDIS_SET</span>) { <span style="color: rgb(218, 146, 74);">// 保存集合</span></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">if</span> (<span style="color: rgb(184, 191, 198);">o-&gt;encoding</span> <span style="color: rgb(184, 191, 198);">==</span> <span style="color: rgb(184, 191, 198);">REDIS_ENCODING_HT</span>) { <span style="color: rgb(218, 146, 74);">// hash 表存储，那么直接遍历 entry 写入</span></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">dict</span> <span style="color: rgb(184, 191, 198);">*set</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">o-&gt;ptr</span>;</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">dictIterator</span> <span style="color: rgb(184, 191, 198);">*di</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">dictGetIterator</span>(<span style="color: rgb(184, 191, 198);">set</span>);</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">dictEntry</span> <span style="color: rgb(184, 191, 198);">*de</span>;</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">if</span> ((<span style="color: rgb(184, 191, 198);">n</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">rdbSaveLen</span>(<span style="color: rgb(184, 191, 198);">rdb</span>,<span style="color: rgb(184, 191, 198);">dictSize</span>(<span style="color: rgb(184, 191, 198);">set</span>))) <span style="color: rgb(184, 191, 198);">==</span> <span style="color: rgb(184, 191, 198);">-</span><span style="color: rgb(100, 171, 143);">1</span>) <span style="color: rgb(200, 143, 208);">return</span> <span style="color: rgb(184, 191, 198);">-</span><span style="color: rgb(100, 171, 143);">1</span>;</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">nwritten</span> <span style="color: rgb(184, 191, 198);">+=</span> <span style="color: rgb(184, 191, 198);">n</span>;</p>
<p>​</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">while</span>((<span style="color: rgb(184, 191, 198);">de</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">dictNext</span>(<span style="color: rgb(184, 191, 198);">di</span>)) <span style="color: rgb(184, 191, 198);">!=</span> <span style="color: rgb(184, 191, 198);">NULL</span>) {</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">robj</span> <span style="color: rgb(184, 191, 198);">*eleobj</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">dictGetKey</span>(<span style="color: rgb(184, 191, 198);">de</span>);</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">if</span> ((<span style="color: rgb(184, 191, 198);">n</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">rdbSaveStringObject</span>(<span style="color: rgb(184, 191, 198);">rdb</span>,<span style="color: rgb(184, 191, 198);">eleobj</span>)) <span style="color: rgb(184, 191, 198);">==</span> <span style="color: rgb(184, 191, 198);">-</span><span style="color: rgb(100, 171, 143);">1</span>) <span style="color: rgb(200, 143, 208);">return</span> <span style="color: rgb(184, 191, 198);">-</span><span style="color: rgb(100, 171, 143);">1</span>;</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">nwritten</span> <span style="color: rgb(184, 191, 198);">+=</span> <span style="color: rgb(184, 191, 198);">n</span>;</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">dictReleaseIterator</span>(<span style="color: rgb(184, 191, 198);">di</span>);</p>
<p>&nbsp;&nbsp;&nbsp;} <span style="color: rgb(200, 143, 208);">else</span> <span style="color: rgb(200, 143, 208);">if</span> (<span style="color: rgb(184, 191, 198);">o-&gt;encoding</span> <span style="color: rgb(184, 191, 198);">==</span> <span style="color: rgb(184, 191, 198);">REDIS_ENCODING_INTSET</span>) { <span style="color: rgb(218, 146, 74);">// intset 存储，那么直接写入整块数组</span></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(28, 198, 133);">size_t</span> <span style="color: rgb(184, 191, 198);">l</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">intsetBlobLen</span>((<span style="color: rgb(184, 191, 198);">intset*</span>)<span style="color: rgb(184, 191, 198);">o-&gt;ptr</span>);</p>
<p>​</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">if</span> ((<span style="color: rgb(184, 191, 198);">n</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">rdbSaveRawString</span>(<span style="color: rgb(184, 191, 198);">rdb</span>,<span style="color: rgb(184, 191, 198);">o-&gt;ptr</span>,<span style="color: rgb(184, 191, 198);">l</span>)) <span style="color: rgb(184, 191, 198);">==</span> <span style="color: rgb(184, 191, 198);">-</span><span style="color: rgb(100, 171, 143);">1</span>) <span style="color: rgb(200, 143, 208);">return</span> <span style="color: rgb(184, 191, 198);">-</span><span style="color: rgb(100, 171, 143);">1</span>;</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">nwritten</span> <span style="color: rgb(184, 191, 198);">+=</span> <span style="color: rgb(184, 191, 198);">n</span>;</p>
<p>&nbsp;&nbsp;&nbsp;} <span style="color: rgb(200, 143, 208);">else</span> {</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">redisPanic</span>(<span style="color: rgb(210, 107, 107);">"Unknown set encoding"</span>);</p>
<p>&nbsp;&nbsp;&nbsp;}</p>
<p>&nbsp;} <span style="color: rgb(200, 143, 208);">else</span> <span style="color: rgb(200, 143, 208);">if</span> (<span style="color: rgb(184, 191, 198);">o-&gt;type</span> <span style="color: rgb(184, 191, 198);">==</span> <span style="color: rgb(184, 191, 198);">REDIS_ZSET</span>) { <span style="color: rgb(218, 146, 74);">// 排序集合写入</span></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">if</span> (<span style="color: rgb(184, 191, 198);">o-&gt;encoding</span> <span style="color: rgb(184, 191, 198);">==</span> <span style="color: rgb(184, 191, 198);">REDIS_ENCODING_ZIPLIST</span>) { <span style="color: rgb(218, 146, 74);">// 保存压缩列表的整个数组</span></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(28, 198, 133);">size_t</span> <span style="color: rgb(184, 191, 198);">l</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">ziplistBlobLen</span>((<span style="color: rgb(28, 198, 133);">unsigned</span> <span style="color: rgb(28, 198, 133);">char*</span>)<span style="color: rgb(184, 191, 198);">o-&gt;ptr</span>);</p>
<p>​</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">if</span> ((<span style="color: rgb(184, 191, 198);">n</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">rdbSaveRawString</span>(<span style="color: rgb(184, 191, 198);">rdb</span>,<span style="color: rgb(184, 191, 198);">o-&gt;ptr</span>,<span style="color: rgb(184, 191, 198);">l</span>)) <span style="color: rgb(184, 191, 198);">==</span> <span style="color: rgb(184, 191, 198);">-</span><span style="color: rgb(100, 171, 143);">1</span>) <span style="color: rgb(200, 143, 208);">return</span> <span style="color: rgb(184, 191, 198);">-</span><span style="color: rgb(100, 171, 143);">1</span>;</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">nwritten</span> <span style="color: rgb(184, 191, 198);">+=</span> <span style="color: rgb(184, 191, 198);">n</span>;</p>
<p>&nbsp;&nbsp;&nbsp;} <span style="color: rgb(200, 143, 208);">else</span> <span style="color: rgb(200, 143, 208);">if</span> (<span style="color: rgb(184, 191, 198);">o-&gt;encoding</span> <span style="color: rgb(184, 191, 198);">==</span> <span style="color: rgb(184, 191, 198);">REDIS_ENCODING_SKIPLIST</span>) { <span style="color: rgb(218, 146, 74);">// 保存调表项，遍历并写入entry</span></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">zset</span> <span style="color: rgb(184, 191, 198);">*zs</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">o-&gt;ptr</span>;</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">dictIterator</span> <span style="color: rgb(184, 191, 198);">*di</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">dictGetIterator</span>(<span style="color: rgb(184, 191, 198);">zs-&gt;dict</span>);</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">dictEntry</span> <span style="color: rgb(184, 191, 198);">*de</span>;</p>
<p>​</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">if</span> ((<span style="color: rgb(184, 191, 198);">n</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">rdbSaveLen</span>(<span style="color: rgb(184, 191, 198);">rdb</span>,<span style="color: rgb(184, 191, 198);">dictSize</span>(<span style="color: rgb(184, 191, 198);">zs-&gt;dict</span>))) <span style="color: rgb(184, 191, 198);">==</span> <span style="color: rgb(184, 191, 198);">-</span><span style="color: rgb(100, 171, 143);">1</span>) <span style="color: rgb(200, 143, 208);">return</span> <span style="color: rgb(184, 191, 198);">-</span><span style="color: rgb(100, 171, 143);">1</span>;</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">nwritten</span> <span style="color: rgb(184, 191, 198);">+=</span> <span style="color: rgb(184, 191, 198);">n</span>;</p>
<p>​</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">while</span>((<span style="color: rgb(184, 191, 198);">de</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">dictNext</span>(<span style="color: rgb(184, 191, 198);">di</span>)) <span style="color: rgb(184, 191, 198);">!=</span> <span style="color: rgb(184, 191, 198);">NULL</span>) {</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">robj</span> <span style="color: rgb(184, 191, 198);">*eleobj</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">dictGetKey</span>(<span style="color: rgb(184, 191, 198);">de</span>);</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(28, 198, 133);">double</span> <span style="color: rgb(28, 198, 133);">*</span><span style="color: rgb(184, 191, 198);">score</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">dictGetVal</span>(<span style="color: rgb(184, 191, 198);">de</span>);</p>
<p>​</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">if</span> ((<span style="color: rgb(184, 191, 198);">n</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">rdbSaveStringObject</span>(<span style="color: rgb(184, 191, 198);">rdb</span>,<span style="color: rgb(184, 191, 198);">eleobj</span>)) <span style="color: rgb(184, 191, 198);">==</span> <span style="color: rgb(184, 191, 198);">-</span><span style="color: rgb(100, 171, 143);">1</span>) <span style="color: rgb(200, 143, 208);">return</span> <span style="color: rgb(184, 191, 198);">-</span><span style="color: rgb(100, 171, 143);">1</span>;</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">nwritten</span> <span style="color: rgb(184, 191, 198);">+=</span> <span style="color: rgb(184, 191, 198);">n</span>;</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">if</span> ((<span style="color: rgb(184, 191, 198);">n</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">rdbSaveDoubleValue</span>(<span style="color: rgb(184, 191, 198);">rdb</span>,<span style="color: rgb(184, 191, 198);">*score</span>)) <span style="color: rgb(184, 191, 198);">==</span> <span style="color: rgb(184, 191, 198);">-</span><span style="color: rgb(100, 171, 143);">1</span>) <span style="color: rgb(200, 143, 208);">return</span> <span style="color: rgb(184, 191, 198);">-</span><span style="color: rgb(100, 171, 143);">1</span>;</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">nwritten</span> <span style="color: rgb(184, 191, 198);">+=</span> <span style="color: rgb(184, 191, 198);">n</span>;</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">dictReleaseIterator</span>(<span style="color: rgb(184, 191, 198);">di</span>);</p>
<p>&nbsp;&nbsp;&nbsp;} <span style="color: rgb(200, 143, 208);">else</span> { <span style="color: rgb(218, 146, 74);">// 不支持的编码类型</span></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">redisPanic</span>(<span style="color: rgb(210, 107, 107);">"Unknown sorted set encoding"</span>);</p>
<p>&nbsp;&nbsp;&nbsp;}</p>
<p>&nbsp;} <span style="color: rgb(200, 143, 208);">else</span> <span style="color: rgb(200, 143, 208);">if</span> (<span style="color: rgb(184, 191, 198);">o-&gt;type</span> <span style="color: rgb(184, 191, 198);">==</span> <span style="color: rgb(184, 191, 198);">REDIS_HASH</span>) { <span style="color: rgb(218, 146, 74);">// 保存hash表</span></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">if</span> (<span style="color: rgb(184, 191, 198);">o-&gt;encoding</span> <span style="color: rgb(184, 191, 198);">==</span> <span style="color: rgb(184, 191, 198);">REDIS_ENCODING_ZIPLIST</span>) { <span style="color: rgb(218, 146, 74);">// 保存压缩列表的整个数组</span></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(28, 198, 133);">size_t</span> <span style="color: rgb(184, 191, 198);">l</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">ziplistBlobLen</span>((<span style="color: rgb(28, 198, 133);">unsigned</span> <span style="color: rgb(28, 198, 133);">char*</span>)<span style="color: rgb(184, 191, 198);">o-&gt;ptr</span>);</p>
<p>​</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">if</span> ((<span style="color: rgb(184, 191, 198);">n</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">rdbSaveRawString</span>(<span style="color: rgb(184, 191, 198);">rdb</span>,<span style="color: rgb(184, 191, 198);">o-&gt;ptr</span>,<span style="color: rgb(184, 191, 198);">l</span>)) <span style="color: rgb(184, 191, 198);">==</span> <span style="color: rgb(184, 191, 198);">-</span><span style="color: rgb(100, 171, 143);">1</span>) <span style="color: rgb(200, 143, 208);">return</span> <span style="color: rgb(184, 191, 198);">-</span><span style="color: rgb(100, 171, 143);">1</span>;</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">nwritten</span> <span style="color: rgb(184, 191, 198);">+=</span> <span style="color: rgb(184, 191, 198);">n</span>;</p>
<p>​</p>
<p>&nbsp;&nbsp;&nbsp;} <span style="color: rgb(200, 143, 208);">else</span> <span style="color: rgb(200, 143, 208);">if</span> (<span style="color: rgb(184, 191, 198);">o-&gt;encoding</span> <span style="color: rgb(184, 191, 198);">==</span> <span style="color: rgb(184, 191, 198);">REDIS_ENCODING_HT</span>) { <span style="color: rgb(218, 146, 74);">// 保存hash表中的entry</span></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">dictIterator</span> <span style="color: rgb(184, 191, 198);">*di</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">dictGetIterator</span>(<span style="color: rgb(184, 191, 198);">o-&gt;ptr</span>);</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">dictEntry</span> <span style="color: rgb(184, 191, 198);">*de</span>;</p>
<p>​</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">if</span> ((<span style="color: rgb(184, 191, 198);">n</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">rdbSaveLen</span>(<span style="color: rgb(184, 191, 198);">rdb</span>,<span style="color: rgb(184, 191, 198);">dictSize</span>((<span style="color: rgb(184, 191, 198);">dict*</span>)<span style="color: rgb(184, 191, 198);">o-&gt;ptr</span>))) <span style="color: rgb(184, 191, 198);">==</span> <span style="color: rgb(184, 191, 198);">-</span><span style="color: rgb(100, 171, 143);">1</span>) <span style="color: rgb(200, 143, 208);">return</span> <span style="color: rgb(184, 191, 198);">-</span><span style="color: rgb(100, 171, 143);">1</span>;</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">nwritten</span> <span style="color: rgb(184, 191, 198);">+=</span> <span style="color: rgb(184, 191, 198);">n</span>;</p>
<p>​</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">while</span>((<span style="color: rgb(184, 191, 198);">de</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">dictNext</span>(<span style="color: rgb(184, 191, 198);">di</span>)) <span style="color: rgb(184, 191, 198);">!=</span> <span style="color: rgb(184, 191, 198);">NULL</span>) {</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">robj</span> <span style="color: rgb(184, 191, 198);">*key</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">dictGetKey</span>(<span style="color: rgb(184, 191, 198);">de</span>);</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">robj</span> <span style="color: rgb(184, 191, 198);">*val</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">dictGetVal</span>(<span style="color: rgb(184, 191, 198);">de</span>);</p>
<p>​</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">if</span> ((<span style="color: rgb(184, 191, 198);">n</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">rdbSaveStringObject</span>(<span style="color: rgb(184, 191, 198);">rdb</span>,<span style="color: rgb(184, 191, 198);">key</span>)) <span style="color: rgb(184, 191, 198);">==</span> <span style="color: rgb(184, 191, 198);">-</span><span style="color: rgb(100, 171, 143);">1</span>) <span style="color: rgb(200, 143, 208);">return</span> <span style="color: rgb(184, 191, 198);">-</span><span style="color: rgb(100, 171, 143);">1</span>;</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">nwritten</span> <span style="color: rgb(184, 191, 198);">+=</span> <span style="color: rgb(184, 191, 198);">n</span>;</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">if</span> ((<span style="color: rgb(184, 191, 198);">n</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">rdbSaveStringObject</span>(<span style="color: rgb(184, 191, 198);">rdb</span>,<span style="color: rgb(184, 191, 198);">val</span>)) <span style="color: rgb(184, 191, 198);">==</span> <span style="color: rgb(184, 191, 198);">-</span><span style="color: rgb(100, 171, 143);">1</span>) <span style="color: rgb(200, 143, 208);">return</span> <span style="color: rgb(184, 191, 198);">-</span><span style="color: rgb(100, 171, 143);">1</span>;</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">nwritten</span> <span style="color: rgb(184, 191, 198);">+=</span> <span style="color: rgb(184, 191, 198);">n</span>;</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">dictReleaseIterator</span>(<span style="color: rgb(184, 191, 198);">di</span>);</p>
<p>&nbsp;&nbsp;&nbsp;} <span style="color: rgb(200, 143, 208);">else</span> {</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">redisPanic</span>(<span style="color: rgb(210, 107, 107);">"Unknown hash encoding"</span>);</p>
<p>&nbsp;&nbsp;&nbsp;}</p>
<p>​</p>
<p>&nbsp;} <span style="color: rgb(200, 143, 208);">else</span> {</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">redisPanic</span>(<span style="color: rgb(210, 107, 107);">"Unknown object type"</span>);</p>
<p>&nbsp;}</p>
<p>&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">return</span> <span style="color: rgb(184, 191, 198);">nwritten</span>;</p>
<p>}</p>
<p><br></p></p>
</body>
</html>