<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
</head>
<body>
<h1>Redis 深度分析系列五</h1>
<p>2022-07-03T19:58:50.174+0800</p>
<p><p>前面我们详细介绍了ae事件驱动框架的原理：根据操作系统类型，选择合适的多路复用器框架。同时也详细介绍了事件循环执行的流程：aeProcessEvents（）函数。本节我们来看看 Redis 基于ae事件循环下的请求响应整体流程的实现。</p>
<p><strong>anetTcpServer 函数</strong></p>
<p>该函数用于初始化服务端套接字，熟悉C语言的网络编程的朋友应该熟悉该流程：</p>
<ol>
 <li>创建服务端套接字 Socket</li>
 <li>绑定本地地址</li>
 <li>开始监听</li>
</ol>
<p>本函数亦是按照该流程创建，其中：anetCreateSocket 函数 和 anetListen 函数为通用函数，根据传入参数调用函数库完成socket创建和监听，可以复用Unix套接字与Socket套接字。描述如下。</p>
<p><span style="color: rgb(28, 198, 133);">int</span> <span style="color: rgb(141, 141, 240);">anetTcpServer</span>(<span style="color: rgb(28, 198, 133);">char</span> <span style="color: rgb(28, 198, 133);">*</span><span style="color: rgb(184, 191, 198);">err</span>, <span style="color: rgb(28, 198, 133);">int</span> <span style="color: rgb(184, 191, 198);">port</span>, <span style="color: rgb(28, 198, 133);">char</span> <span style="color: rgb(28, 198, 133);">*</span><span style="color: rgb(184, 191, 198);">bindaddr</span>)</p>
<p>{</p>
<p>&nbsp;&nbsp;<span style="color: rgb(28, 198, 133);">int</span> <span style="color: rgb(184, 191, 198);">s</span>;</p>
<p>&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">struct</span> <span style="color: rgb(141, 141, 240);">sockaddr_in</span> <span style="color: rgb(141, 141, 240);">sa</span>;</p>
<p>​</p>
<p>&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">if</span> ((<span style="color: rgb(184, 191, 198);">s</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">anetCreateSocket</span>(<span style="color: rgb(184, 191, 198);">err</span>,<span style="color: rgb(184, 191, 198);">AF_INET</span>)) <span style="color: rgb(184, 191, 198);">==</span> <span style="color: rgb(184, 191, 198);">ANET_ERR</span>) <span style="color: rgb(218, 146, 74);">// 创建 AF_INET 协议，为 TCP IP 协议</span></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">return</span> <span style="color: rgb(184, 191, 198);">ANET_ERR</span>;</p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">memset</span>(<span style="color: rgb(184, 191, 198);">&amp;sa</span>,<span style="color: rgb(100, 171, 143);">0</span>,<span style="color: rgb(200, 143, 208);">sizeof</span>(<span style="color: rgb(184, 191, 198);">sa</span>));</p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">sa</span>.<span style="color: rgb(184, 191, 198);">sin_family</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">AF_INET</span>;</p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">sa</span>.<span style="color: rgb(184, 191, 198);">sin_port</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">htons</span>(<span style="color: rgb(184, 191, 198);">port</span>); <span style="color: rgb(218, 146, 74);">// 设置端口。h为host，n为net，s为short，也即将本机字节序转为网络字节序（注：网络字节序用大端序）</span></p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">sa</span>.<span style="color: rgb(184, 191, 198);">sin_addr</span>.<span style="color: rgb(184, 191, 198);">s_addr</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">htonl</span>(<span style="color: rgb(184, 191, 198);">INADDR_ANY</span>); <span style="color: rgb(218, 146, 74);">// 设置监听地址，INADDR_ANY 表示监听所有网卡对应port端口的数据，也即 0.0.0.0</span></p>
<p>&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">if</span> (<span style="color: rgb(184, 191, 198);">bindaddr</span> <span style="color: rgb(184, 191, 198);">&amp;&amp;</span> <span style="color: rgb(184, 191, 198);">inet_aton</span>(<span style="color: rgb(184, 191, 198);">bindaddr</span>, <span style="color: rgb(184, 191, 198);">&amp;sa</span>.<span style="color: rgb(184, 191, 198);">sin_addr</span>) <span style="color: rgb(184, 191, 198);">==</span> <span style="color: rgb(100, 171, 143);">0</span>) { <span style="color: rgb(218, 146, 74);">// 绑定地址</span></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">anetSetError</span>(<span style="color: rgb(184, 191, 198);">err</span>, <span style="color: rgb(210, 107, 107);">"invalid bind address"</span>);</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">close</span>(<span style="color: rgb(184, 191, 198);">s</span>);</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">return</span> <span style="color: rgb(184, 191, 198);">ANET_ERR</span>;</p>
<p>&nbsp;}</p>
<p>&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">if</span> (<span style="color: rgb(184, 191, 198);">anetListen</span>(<span style="color: rgb(184, 191, 198);">err</span>,<span style="color: rgb(184, 191, 198);">s</span>,(<span style="color: rgb(200, 143, 208);">struct</span> <span style="color: rgb(141, 141, 240);">sockaddr</span><span style="color: rgb(184, 191, 198);">*</span>)<span style="color: rgb(184, 191, 198);">&amp;sa</span>,<span style="color: rgb(200, 143, 208);">sizeof</span>(<span style="color: rgb(184, 191, 198);">sa</span>)) <span style="color: rgb(184, 191, 198);">==</span> <span style="color: rgb(184, 191, 198);">ANET_ERR</span>) <span style="color: rgb(218, 146, 74);">// 开始监听来自客户端的连接，此时如果产生TCP连接，那么将会进行TCP三次握手，并将握手成功的客户端放入backlog队列</span></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">return</span> <span style="color: rgb(184, 191, 198);">ANET_ERR</span>;</p>
<p>&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">return</span> <span style="color: rgb(184, 191, 198);">s</span>;</p>
<p>}</p>
<p>​</p>
<p><span style="color: rgb(218, 146, 74);">// 根据 domain 指定的协议簇创建socketfd</span></p>
<p><span style="color: rgb(200, 143, 208);">static</span> <span style="color: rgb(28, 198, 133);">int</span> <span style="color: rgb(141, 141, 240);">anetCreateSocket</span>(<span style="color: rgb(28, 198, 133);">char</span> <span style="color: rgb(28, 198, 133);">*</span><span style="color: rgb(184, 191, 198);">err</span>, <span style="color: rgb(28, 198, 133);">int</span> <span style="color: rgb(184, 191, 198);">domain</span>) {</p>
<p>&nbsp;&nbsp;<span style="color: rgb(28, 198, 133);">int</span> <span style="color: rgb(184, 191, 198);">s</span>, <span style="color: rgb(184, 191, 198);">on</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(100, 171, 143);">1</span>;</p>
<p>&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">if</span> ((<span style="color: rgb(184, 191, 198);">s</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">socket</span>(<span style="color: rgb(184, 191, 198);">domain</span>, <span style="color: rgb(184, 191, 198);">SOCK_STREAM</span>, <span style="color: rgb(100, 171, 143);">0</span>)) <span style="color: rgb(184, 191, 198);">==</span> <span style="color: rgb(184, 191, 198);">-</span><span style="color: rgb(100, 171, 143);">1</span>) { <span style="color: rgb(218, 146, 74);">// 创建domain协议簇中的流协议，也即TCP协议</span></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">anetSetError</span>(<span style="color: rgb(184, 191, 198);">err</span>, <span style="color: rgb(210, 107, 107);">"creating socket: %s"</span>, <span style="color: rgb(184, 191, 198);">strerror</span>(<span style="color: rgb(184, 191, 198);">errno</span>));</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">return</span> <span style="color: rgb(184, 191, 198);">ANET_ERR</span>;</p>
<p>&nbsp;}</p>
<p>&nbsp;&nbsp;<span style="color: rgb(218, 146, 74);">// 设置socket属性：SOL_SOCKET表示在socket套接字上设置属性，SO_REUSEADDR 表示允许REDIS进程复用绑定地址。用于 redis 基准测试使用</span></p>
<p>&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">if</span> (<span style="color: rgb(184, 191, 198);">setsockopt</span>(<span style="color: rgb(184, 191, 198);">s</span>, <span style="color: rgb(184, 191, 198);">SOL_SOCKET</span>, <span style="color: rgb(184, 191, 198);">SO_REUSEADDR</span>, <span style="color: rgb(184, 191, 198);">&amp;on</span>, <span style="color: rgb(200, 143, 208);">sizeof</span>(<span style="color: rgb(184, 191, 198);">on</span>)) <span style="color: rgb(184, 191, 198);">==</span> <span style="color: rgb(184, 191, 198);">-</span><span style="color: rgb(100, 171, 143);">1</span>) {</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">anetSetError</span>(<span style="color: rgb(184, 191, 198);">err</span>, <span style="color: rgb(210, 107, 107);">"setsockopt SO_REUSEADDR: %s"</span>, <span style="color: rgb(184, 191, 198);">strerror</span>(<span style="color: rgb(184, 191, 198);">errno</span>));</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">return</span> <span style="color: rgb(184, 191, 198);">ANET_ERR</span>;</p>
<p>&nbsp;}</p>
<p>&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">return</span> <span style="color: rgb(184, 191, 198);">s</span>;</p>
<p>}</p>
<p>​</p>
<p><span style="color: rgb(218, 146, 74);">// 设置接收队列backlog的队列大小，同时允许socket可以接收客户端连接</span></p>
<p><span style="color: rgb(200, 143, 208);">static</span> <span style="color: rgb(28, 198, 133);">int</span> <span style="color: rgb(141, 141, 240);">anetListen</span>(<span style="color: rgb(28, 198, 133);">char</span> <span style="color: rgb(28, 198, 133);">*</span><span style="color: rgb(184, 191, 198);">err</span>, <span style="color: rgb(28, 198, 133);">int</span> <span style="color: rgb(184, 191, 198);">s</span>, <span style="color: rgb(200, 143, 208);">struct</span> <span style="color: rgb(141, 141, 240);">sockaddr</span> <span style="color: rgb(184, 191, 198);">*sa</span>, <span style="color: rgb(184, 191, 198);">socklen_t</span> <span style="color: rgb(184, 191, 198);">len</span>) {</p>
<p>&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">if</span> (<span style="color: rgb(184, 191, 198);">bind</span>(<span style="color: rgb(184, 191, 198);">s</span>,<span style="color: rgb(184, 191, 198);">sa</span>,<span style="color: rgb(184, 191, 198);">len</span>) <span style="color: rgb(184, 191, 198);">==</span> <span style="color: rgb(184, 191, 198);">-</span><span style="color: rgb(100, 171, 143);">1</span>) { <span style="color: rgb(218, 146, 74);">// 首先绑定地址</span></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">anetSetError</span>(<span style="color: rgb(184, 191, 198);">err</span>, <span style="color: rgb(210, 107, 107);">"bind: %s"</span>, <span style="color: rgb(184, 191, 198);">strerror</span>(<span style="color: rgb(184, 191, 198);">errno</span>));</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">close</span>(<span style="color: rgb(184, 191, 198);">s</span>);</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">return</span> <span style="color: rgb(184, 191, 198);">ANET_ERR</span>;</p>
<p>&nbsp;}</p>
<p>&nbsp;&nbsp;<span style="color: rgb(218, 146, 74);">// 随后设置backlog队列大小（backlog队列为TCP三次握手成功后放入的队列，用户态可以使用accept系统调用从中获取客户端连接）</span></p>
<p>&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">if</span> (<span style="color: rgb(184, 191, 198);">listen</span>(<span style="color: rgb(184, 191, 198);">s</span>, <span style="color: rgb(100, 171, 143);">511</span>) <span style="color: rgb(184, 191, 198);">==</span> <span style="color: rgb(184, 191, 198);">-</span><span style="color: rgb(100, 171, 143);">1</span>) {</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">anetSetError</span>(<span style="color: rgb(184, 191, 198);">err</span>, <span style="color: rgb(210, 107, 107);">"listen: %s"</span>, <span style="color: rgb(184, 191, 198);">strerror</span>(<span style="color: rgb(184, 191, 198);">errno</span>));</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">close</span>(<span style="color: rgb(184, 191, 198);">s</span>);</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">return</span> <span style="color: rgb(184, 191, 198);">ANET_ERR</span>;</p>
<p>&nbsp;}</p>
<p>&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">return</span> <span style="color: rgb(184, 191, 198);">ANET_OK</span>;</p>
<p>}</p>
<p><strong>anetUnixServer 函数</strong></p>
<p>在Linux中，存在unix socket，称之为unix套接字，该套接字我们可以观察Linux内核源码：将不会进入TCP协议栈来处理数据，它将根据socket的函数指针在内存中构建一个伪服务端和客户端，然后在其中实现socket的功能，由于不走协议栈，所以处理速度很快，所以我们说：unix socket 是利用 socket 来实现的进程之间通讯的一种手段，仅此而已，笔者将会在后面详细分析其中的源码给读者解惑~（很快，下周吧~）。这里我们需要指定：协议簇为AF_LOCAL。源码描述如下。</p>
<p><span style="color: rgb(28, 198, 133);">int</span> <span style="color: rgb(141, 141, 240);">anetUnixServer</span>(<span style="color: rgb(28, 198, 133);">char</span> <span style="color: rgb(28, 198, 133);">*</span><span style="color: rgb(184, 191, 198);">err</span>, <span style="color: rgb(28, 198, 133);">char</span> <span style="color: rgb(28, 198, 133);">*</span><span style="color: rgb(184, 191, 198);">path</span>, <span style="color: rgb(184, 191, 198);">mode_t</span> <span style="color: rgb(184, 191, 198);">perm</span>)</p>
<p>{</p>
<p>&nbsp;&nbsp;<span style="color: rgb(28, 198, 133);">int</span> <span style="color: rgb(184, 191, 198);">s</span>;</p>
<p>&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">struct</span> <span style="color: rgb(141, 141, 240);">sockaddr_un</span> <span style="color: rgb(141, 141, 240);">sa</span>;</p>
<p>&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">if</span> ((<span style="color: rgb(184, 191, 198);">s</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">anetCreateSocket</span>(<span style="color: rgb(184, 191, 198);">err</span>,<span style="color: rgb(184, 191, 198);">AF_LOCAL</span>)) <span style="color: rgb(184, 191, 198);">==</span> <span style="color: rgb(184, 191, 198);">ANET_ERR</span>) <span style="color: rgb(218, 146, 74);">// 创建server socket</span></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">return</span> <span style="color: rgb(184, 191, 198);">ANET_ERR</span>;</p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">memset</span>(<span style="color: rgb(184, 191, 198);">&amp;sa</span>,<span style="color: rgb(100, 171, 143);">0</span>,<span style="color: rgb(200, 143, 208);">sizeof</span>(<span style="color: rgb(184, 191, 198);">sa</span>)); <span style="color: rgb(218, 146, 74);">// 初始化sockaddr_un，第二参数指明将其中的值初始化为0</span></p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">sa</span>.<span style="color: rgb(184, 191, 198);">sun_family</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">AF_LOCAL</span>;</p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">strncpy</span>(<span style="color: rgb(184, 191, 198);">sa</span>.<span style="color: rgb(184, 191, 198);">sun_path</span>,<span style="color: rgb(184, 191, 198);">path</span>,<span style="color: rgb(200, 143, 208);">sizeof</span>(<span style="color: rgb(184, 191, 198);">sa</span>.<span style="color: rgb(184, 191, 198);">sun_path</span>)<span style="color: rgb(184, 191, 198);">-</span><span style="color: rgb(100, 171, 143);">1</span>); <span style="color: rgb(218, 146, 74);">// 将绑定路径设置为sun_path（unix 协议需要通过path来标记server 路径，我们可以通过该路径来找到server，也即抽象了ip和端口设置）</span></p>
<p>&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">if</span> (<span style="color: rgb(184, 191, 198);">anetListen</span>(<span style="color: rgb(184, 191, 198);">err</span>,<span style="color: rgb(184, 191, 198);">s</span>,(<span style="color: rgb(200, 143, 208);">struct</span> <span style="color: rgb(141, 141, 240);">sockaddr</span><span style="color: rgb(184, 191, 198);">*</span>)<span style="color: rgb(184, 191, 198);">&amp;sa</span>,<span style="color: rgb(200, 143, 208);">sizeof</span>(<span style="color: rgb(184, 191, 198);">sa</span>)) <span style="color: rgb(184, 191, 198);">==</span> <span style="color: rgb(184, 191, 198);">ANET_ERR</span>) <span style="color: rgb(218, 146, 74);">// 开始监听并设置接收队列大小</span></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">return</span> <span style="color: rgb(184, 191, 198);">ANET_ERR</span>;</p>
<p>&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">if</span> (<span style="color: rgb(184, 191, 198);">perm</span>) <span style="color: rgb(218, 146, 74);">// 如果设置权限，那么根据perm值，设置path的权限</span></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">chmod</span>(<span style="color: rgb(184, 191, 198);">sa</span>.<span style="color: rgb(184, 191, 198);">sun_path</span>, <span style="color: rgb(184, 191, 198);">perm</span>);</p>
<p>&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">return</span> <span style="color: rgb(184, 191, 198);">s</span>;</p>
<p>}</p>
<p><strong>acceptTcpHandler 函数</strong></p>
<p>该函数将在server socket接收到客户端连接时，回调其中首先通过anetTcpAccept函数接收来自客户端的连接，然后调用acceptCommonHandler函数完成客户端socket的处理。源码描述如下。</p>
<p><span style="color: rgb(218, 146, 74);">// 前面描述的initServer()函数代码，将acceptTcpHandler函数注册到打开监听的server socket fd上，当多路复用器发现有客户端连接时，将会在ae处理函数中回调该函数</span></p>
<p><span style="color: rgb(200, 143, 208);">if</span> (<span style="color: rgb(184, 191, 198);">server</span>.<span style="color: rgb(184, 191, 198);">ipfd</span> <span style="color: rgb(184, 191, 198);">&gt;</span> <span style="color: rgb(100, 171, 143);">0</span> <span style="color: rgb(184, 191, 198);">&amp;&amp;</span> <span style="color: rgb(184, 191, 198);">aeCreateFileEvent</span>(<span style="color: rgb(184, 191, 198);">server</span>.<span style="color: rgb(184, 191, 198);">el</span>,<span style="color: rgb(184, 191, 198);">server</span>.<span style="color: rgb(184, 191, 198);">ipfd</span>,<span style="color: rgb(184, 191, 198);">AE_READABLE</span>,</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">acceptTcpHandler</span>,<span style="color: rgb(184, 191, 198);">NULL</span>) <span style="color: rgb(184, 191, 198);">==</span> <span style="color: rgb(184, 191, 198);">AE_ERR</span>) <span style="color: rgb(184, 191, 198);">redisPanic</span>(<span style="color: rgb(210, 107, 107);">"Unrecoverable error creating </span><a href="http://server.ipfd" target="_blank" style="color: rgb(210, 107, 107);">server.ipfd</a><span style="color: rgb(210, 107, 107);"> file event."</span>);</p>
<p>​</p>
<p><span style="color: rgb(28, 198, 133);">void</span> <span style="color: rgb(141, 141, 240);">acceptTcpHandler</span>(<span style="color: rgb(184, 191, 198);">aeEventLoop</span> <span style="color: rgb(184, 191, 198);">*el</span>, <span style="color: rgb(28, 198, 133);">int</span> <span style="color: rgb(184, 191, 198);">fd</span>, <span style="color: rgb(28, 198, 133);">void</span> <span style="color: rgb(28, 198, 133);">*</span><span style="color: rgb(184, 191, 198);">privdata</span>, <span style="color: rgb(28, 198, 133);">int</span> <span style="color: rgb(184, 191, 198);">mask</span>) {</p>
<p>&nbsp;&nbsp;<span style="color: rgb(28, 198, 133);">int</span> <span style="color: rgb(184, 191, 198);">cport</span>, <span style="color: rgb(184, 191, 198);">cfd</span>; <span style="color: rgb(218, 146, 74);">// 客户端端口和socket fd</span></p>
<p>&nbsp;&nbsp;<span style="color: rgb(28, 198, 133);">char</span> <span style="color: rgb(184, 191, 198);">cip</span>[<span style="color: rgb(100, 171, 143);">128</span>]; <span style="color: rgb(218, 146, 74);">// 客户端 ip </span></p>
<p>&nbsp;&nbsp;<span style="color: rgb(218, 146, 74);">// 为了避免编译器警告无用参数，所以这里将其使用 ((void) V)假装使用了一下</span></p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">REDIS_NOTUSED</span>(<span style="color: rgb(184, 191, 198);">el</span>);</p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">REDIS_NOTUSED</span>(<span style="color: rgb(184, 191, 198);">mask</span>);</p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">REDIS_NOTUSED</span>(<span style="color: rgb(184, 191, 198);">privdata</span>);</p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">cfd</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">anetTcpAccept</span>(<span style="color: rgb(184, 191, 198);">server</span>.<span style="color: rgb(184, 191, 198);">neterr</span>, <span style="color: rgb(184, 191, 198);">fd</span>, <span style="color: rgb(184, 191, 198);">cip</span>, <span style="color: rgb(184, 191, 198);">&amp;cport</span>); <span style="color: rgb(218, 146, 74);">// 接收客户端连接</span></p>
<p>&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">if</span> (<span style="color: rgb(184, 191, 198);">cfd</span> <span style="color: rgb(184, 191, 198);">==</span> <span style="color: rgb(184, 191, 198);">AE_ERR</span>) {</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">redisLog</span>(<span style="color: rgb(184, 191, 198);">REDIS_WARNING</span>,<span style="color: rgb(210, 107, 107);">"Accepting client connection: %s"</span>, <span style="color: rgb(184, 191, 198);">server</span>.<span style="color: rgb(184, 191, 198);">neterr</span>);</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">return</span>;</p>
<p>&nbsp;}</p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">redisLog</span>(<span style="color: rgb(184, 191, 198);">REDIS_VERBOSE</span>,<span style="color: rgb(210, 107, 107);">"Accepted %s:%d"</span>, <span style="color: rgb(184, 191, 198);">cip</span>, <span style="color: rgb(184, 191, 198);">cport</span>);</p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">acceptCommonHandler</span>(<span style="color: rgb(184, 191, 198);">cfd</span>); <span style="color: rgb(218, 146, 74);">// 处理客户端连接</span></p>
<p>}</p>
<p>​</p>
<p><span style="color: rgb(218, 146, 74);">// 调用 anetGenericAccept 函数完成接收</span></p>
<p><span style="color: rgb(28, 198, 133);">int</span> <span style="color: rgb(141, 141, 240);">anetTcpAccept</span>(<span style="color: rgb(28, 198, 133);">char</span> <span style="color: rgb(28, 198, 133);">*</span><span style="color: rgb(184, 191, 198);">err</span>, <span style="color: rgb(28, 198, 133);">int</span> <span style="color: rgb(184, 191, 198);">s</span>, <span style="color: rgb(28, 198, 133);">char</span> <span style="color: rgb(28, 198, 133);">*</span><span style="color: rgb(184, 191, 198);">ip</span>, <span style="color: rgb(28, 198, 133);">int</span> <span style="color: rgb(28, 198, 133);">*</span><span style="color: rgb(184, 191, 198);">port</span>) {</p>
<p>&nbsp;&nbsp;<span style="color: rgb(28, 198, 133);">int</span> <span style="color: rgb(184, 191, 198);">fd</span>;</p>
<p>&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">struct</span> <span style="color: rgb(141, 141, 240);">sockaddr_in</span> <span style="color: rgb(141, 141, 240);">sa</span>;</p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">socklen_t</span> <span style="color: rgb(184, 191, 198);">salen</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(200, 143, 208);">sizeof</span>(<span style="color: rgb(184, 191, 198);">sa</span>);</p>
<p>&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">if</span> ((<span style="color: rgb(184, 191, 198);">fd</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">anetGenericAccept</span>(<span style="color: rgb(184, 191, 198);">err</span>,<span style="color: rgb(184, 191, 198);">s</span>,(<span style="color: rgb(200, 143, 208);">struct</span> <span style="color: rgb(141, 141, 240);">sockaddr</span><span style="color: rgb(184, 191, 198);">*</span>)<span style="color: rgb(184, 191, 198);">&amp;sa</span>,<span style="color: rgb(184, 191, 198);">&amp;salen</span>)) <span style="color: rgb(184, 191, 198);">==</span> <span style="color: rgb(184, 191, 198);">ANET_ERR</span>)</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">return</span> <span style="color: rgb(184, 191, 198);">ANET_ERR</span>;</p>
<p>&nbsp;&nbsp;<span style="color: rgb(218, 146, 74);">// 复制ip和port（这里需要处理字节序~）</span></p>
<p>&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">if</span> (<span style="color: rgb(184, 191, 198);">ip</span>) <span style="color: rgb(184, 191, 198);">strcpy</span>(<span style="color: rgb(184, 191, 198);">ip</span>,<span style="color: rgb(184, 191, 198);">inet_ntoa</span>(<span style="color: rgb(184, 191, 198);">sa</span>.<span style="color: rgb(184, 191, 198);">sin_addr</span>));</p>
<p>&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">if</span> (<span style="color: rgb(184, 191, 198);">port</span>) <span style="color: rgb(184, 191, 198);">*port</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">ntohs</span>(<span style="color: rgb(184, 191, 198);">sa</span>.<span style="color: rgb(184, 191, 198);">sin_port</span>);</p>
<p>&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">return</span> <span style="color: rgb(184, 191, 198);">fd</span>;</p>
<p>}</p>
<p>​</p>
<p><span style="color: rgb(218, 146, 74);">// 循环调用系统调用accept接收客户端连接，这里唯一的继续条件：EINTR（Interrupted system call ），表示系统调用被中断，此时可以继续重试获取客户端连接</span></p>
<p><span style="color: rgb(200, 143, 208);">static</span> <span style="color: rgb(28, 198, 133);">int</span> <span style="color: rgb(141, 141, 240);">anetGenericAccept</span>(<span style="color: rgb(28, 198, 133);">char</span> <span style="color: rgb(28, 198, 133);">*</span><span style="color: rgb(184, 191, 198);">err</span>, <span style="color: rgb(28, 198, 133);">int</span> <span style="color: rgb(184, 191, 198);">s</span>, <span style="color: rgb(200, 143, 208);">struct</span> <span style="color: rgb(141, 141, 240);">sockaddr</span> <span style="color: rgb(184, 191, 198);">*sa</span>, <span style="color: rgb(184, 191, 198);">socklen_t</span> <span style="color: rgb(184, 191, 198);">*len</span>) {</p>
<p>&nbsp;&nbsp;<span style="color: rgb(28, 198, 133);">int</span> <span style="color: rgb(184, 191, 198);">fd</span>;</p>
<p>&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">while</span>(<span style="color: rgb(100, 171, 143);">1</span>) {</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">fd</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">accept</span>(<span style="color: rgb(184, 191, 198);">s</span>,<span style="color: rgb(184, 191, 198);">sa</span>,<span style="color: rgb(184, 191, 198);">len</span>); <span style="color: rgb(218, 146, 74);">// 成功读取后，由Linux 内核完成 sockaddr *sa 设置 </span></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">if</span> (<span style="color: rgb(184, 191, 198);">fd</span> <span style="color: rgb(184, 191, 198);">==</span> <span style="color: rgb(184, 191, 198);">-</span><span style="color: rgb(100, 171, 143);">1</span>) {</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">if</span> (<span style="color: rgb(184, 191, 198);">errno</span> <span style="color: rgb(184, 191, 198);">==</span> <span style="color: rgb(184, 191, 198);">EINTR</span>)</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">continue</span>;</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">else</span> {</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">anetSetError</span>(<span style="color: rgb(184, 191, 198);">err</span>, <span style="color: rgb(210, 107, 107);">"accept: %s"</span>, <span style="color: rgb(184, 191, 198);">strerror</span>(<span style="color: rgb(184, 191, 198);">errno</span>));</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">return</span> <span style="color: rgb(184, 191, 198);">ANET_ERR</span>;</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</p>
<p>&nbsp;&nbsp;&nbsp;}</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">break</span>;</p>
<p>&nbsp;}</p>
<p>&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">return</span> <span style="color: rgb(184, 191, 198);">fd</span>;</p>
<p>}</p>
<p><strong>acceptUnixHandler 函数</strong></p>
<p>该函数顾名思义，用于接收通过unix socket通讯的在同一台机器上的进程通讯。源码描述如下。</p>
<p><span style="color: rgb(28, 198, 133);">void</span> <span style="color: rgb(141, 141, 240);">acceptUnixHandler</span>(<span style="color: rgb(184, 191, 198);">aeEventLoop</span> <span style="color: rgb(184, 191, 198);">*el</span>, <span style="color: rgb(28, 198, 133);">int</span> <span style="color: rgb(184, 191, 198);">fd</span>, <span style="color: rgb(28, 198, 133);">void</span> <span style="color: rgb(28, 198, 133);">*</span><span style="color: rgb(184, 191, 198);">privdata</span>, <span style="color: rgb(28, 198, 133);">int</span> <span style="color: rgb(184, 191, 198);">mask</span>) {</p>
<p>&nbsp;&nbsp;<span style="color: rgb(28, 198, 133);">int</span> <span style="color: rgb(184, 191, 198);">cfd</span>;</p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">REDIS_NOTUSED</span>(<span style="color: rgb(184, 191, 198);">el</span>);</p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">REDIS_NOTUSED</span>(<span style="color: rgb(184, 191, 198);">mask</span>);</p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">REDIS_NOTUSED</span>(<span style="color: rgb(184, 191, 198);">privdata</span>);</p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">cfd</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">anetUnixAccept</span>(<span style="color: rgb(184, 191, 198);">server</span>.<span style="color: rgb(184, 191, 198);">neterr</span>, <span style="color: rgb(184, 191, 198);">fd</span>);</p>
<p>&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">if</span> (<span style="color: rgb(184, 191, 198);">cfd</span> <span style="color: rgb(184, 191, 198);">==</span> <span style="color: rgb(184, 191, 198);">AE_ERR</span>) {</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">redisLog</span>(<span style="color: rgb(184, 191, 198);">REDIS_WARNING</span>,<span style="color: rgb(210, 107, 107);">"Accepting client connection: %s"</span>, <span style="color: rgb(184, 191, 198);">server</span>.<span style="color: rgb(184, 191, 198);">neterr</span>);</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">return</span>;</p>
<p>&nbsp;}</p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">redisLog</span>(<span style="color: rgb(184, 191, 198);">REDIS_VERBOSE</span>,<span style="color: rgb(210, 107, 107);">"Accepted connection to %s"</span>, <span style="color: rgb(184, 191, 198);">server</span>.<span style="color: rgb(184, 191, 198);">unixsocket</span>);</p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">acceptCommonHandler</span>(<span style="color: rgb(184, 191, 198);">cfd</span>);</p>
<p>}</p>
<p>​</p>
<p><span style="color: rgb(218, 146, 74);">// 描述同acceptTcpHandler函数，除了不对port和ip处理，因为它没有~</span></p>
<p><span style="color: rgb(28, 198, 133);">int</span> <span style="color: rgb(141, 141, 240);">anetUnixAccept</span>(<span style="color: rgb(28, 198, 133);">char</span> <span style="color: rgb(28, 198, 133);">*</span><span style="color: rgb(184, 191, 198);">err</span>, <span style="color: rgb(28, 198, 133);">int</span> <span style="color: rgb(184, 191, 198);">s</span>) {</p>
<p>&nbsp;&nbsp;<span style="color: rgb(28, 198, 133);">int</span> <span style="color: rgb(184, 191, 198);">fd</span>;</p>
<p>&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">struct</span> <span style="color: rgb(141, 141, 240);">sockaddr_un</span> <span style="color: rgb(141, 141, 240);">sa</span>;</p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">socklen_t</span> <span style="color: rgb(184, 191, 198);">salen</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(200, 143, 208);">sizeof</span>(<span style="color: rgb(184, 191, 198);">sa</span>);</p>
<p>&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">if</span> ((<span style="color: rgb(184, 191, 198);">fd</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">anetGenericAccept</span>(<span style="color: rgb(184, 191, 198);">err</span>,<span style="color: rgb(184, 191, 198);">s</span>,(<span style="color: rgb(200, 143, 208);">struct</span> <span style="color: rgb(141, 141, 240);">sockaddr</span><span style="color: rgb(184, 191, 198);">*</span>)<span style="color: rgb(184, 191, 198);">&amp;sa</span>,<span style="color: rgb(184, 191, 198);">&amp;salen</span>)) <span style="color: rgb(184, 191, 198);">==</span> <span style="color: rgb(184, 191, 198);">ANET_ERR</span>)</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">return</span> <span style="color: rgb(184, 191, 198);">ANET_ERR</span>;</p>
<p>​</p>
<p>&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">return</span> <span style="color: rgb(184, 191, 198);">fd</span>;</p>
<p>}</p>
<p><strong>acceptCommonHandler 函数</strong></p>
<p>该函数用于根据接收到的客户端socket创建描述客户端的元数据结构：redisClient。源码描述如下。</p>
<p><span style="color: rgb(200, 143, 208);">static</span> <span style="color: rgb(28, 198, 133);">void</span> <span style="color: rgb(141, 141, 240);">acceptCommonHandler</span>(<span style="color: rgb(28, 198, 133);">int</span> <span style="color: rgb(184, 191, 198);">fd</span>) {</p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">redisClient</span> <span style="color: rgb(184, 191, 198);">*c</span>;</p>
<p>&nbsp;&nbsp;<span style="color: rgb(218, 146, 74);">// 创建描述客户端的redis client结构</span></p>
<p>&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">if</span> ((<span style="color: rgb(184, 191, 198);">c</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">createClient</span>(<span style="color: rgb(184, 191, 198);">fd</span>)) <span style="color: rgb(184, 191, 198);">==</span> <span style="color: rgb(184, 191, 198);">NULL</span>) {</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">redisLog</span>(<span style="color: rgb(184, 191, 198);">REDIS_WARNING</span>,<span style="color: rgb(210, 107, 107);">"Error allocating resoures for the client"</span>);</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">close</span>(<span style="color: rgb(184, 191, 198);">fd</span>);</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">return</span>;</p>
<p>&nbsp;}</p>
<p>&nbsp;&nbsp;<span style="color: rgb(218, 146, 74);">// 若当前redis 客户端连接达到最大，那么向客户端写入错误信息</span></p>
<p>&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">if</span> (<span style="color: rgb(184, 191, 198);">listLength</span>(<span style="color: rgb(184, 191, 198);">server</span>.<span style="color: rgb(184, 191, 198);">clients</span>) <span style="color: rgb(184, 191, 198);">&gt;</span> <span style="color: rgb(184, 191, 198);">server</span>.<span style="color: rgb(184, 191, 198);">maxclients</span>) {</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(28, 198, 133);">char</span> <span style="color: rgb(28, 198, 133);">*</span><span style="color: rgb(184, 191, 198);">err</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(210, 107, 107);">"-ERR max number of clients reached\r\n"</span>;</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">if</span> (<span style="color: rgb(184, 191, 198);">write</span>(<span style="color: rgb(184, 191, 198);">c-&gt;fd</span>,<span style="color: rgb(184, 191, 198);">err</span>,<span style="color: rgb(184, 191, 198);">strlen</span>(<span style="color: rgb(184, 191, 198);">err</span>)) <span style="color: rgb(184, 191, 198);">==</span> <span style="color: rgb(184, 191, 198);">-</span><span style="color: rgb(100, 171, 143);">1</span>) { <span style="color: rgb(218, 146, 74);">// 注意：这里由于客户端是非阻塞调用，有可能由于客户端写缓冲区已经满了，写入失败，但是无所谓，这里只需要尽力发送即可&nbsp;</span></p>
<p>&nbsp;&nbsp;&nbsp;}</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">server</span>.<span style="color: rgb(184, 191, 198);">stat_rejected_conn++</span>; <span style="color: rgb(218, 146, 74);">// 记录拒绝处理的客户端数量 </span></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">freeClient</span>(<span style="color: rgb(184, 191, 198);">c</span>); <span style="color: rgb(218, 146, 74);">// 释放客户端元数据结构</span></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">return</span>;</p>
<p>&nbsp;}</p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">server</span>.<span style="color: rgb(184, 191, 198);">stat_numconnections++</span>;&nbsp;<span style="color: rgb(218, 146, 74);">// 记录完成连接数</span></p>
<p>}</p>
<p><strong>createClient 函数</strong></p>
<p><span style="color: rgb(184, 191, 198);">redisClient</span> <span style="color: rgb(184, 191, 198);">*</span><span style="color: rgb(141, 141, 240);">createClient</span>(<span style="color: rgb(28, 198, 133);">int</span> <span style="color: rgb(184, 191, 198);">fd</span>) {</p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">redisClient</span> <span style="color: rgb(184, 191, 198);">*c</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">zmalloc</span>(<span style="color: rgb(200, 143, 208);">sizeof</span>(<span style="color: rgb(184, 191, 198);">redisClient</span>)); <span style="color: rgb(218, 146, 74);">// 分配客户端结构内存</span></p>
<p>&nbsp;&nbsp;<span style="color: rgb(218, 146, 74);">// fd 为 -1时，表示在其他上下文中执行，比如：lua 脚本。fd 不为 -1，那么表明为一个有效的远程客户端连接，那么需要将其设置为非阻塞模式，同时将其注册读事件，当socket的读缓冲区中存在数据时，那么将会在ae事件循环过程中回调readQueryFromClient函数完成业务处理</span></p>
<p>&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">if</span> (<span style="color: rgb(184, 191, 198);">fd</span> <span style="color: rgb(184, 191, 198);">!=</span> <span style="color: rgb(184, 191, 198);">-</span><span style="color: rgb(100, 171, 143);">1</span>) {</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">anetNonBlock</span>(<span style="color: rgb(184, 191, 198);">NULL</span>,<span style="color: rgb(184, 191, 198);">fd</span>);</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">anetTcpNoDelay</span>(<span style="color: rgb(184, 191, 198);">NULL</span>,<span style="color: rgb(184, 191, 198);">fd</span>);</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">if</span> (<span style="color: rgb(184, 191, 198);">aeCreateFileEvent</span>(<span style="color: rgb(184, 191, 198);">server</span>.<span style="color: rgb(184, 191, 198);">el</span>,<span style="color: rgb(184, 191, 198);">fd</span>,<span style="color: rgb(184, 191, 198);">AE_READABLE</span>,</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">readQueryFromClient</span>, <span style="color: rgb(184, 191, 198);">c</span>) <span style="color: rgb(184, 191, 198);">==</span> <span style="color: rgb(184, 191, 198);">AE_ERR</span>) <span style="color: rgb(218, 146, 74);">// 将其注册到多路复用器中</span></p>
<p>&nbsp;&nbsp;&nbsp;{</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">close</span>(<span style="color: rgb(184, 191, 198);">fd</span>);</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">zfree</span>(<span style="color: rgb(184, 191, 198);">c</span>);</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">return</span> <span style="color: rgb(184, 191, 198);">NULL</span>;</p>
<p>&nbsp;&nbsp;&nbsp;}</p>
<p>&nbsp;}</p>
<p>&nbsp;&nbsp;<span style="color: rgb(218, 146, 74);">// 初始化 redis client 结构的初始值，具体值，将会在ae检测到客户端发送的数据时，回调readQueryFromClient函数完成设置</span></p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">selectDb</span>(<span style="color: rgb(184, 191, 198);">c</span>,<span style="color: rgb(100, 171, 143);">0</span>);</p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">c-&gt;fd</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">fd</span>;</p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">c-&gt;bufpos</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(100, 171, 143);">0</span>;</p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">c-&gt;querybuf</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">sdsempty</span>();</p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">c-&gt;querybuf_peak</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(100, 171, 143);">0</span>;</p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">c-&gt;reqtype</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(100, 171, 143);">0</span>;</p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">c-&gt;argc</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(100, 171, 143);">0</span>;</p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">c-&gt;argv</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">NULL</span>;</p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">c-&gt;cmd</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">c-&gt;lastcmd</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">NULL</span>;</p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">c-&gt;multibulklen</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(100, 171, 143);">0</span>;</p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">c-&gt;bulklen</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">-</span><span style="color: rgb(100, 171, 143);">1</span>;</p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">c-&gt;sentlen</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(100, 171, 143);">0</span>;</p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">c-&gt;flags</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(100, 171, 143);">0</span>;</p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">c-&gt;ctime</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">c-&gt;lastinteraction</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">server</span>.<span style="color: rgb(184, 191, 198);">unixtime</span>;</p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">c-&gt;authenticated</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(100, 171, 143);">0</span>;</p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">c-&gt;replstate</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">REDIS_REPL_NONE</span>;</p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">c-&gt;slave_listening_port</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(100, 171, 143);">0</span>;</p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">c-&gt;reply</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">listCreate</span>();</p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">c-&gt;reply_bytes</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(100, 171, 143);">0</span>;</p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">c-&gt;obuf_soft_limit_reached_time</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(100, 171, 143);">0</span>;</p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">listSetFreeMethod</span>(<span style="color: rgb(184, 191, 198);">c-&gt;reply</span>,<span style="color: rgb(184, 191, 198);">decrRefCount</span>);</p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">listSetDupMethod</span>(<span style="color: rgb(184, 191, 198);">c-&gt;reply</span>,<span style="color: rgb(184, 191, 198);">dupClientReplyValue</span>);</p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">c-&gt;bpop</span>.<span style="color: rgb(184, 191, 198);">keys</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">NULL</span>;</p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">c-&gt;bpop</span>.<span style="color: rgb(184, 191, 198);">count</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(100, 171, 143);">0</span>;</p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">c-&gt;bpop</span>.<span style="color: rgb(184, 191, 198);">timeout</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(100, 171, 143);">0</span>;</p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">c-&gt;bpop</span>.<span style="color: rgb(184, 191, 198);">target</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">NULL</span>;</p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">c-&gt;io_keys</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">listCreate</span>();</p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">c-&gt;watched_keys</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">listCreate</span>();</p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">listSetFreeMethod</span>(<span style="color: rgb(184, 191, 198);">c-&gt;io_keys</span>,<span style="color: rgb(184, 191, 198);">decrRefCount</span>);</p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">c-&gt;pubsub_channels</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">dictCreate</span>(<span style="color: rgb(184, 191, 198);">&amp;setDictType</span>,<span style="color: rgb(184, 191, 198);">NULL</span>);</p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">c-&gt;pubsub_patterns</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">listCreate</span>();</p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">listSetFreeMethod</span>(<span style="color: rgb(184, 191, 198);">c-&gt;pubsub_patterns</span>,<span style="color: rgb(184, 191, 198);">decrRefCount</span>);</p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">listSetMatchMethod</span>(<span style="color: rgb(184, 191, 198);">c-&gt;pubsub_patterns</span>,<span style="color: rgb(184, 191, 198);">listMatchObjects</span>);</p>
<p>&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">if</span> (<span style="color: rgb(184, 191, 198);">fd</span> <span style="color: rgb(184, 191, 198);">!=</span> <span style="color: rgb(184, 191, 198);">-</span><span style="color: rgb(100, 171, 143);">1</span>) <span style="color: rgb(184, 191, 198);">listAddNodeTail</span>(<span style="color: rgb(184, 191, 198);">server</span>.<span style="color: rgb(184, 191, 198);">clients</span>,<span style="color: rgb(184, 191, 198);">c</span>); <span style="color: rgb(218, 146, 74);">// 将客户端添加到客户端列表末尾</span></p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">initClientMultiState</span>(<span style="color: rgb(184, 191, 198);">c</span>);</p>
<p>&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">return</span> <span style="color: rgb(184, 191, 198);">c</span>;</p>
<p>}</p>
<p><strong>readQueryFromClient 函数</strong></p>
<p>该函数将在客户端发送数据到socket读缓冲区时，由多路复用器检测到，然后ae事件循环调用该函数完成具体业务处理。可以看到这里将会把客户端数据读入querybuf，然后调用processInputBuffer函数完成命令的处理。源码描述如下。</p>
<p><span style="color: rgb(28, 198, 133);">void</span> <span style="color: rgb(141, 141, 240);">readQueryFromClient</span>(<span style="color: rgb(184, 191, 198);">aeEventLoop</span> <span style="color: rgb(184, 191, 198);">*el</span>, <span style="color: rgb(28, 198, 133);">int</span> <span style="color: rgb(184, 191, 198);">fd</span>, <span style="color: rgb(28, 198, 133);">void</span> <span style="color: rgb(28, 198, 133);">*</span><span style="color: rgb(184, 191, 198);">privdata</span>, <span style="color: rgb(28, 198, 133);">int</span> <span style="color: rgb(184, 191, 198);">mask</span>) {</p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">redisClient</span> <span style="color: rgb(184, 191, 198);">*c</span> <span style="color: rgb(184, 191, 198);">=</span> (<span style="color: rgb(184, 191, 198);">redisClient*</span>) <span style="color: rgb(184, 191, 198);">privdata</span>;</p>
<p>&nbsp;&nbsp;<span style="color: rgb(28, 198, 133);">int</span> <span style="color: rgb(184, 191, 198);">nread</span>, <span style="color: rgb(184, 191, 198);">readlen</span>;</p>
<p>&nbsp;&nbsp;<span style="color: rgb(28, 198, 133);">size_t</span> <span style="color: rgb(184, 191, 198);">qblen</span>;</p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">REDIS_NOTUSED</span>(<span style="color: rgb(184, 191, 198);">el</span>);</p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">REDIS_NOTUSED</span>(<span style="color: rgb(184, 191, 198);">mask</span>);</p>
<p>​</p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">server</span>.<span style="color: rgb(184, 191, 198);">current_client</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">c</span>;</p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">readlen</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">REDIS_IOBUF_LEN</span>;</p>
<p>&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">if</span> (<span style="color: rgb(184, 191, 198);">c-&gt;reqtype</span> <span style="color: rgb(184, 191, 198);">==</span> <span style="color: rgb(184, 191, 198);">REDIS_REQ_MULTIBULK</span> <span style="color: rgb(184, 191, 198);">&amp;&amp;</span> <span style="color: rgb(184, 191, 198);">c-&gt;multibulklen</span> <span style="color: rgb(184, 191, 198);">&amp;&amp;</span> <span style="color: rgb(184, 191, 198);">c-&gt;bulklen</span> <span style="color: rgb(184, 191, 198);">!=</span> <span style="color: rgb(184, 191, 198);">-</span><span style="color: rgb(100, 171, 143);">1</span></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">&amp;&amp;</span> <span style="color: rgb(184, 191, 198);">c-&gt;bulklen</span> <span style="color: rgb(184, 191, 198);">&gt;=</span> <span style="color: rgb(184, 191, 198);">REDIS_MBULK_BIG_ARG</span>)</p>
<p>&nbsp;{</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(28, 198, 133);">int</span> <span style="color: rgb(184, 191, 198);">remaining</span> <span style="color: rgb(184, 191, 198);">=</span> (<span style="color: rgb(28, 198, 133);">unsigned</span>)(<span style="color: rgb(184, 191, 198);">c-&gt;bulklen+</span><span style="color: rgb(100, 171, 143);">2</span>)<span style="color: rgb(184, 191, 198);">-sdslen</span>(<span style="color: rgb(184, 191, 198);">c-&gt;querybuf</span>);</p>
<p>​</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">if</span> (<span style="color: rgb(184, 191, 198);">remaining</span> <span style="color: rgb(184, 191, 198);">&lt;</span> <span style="color: rgb(184, 191, 198);">readlen</span>) <span style="color: rgb(184, 191, 198);">readlen</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">remaining</span>;</p>
<p>&nbsp;}</p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">qblen</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">sdslen</span>(<span style="color: rgb(184, 191, 198);">c-&gt;querybuf</span>);</p>
<p>&nbsp;&nbsp;<span style="color: rgb(218, 146, 74);">// 准备查询缓冲区，并读取客户端数据</span></p>
<p>&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">if</span> (<span style="color: rgb(184, 191, 198);">c-&gt;querybuf_peak</span> <span style="color: rgb(184, 191, 198);">&lt;</span> <span style="color: rgb(184, 191, 198);">qblen</span>) <span style="color: rgb(184, 191, 198);">c-&gt;querybuf_peak</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">qblen</span>;</p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">c-&gt;querybuf</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">sdsMakeRoomFor</span>(<span style="color: rgb(184, 191, 198);">c-&gt;querybuf</span>, <span style="color: rgb(184, 191, 198);">readlen</span>);</p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">nread</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">read</span>(<span style="color: rgb(184, 191, 198);">fd</span>, <span style="color: rgb(184, 191, 198);">c-&gt;querybuf+qblen</span>, <span style="color: rgb(184, 191, 198);">readlen</span>);</p>
<p>&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">if</span> (<span style="color: rgb(184, 191, 198);">nread</span> <span style="color: rgb(184, 191, 198);">==</span> <span style="color: rgb(184, 191, 198);">-</span><span style="color: rgb(100, 171, 143);">1</span>) { <span style="color: rgb(218, 146, 74);">// 读取失败</span></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">if</span> (<span style="color: rgb(184, 191, 198);">errno</span> <span style="color: rgb(184, 191, 198);">==</span> <span style="color: rgb(184, 191, 198);">EAGAIN</span>) {</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">nread</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(100, 171, 143);">0</span>;</p>
<p>&nbsp;&nbsp;&nbsp;} <span style="color: rgb(200, 143, 208);">else</span> {</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">redisLog</span>(<span style="color: rgb(184, 191, 198);">REDIS_VERBOSE</span>, <span style="color: rgb(210, 107, 107);">"Reading from client: %s"</span>,<span style="color: rgb(184, 191, 198);">strerror</span>(<span style="color: rgb(184, 191, 198);">errno</span>));</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">freeClient</span>(<span style="color: rgb(184, 191, 198);">c</span>);</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">return</span>;</p>
<p>&nbsp;&nbsp;&nbsp;}</p>
<p>&nbsp;} <span style="color: rgb(200, 143, 208);">else</span> <span style="color: rgb(200, 143, 208);">if</span> (<span style="color: rgb(184, 191, 198);">nread</span> <span style="color: rgb(184, 191, 198);">==</span> <span style="color: rgb(100, 171, 143);">0</span>) { <span style="color: rgb(218, 146, 74);">// 客户端关闭了连接</span></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">redisLog</span>(<span style="color: rgb(184, 191, 198);">REDIS_VERBOSE</span>, <span style="color: rgb(210, 107, 107);">"Client closed connection"</span>);</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">freeClient</span>(<span style="color: rgb(184, 191, 198);">c</span>);</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">return</span>;</p>
<p>&nbsp;}</p>
<p>&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">if</span> (<span style="color: rgb(184, 191, 198);">nread</span>) { <span style="color: rgb(218, 146, 74);">// 读取到数据后，增加SDS的长度</span></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">sdsIncrLen</span>(<span style="color: rgb(184, 191, 198);">c-&gt;querybuf</span>,<span style="color: rgb(184, 191, 198);">nread</span>);</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">c-&gt;lastinteraction</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">server</span>.<span style="color: rgb(184, 191, 198);">unixtime</span>;</p>
<p>&nbsp;} <span style="color: rgb(200, 143, 208);">else</span> {</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">server</span>.<span style="color: rgb(184, 191, 198);">current_client</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">NULL</span>;</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">return</span>;</p>
<p>&nbsp;}</p>
<p>&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">if</span> (<span style="color: rgb(184, 191, 198);">sdslen</span>(<span style="color: rgb(184, 191, 198);">c-&gt;querybuf</span>) <span style="color: rgb(184, 191, 198);">&gt;</span> <span style="color: rgb(184, 191, 198);">server</span>.<span style="color: rgb(184, 191, 198);">client_max_querybuf_len</span>) { <span style="color: rgb(218, 146, 74);">// 查询缓冲区超过设置的最大值，此时为非法状态，那么释放占用内存，并打印日志</span></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">sds</span> <span style="color: rgb(184, 191, 198);">ci</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">getClientInfoString</span>(<span style="color: rgb(184, 191, 198);">c</span>), <span style="color: rgb(184, 191, 198);">bytes</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">sdsempty</span>();</p>
<p>​</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">bytes</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">sdscatrepr</span>(<span style="color: rgb(184, 191, 198);">bytes</span>,<span style="color: rgb(184, 191, 198);">c-&gt;querybuf</span>,<span style="color: rgb(100, 171, 143);">64</span>);</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">redisLog</span>(<span style="color: rgb(184, 191, 198);">REDIS_WARNING</span>,<span style="color: rgb(210, 107, 107);">"Closing client that reached max query buffer length: %s (qbuf initial bytes: %s)"</span>, <span style="color: rgb(184, 191, 198);">ci</span>, <span style="color: rgb(184, 191, 198);">bytes</span>);</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">sdsfree</span>(<span style="color: rgb(184, 191, 198);">ci</span>);</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">sdsfree</span>(<span style="color: rgb(184, 191, 198);">bytes</span>);</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">freeClient</span>(<span style="color: rgb(184, 191, 198);">c</span>);</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">return</span>;</p>
<p>&nbsp;}</p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">processInputBuffer</span>(<span style="color: rgb(184, 191, 198);">c</span>); <span style="color: rgb(218, 146, 74);">// 处理客户端数据</span></p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">server</span>.<span style="color: rgb(184, 191, 198);">current_client</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">NULL</span>;</p>
<p>}</p>
<p><strong>processInputBuffer 函数</strong></p>
<p>该函数将会处理客户端传递过来的命令。源码描述如下。</p>
<p><span style="color: rgb(28, 198, 133);">void</span> <span style="color: rgb(141, 141, 240);">processInputBuffer</span>(<span style="color: rgb(184, 191, 198);">redisClient</span> <span style="color: rgb(184, 191, 198);">*c</span>) {</p>
<p>&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">while</span>(<span style="color: rgb(184, 191, 198);">sdslen</span>(<span style="color: rgb(184, 191, 198);">c-&gt;querybuf</span>)) {</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">if</span> (<span style="color: rgb(184, 191, 198);">c-&gt;flags</span> <span style="color: rgb(184, 191, 198);">&amp;</span> <span style="color: rgb(184, 191, 198);">REDIS_BLOCKED</span>) <span style="color: rgb(200, 143, 208);">return</span>; <span style="color: rgb(218, 146, 74);">// 如果客户端正在处理其他事情，则立即中止处理，表示处理阻塞</span></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">if</span> (<span style="color: rgb(184, 191, 198);">c-&gt;flags</span> <span style="color: rgb(184, 191, 198);">&amp;</span> <span style="color: rgb(184, 191, 198);">REDIS_CLOSE_AFTER_REPLY</span>) <span style="color: rgb(200, 143, 208);">return</span>; <span style="color: rgb(218, 146, 74);">// 表示在向客户端写入响应信息后将立即关闭连接，设置了这个标志后不处理客户端的剩余命令</span></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">if</span> (<span style="color: rgb(184, 191, 198);">!c-&gt;reqtype</span>) { <span style="color: rgb(218, 146, 74);">// 不确定的请求类型，那么根据第一个查询缓冲区是否为 * 设置请求类型（REDIS_REQ_INLINE 单个请求，REDIS_REQ_MULTIBULK 多个请求）</span></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">if</span> (<span style="color: rgb(184, 191, 198);">c-&gt;querybuf</span>[<span style="color: rgb(100, 171, 143);">0</span>] <span style="color: rgb(184, 191, 198);">==</span> <span style="color: rgb(210, 107, 107);">'*'</span>) {</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">c-&gt;reqtype</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">REDIS_REQ_MULTIBULK</span>;</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} <span style="color: rgb(200, 143, 208);">else</span> {</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">c-&gt;reqtype</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">REDIS_REQ_INLINE</span>;</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</p>
<p>&nbsp;&nbsp;&nbsp;}</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(218, 146, 74);">// 处理查询缓冲区数据（也即切割缓冲区中的数据，生成：argc和argv）</span></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">if</span> (<span style="color: rgb(184, 191, 198);">c-&gt;reqtype</span> <span style="color: rgb(184, 191, 198);">==</span> <span style="color: rgb(184, 191, 198);">REDIS_REQ_INLINE</span>) {</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">if</span> (<span style="color: rgb(184, 191, 198);">processInlineBuffer</span>(<span style="color: rgb(184, 191, 198);">c</span>) <span style="color: rgb(184, 191, 198);">!=</span> <span style="color: rgb(184, 191, 198);">REDIS_OK</span>) <span style="color: rgb(200, 143, 208);">break</span>;</p>
<p>&nbsp;&nbsp;&nbsp;} <span style="color: rgb(200, 143, 208);">else</span> <span style="color: rgb(200, 143, 208);">if</span> (<span style="color: rgb(184, 191, 198);">c-&gt;reqtype</span> <span style="color: rgb(184, 191, 198);">==</span> <span style="color: rgb(184, 191, 198);">REDIS_REQ_MULTIBULK</span>) {</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">if</span> (<span style="color: rgb(184, 191, 198);">processMultibulkBuffer</span>(<span style="color: rgb(184, 191, 198);">c</span>) <span style="color: rgb(184, 191, 198);">!=</span> <span style="color: rgb(184, 191, 198);">REDIS_OK</span>) <span style="color: rgb(200, 143, 208);">break</span>;</p>
<p>&nbsp;&nbsp;&nbsp;} <span style="color: rgb(200, 143, 208);">else</span> {</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">redisPanic</span>(<span style="color: rgb(210, 107, 107);">"Unknown request type"</span>);</p>
<p>&nbsp;&nbsp;&nbsp;}</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">if</span> (<span style="color: rgb(184, 191, 198);">c-&gt;argc</span> <span style="color: rgb(184, 191, 198);">==</span> <span style="color: rgb(100, 171, 143);">0</span>) { <span style="color: rgb(218, 146, 74);">// 不存在参数，那么重置客户端（清理内存，并重新等待下一次发送的命令）</span></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">resetClient</span>(<span style="color: rgb(184, 191, 198);">c</span>);</p>
<p>&nbsp;&nbsp;&nbsp;} <span style="color: rgb(200, 143, 208);">else</span> {</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">if</span> (<span style="color: rgb(184, 191, 198);">processCommand</span>(<span style="color: rgb(184, 191, 198);">c</span>) <span style="color: rgb(184, 191, 198);">==</span> <span style="color: rgb(184, 191, 198);">REDIS_OK</span>) <span style="color: rgb(218, 146, 74);">// 调用相应命令处理客户端请求</span></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">resetClient</span>(<span style="color: rgb(184, 191, 198);">c</span>);</p>
<p>&nbsp;&nbsp;&nbsp;}</p>
<p>&nbsp;}</p>
<p>}</p>
<p><strong>resetClient 函数</strong></p>
<p>该函数重置部分redisClient结构变量值，同时释放argv占用的内存，准备下一次客户端发送命令并处理。源码如下。</p>
<p><span style="color: rgb(28, 198, 133);">void</span> <span style="color: rgb(141, 141, 240);">resetClient</span>(<span style="color: rgb(184, 191, 198);">redisClient</span> <span style="color: rgb(184, 191, 198);">*c</span>) {</p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">freeClientArgv</span>(<span style="color: rgb(184, 191, 198);">c</span>);</p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">c-&gt;reqtype</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(100, 171, 143);">0</span>;</p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">c-&gt;multibulklen</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(100, 171, 143);">0</span>;</p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">c-&gt;bulklen</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">-</span><span style="color: rgb(100, 171, 143);">1</span>;</p>
<p>&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">if</span> (<span style="color: rgb(184, 191, 198);">!</span>(<span style="color: rgb(184, 191, 198);">c-&gt;flags</span> <span style="color: rgb(184, 191, 198);">&amp;</span> <span style="color: rgb(184, 191, 198);">REDIS_MULTI</span>)) <span style="color: rgb(184, 191, 198);">c-&gt;flags</span> <span style="color: rgb(184, 191, 198);">&amp;=</span> (<span style="color: rgb(184, 191, 198);">~REDIS_ASKING</span>);</p>
<p>}</p>
<p><strong>processCommand 函数</strong></p>
<p>该函数被调用时，那么redis已经读取客户端发送的整个命令，参数在客户端 argv 与argc 变量中。该函数将执行客户端发送的命令。如果该返回1，则客户端仍然保持连接并且有效，调用方可以执行其他操作，如果该函数返回0，客户端应该被销毁。源码描述如下。</p>
<p><span style="color: rgb(28, 198, 133);">int</span> <span style="color: rgb(141, 141, 240);">processCommand</span>(<span style="color: rgb(184, 191, 198);">redisClient</span> <span style="color: rgb(184, 191, 198);">*c</span>) {</p>
<p>&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">if</span> (<span style="color: rgb(184, 191, 198);">!strcasecmp</span>(<span style="color: rgb(184, 191, 198);">c-&gt;argv</span>[<span style="color: rgb(100, 171, 143);">0</span>]<span style="color: rgb(184, 191, 198);">-&gt;ptr</span>,<span style="color: rgb(210, 107, 107);">"quit"</span>)) { <span style="color: rgb(218, 146, 74);">// 退出连接命令</span></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">addReply</span>(<span style="color: rgb(184, 191, 198);">c</span>,<span style="color: rgb(184, 191, 198);">shared</span>.<span style="color: rgb(184, 191, 198);">ok</span>);</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">c-&gt;flags</span> <span style="color: rgb(184, 191, 198);">|=</span> <span style="color: rgb(184, 191, 198);">REDIS_CLOSE_AFTER_REPLY</span>;</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">return</span> <span style="color: rgb(184, 191, 198);">REDIS_ERR</span>;</p>
<p>&nbsp;}</p>
<p>&nbsp;&nbsp;<span style="color: rgb(218, 146, 74);">// 查找客户端请求执行的命令，若命令不存在，那么将错误信息发送给客户端</span></p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">c-&gt;cmd</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">c-&gt;lastcmd</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">lookupCommand</span>(<span style="color: rgb(184, 191, 198);">c-&gt;argv</span>[<span style="color: rgb(100, 171, 143);">0</span>]<span style="color: rgb(184, 191, 198);">-&gt;ptr</span>);</p>
<p>&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">if</span> (<span style="color: rgb(184, 191, 198);">!c-&gt;cmd</span>) {</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">addReplyErrorFormat</span>(<span style="color: rgb(184, 191, 198);">c</span>,<span style="color: rgb(210, 107, 107);">"unknown command '%s'"</span>,</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span style="color: rgb(28, 198, 133);">char*</span>)<span style="color: rgb(184, 191, 198);">c-&gt;argv</span>[<span style="color: rgb(100, 171, 143);">0</span>]<span style="color: rgb(184, 191, 198);">-&gt;ptr</span>);</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">return</span> <span style="color: rgb(184, 191, 198);">REDIS_OK</span>;</p>
<p>&nbsp;} <span style="color: rgb(200, 143, 208);">else</span> <span style="color: rgb(200, 143, 208);">if</span> ((<span style="color: rgb(184, 191, 198);">c-&gt;cmd-&gt;arity</span> <span style="color: rgb(184, 191, 198);">&gt;</span> <span style="color: rgb(100, 171, 143);">0</span> <span style="color: rgb(184, 191, 198);">&amp;&amp;</span> <span style="color: rgb(184, 191, 198);">c-&gt;cmd-&gt;arity</span> <span style="color: rgb(184, 191, 198);">!=</span> <span style="color: rgb(184, 191, 198);">c-&gt;argc</span>) <span style="color: rgb(184, 191, 198);">||</span></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span style="color: rgb(184, 191, 198);">c-&gt;argc</span> <span style="color: rgb(184, 191, 198);">&lt;</span> <span style="color: rgb(184, 191, 198);">-c-&gt;cmd-&gt;arity</span>)) { <span style="color: rgb(218, 146, 74);">// 检测命令格式</span></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">addReplyErrorFormat</span>(<span style="color: rgb(184, 191, 198);">c</span>,<span style="color: rgb(210, 107, 107);">"wrong number of arguments for '%s' command"</span>,</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">c-&gt;cmd-&gt;name</span>);</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">return</span> <span style="color: rgb(184, 191, 198);">REDIS_OK</span>;</p>
<p>&nbsp;}</p>
<p>​</p>
<p>&nbsp;&nbsp;<span style="color: rgb(218, 146, 74);">// 检测客户端权限</span></p>
<p>&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">if</span> (<span style="color: rgb(184, 191, 198);">server</span>.<span style="color: rgb(184, 191, 198);">requirepass</span> <span style="color: rgb(184, 191, 198);">&amp;&amp;</span> <span style="color: rgb(184, 191, 198);">!c-&gt;authenticated</span> <span style="color: rgb(184, 191, 198);">&amp;&amp;</span> <span style="color: rgb(184, 191, 198);">c-&gt;cmd-&gt;proc</span> <span style="color: rgb(184, 191, 198);">!=</span> <span style="color: rgb(184, 191, 198);">authCommand</span>)</p>
<p>&nbsp;{</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">addReplyError</span>(<span style="color: rgb(184, 191, 198);">c</span>,<span style="color: rgb(210, 107, 107);">"operation not permitted"</span>);</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">return</span> <span style="color: rgb(184, 191, 198);">REDIS_OK</span>;</p>
<p>&nbsp;}</p>
<p>​</p>
<p>&nbsp;&nbsp;<span style="color: rgb(218, 146, 74);">// redis 达到最大占用内存，那么将oom信息发送给客户都安</span></p>
<p>&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">if</span> (<span style="color: rgb(184, 191, 198);">server</span>.<span style="color: rgb(184, 191, 198);">maxmemory</span>) {</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(28, 198, 133);">int</span> <span style="color: rgb(184, 191, 198);">retval</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">freeMemoryIfNeeded</span>();</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">if</span> ((<span style="color: rgb(184, 191, 198);">c-&gt;cmd-&gt;flags</span> <span style="color: rgb(184, 191, 198);">&amp;</span> <span style="color: rgb(184, 191, 198);">REDIS_CMD_DENYOOM</span>) <span style="color: rgb(184, 191, 198);">&amp;&amp;</span> <span style="color: rgb(184, 191, 198);">retval</span> <span style="color: rgb(184, 191, 198);">==</span> <span style="color: rgb(184, 191, 198);">REDIS_ERR</span>) {</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">addReply</span>(<span style="color: rgb(184, 191, 198);">c</span>, <span style="color: rgb(184, 191, 198);">shared</span>.<span style="color: rgb(184, 191, 198);">oomerr</span>);</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">return</span> <span style="color: rgb(184, 191, 198);">REDIS_OK</span>;</p>
<p>&nbsp;&nbsp;&nbsp;}</p>
<p>&nbsp;}</p>
<p>​</p>
<p>&nbsp;&nbsp;<span style="color: rgb(218, 146, 74);">// 如果磁盘存在问题，不要接受任何写命令</span></p>
<p>&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">if</span> (<span style="color: rgb(184, 191, 198);">server</span>.<span style="color: rgb(184, 191, 198);">stop_writes_on_bgsave_err</span> <span style="color: rgb(184, 191, 198);">&amp;&amp;</span></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">server</span>.<span style="color: rgb(184, 191, 198);">saveparamslen</span> <span style="color: rgb(184, 191, 198);">&gt;</span> <span style="color: rgb(100, 171, 143);">0</span></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">&amp;&amp;</span> <span style="color: rgb(184, 191, 198);">server</span>.<span style="color: rgb(184, 191, 198);">lastbgsave_status</span> <span style="color: rgb(184, 191, 198);">==</span> <span style="color: rgb(184, 191, 198);">REDIS_ERR</span> <span style="color: rgb(184, 191, 198);">&amp;&amp;</span></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">c-&gt;cmd-&gt;flags</span> <span style="color: rgb(184, 191, 198);">&amp;</span> <span style="color: rgb(184, 191, 198);">REDIS_CMD_WRITE</span>)</p>
<p>&nbsp;{</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">addReply</span>(<span style="color: rgb(184, 191, 198);">c</span>, <span style="color: rgb(184, 191, 198);">shared</span>.<span style="color: rgb(184, 191, 198);">bgsaveerr</span>);</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">return</span> <span style="color: rgb(184, 191, 198);">REDIS_OK</span>;</p>
<p>&nbsp;}</p>
<p>​</p>
<p>&nbsp;&nbsp;<span style="color: rgb(218, 146, 74);">// 哨兵模式的读模式，也不接受任何写命令</span></p>
<p>&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">if</span> (<span style="color: rgb(184, 191, 198);">server</span>.<span style="color: rgb(184, 191, 198);">masterhost</span> <span style="color: rgb(184, 191, 198);">&amp;&amp;</span> <span style="color: rgb(184, 191, 198);">server</span>.<span style="color: rgb(184, 191, 198);">repl_slave_ro</span> <span style="color: rgb(184, 191, 198);">&amp;&amp;</span></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">!</span>(<span style="color: rgb(184, 191, 198);">c-&gt;flags</span> <span style="color: rgb(184, 191, 198);">&amp;</span> <span style="color: rgb(184, 191, 198);">REDIS_MASTER</span>) <span style="color: rgb(184, 191, 198);">&amp;&amp;</span></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">c-&gt;cmd-&gt;flags</span> <span style="color: rgb(184, 191, 198);">&amp;</span> <span style="color: rgb(184, 191, 198);">REDIS_CMD_WRITE</span>)</p>
<p>&nbsp;{</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">addReply</span>(<span style="color: rgb(184, 191, 198);">c</span>, <span style="color: rgb(184, 191, 198);">shared</span>.<span style="color: rgb(184, 191, 198);">roslaveerr</span>);</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">return</span> <span style="color: rgb(184, 191, 198);">REDIS_OK</span>;</p>
<p>&nbsp;}</p>
<p>​</p>
<p>&nbsp;&nbsp;<span style="color: rgb(218, 146, 74);">// 只允许在发布/订阅上下文中订阅和取消订阅</span></p>
<p>&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">if</span> ((<span style="color: rgb(184, 191, 198);">dictSize</span>(<span style="color: rgb(184, 191, 198);">c-&gt;pubsub_channels</span>) <span style="color: rgb(184, 191, 198);">&gt;</span> <span style="color: rgb(100, 171, 143);">0</span> <span style="color: rgb(184, 191, 198);">||</span> <span style="color: rgb(184, 191, 198);">listLength</span>(<span style="color: rgb(184, 191, 198);">c-&gt;pubsub_patterns</span>) <span style="color: rgb(184, 191, 198);">&gt;</span> <span style="color: rgb(100, 171, 143);">0</span>)</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">&amp;&amp;</span> <span style="color: rgb(218, 146, 74);">// 命令执行函数必须是订阅相关命令</span></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">c-&gt;cmd-&gt;proc</span> <span style="color: rgb(184, 191, 198);">!=</span> <span style="color: rgb(184, 191, 198);">subscribeCommand</span> <span style="color: rgb(184, 191, 198);">&amp;&amp;</span></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">c-&gt;cmd-&gt;proc</span> <span style="color: rgb(184, 191, 198);">!=</span> <span style="color: rgb(184, 191, 198);">unsubscribeCommand</span> <span style="color: rgb(184, 191, 198);">&amp;&amp;</span></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">c-&gt;cmd-&gt;proc</span> <span style="color: rgb(184, 191, 198);">!=</span> <span style="color: rgb(184, 191, 198);">psubscribeCommand</span> <span style="color: rgb(184, 191, 198);">&amp;&amp;</span></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">c-&gt;cmd-&gt;proc</span> <span style="color: rgb(184, 191, 198);">!=</span> <span style="color: rgb(184, 191, 198);">punsubscribeCommand</span>) {</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">addReplyError</span>(<span style="color: rgb(184, 191, 198);">c</span>,<span style="color: rgb(210, 107, 107);">"only (P)SUBSCRIBE / (P)UNSUBSCRIBE / QUIT allowed in this context"</span>);</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">return</span> <span style="color: rgb(184, 191, 198);">REDIS_OK</span>;</p>
<p>&nbsp;}</p>
<p>&nbsp;&nbsp;<span style="color: rgb(218, 146, 74);">// 只有当slave-server-stale-data配置为 no 时，并且我们是一个与主库断开的slave时，才允许执行INFO和SLAVEOF 命令</span></p>
<p>&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">if</span> (<span style="color: rgb(184, 191, 198);">server</span>.<span style="color: rgb(184, 191, 198);">masterhost</span> <span style="color: rgb(184, 191, 198);">&amp;&amp;</span> <span style="color: rgb(184, 191, 198);">server</span>.<span style="color: rgb(184, 191, 198);">repl_state</span> <span style="color: rgb(184, 191, 198);">!=</span> <span style="color: rgb(184, 191, 198);">REDIS_REPL_CONNECTED</span> <span style="color: rgb(184, 191, 198);">&amp;&amp;</span></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">server</span>.<span style="color: rgb(184, 191, 198);">repl_serve_stale_data</span> <span style="color: rgb(184, 191, 198);">==</span> <span style="color: rgb(100, 171, 143);">0</span> <span style="color: rgb(184, 191, 198);">&amp;&amp;</span></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">!</span>(<span style="color: rgb(184, 191, 198);">c-&gt;cmd-&gt;flags</span> <span style="color: rgb(184, 191, 198);">&amp;</span> <span style="color: rgb(184, 191, 198);">REDIS_CMD_STALE</span>))</p>
<p>&nbsp;{</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">addReply</span>(<span style="color: rgb(184, 191, 198);">c</span>, <span style="color: rgb(184, 191, 198);">shared</span>.<span style="color: rgb(184, 191, 198);">masterdownerr</span>);</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">return</span> <span style="color: rgb(184, 191, 198);">REDIS_OK</span>;</p>
<p>&nbsp;}</p>
<p>​</p>
<p>&nbsp;&nbsp;<span style="color: rgb(218, 146, 74);">// 服务器正在加载数据，不接受客户端请求</span></p>
<p>&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">if</span> (<span style="color: rgb(184, 191, 198);">server</span>.<span style="color: rgb(184, 191, 198);">loading</span> <span style="color: rgb(184, 191, 198);">&amp;&amp;</span> <span style="color: rgb(184, 191, 198);">!</span>(<span style="color: rgb(184, 191, 198);">c-&gt;cmd-&gt;flags</span> <span style="color: rgb(184, 191, 198);">&amp;</span> <span style="color: rgb(184, 191, 198);">REDIS_CMD_LOADING</span>)) {</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">addReply</span>(<span style="color: rgb(184, 191, 198);">c</span>, <span style="color: rgb(184, 191, 198);">shared</span>.<span style="color: rgb(184, 191, 198);">loadingerr</span>);</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">return</span> <span style="color: rgb(184, 191, 198);">REDIS_OK</span>;</p>
<p>&nbsp;}</p>
<p>​</p>
<p>&nbsp;&nbsp;<span style="color: rgb(218, 146, 74);">// lua脚本执行过慢，只允许执行带有REDIS_CMD_STALE标志的命令</span></p>
<p>&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">if</span> (<span style="color: rgb(184, 191, 198);">server</span>.<span style="color: rgb(184, 191, 198);">lua_timedout</span> <span style="color: rgb(184, 191, 198);">&amp;&amp;</span></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">c-&gt;cmd-&gt;proc</span> <span style="color: rgb(184, 191, 198);">!=</span> <span style="color: rgb(184, 191, 198);">authCommand</span> <span style="color: rgb(184, 191, 198);">&amp;&amp;</span></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">!</span>(<span style="color: rgb(184, 191, 198);">c-&gt;cmd-&gt;proc</span> <span style="color: rgb(184, 191, 198);">==</span> <span style="color: rgb(184, 191, 198);">shutdownCommand</span> <span style="color: rgb(184, 191, 198);">&amp;&amp;</span></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">c-&gt;argc</span> <span style="color: rgb(184, 191, 198);">==</span> <span style="color: rgb(100, 171, 143);">2</span> <span style="color: rgb(184, 191, 198);">&amp;&amp;</span></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">tolower</span>(((<span style="color: rgb(28, 198, 133);">char*</span>)<span style="color: rgb(184, 191, 198);">c-&gt;argv</span>[<span style="color: rgb(100, 171, 143);">1</span>]<span style="color: rgb(184, 191, 198);">-&gt;ptr</span>)[<span style="color: rgb(100, 171, 143);">0</span>]) <span style="color: rgb(184, 191, 198);">==</span> <span style="color: rgb(210, 107, 107);">'n'</span>) <span style="color: rgb(184, 191, 198);">&amp;&amp;</span></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">!</span>(<span style="color: rgb(184, 191, 198);">c-&gt;cmd-&gt;proc</span> <span style="color: rgb(184, 191, 198);">==</span> <span style="color: rgb(184, 191, 198);">scriptCommand</span> <span style="color: rgb(184, 191, 198);">&amp;&amp;</span></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">c-&gt;argc</span> <span style="color: rgb(184, 191, 198);">==</span> <span style="color: rgb(100, 171, 143);">2</span> <span style="color: rgb(184, 191, 198);">&amp;&amp;</span></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">tolower</span>(((<span style="color: rgb(28, 198, 133);">char*</span>)<span style="color: rgb(184, 191, 198);">c-&gt;argv</span>[<span style="color: rgb(100, 171, 143);">1</span>]<span style="color: rgb(184, 191, 198);">-&gt;ptr</span>)[<span style="color: rgb(100, 171, 143);">0</span>]) <span style="color: rgb(184, 191, 198);">==</span> <span style="color: rgb(210, 107, 107);">'k'</span>))</p>
<p>&nbsp;{</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">addReply</span>(<span style="color: rgb(184, 191, 198);">c</span>, <span style="color: rgb(184, 191, 198);">shared</span>.<span style="color: rgb(184, 191, 198);">slowscripterr</span>);</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">return</span> <span style="color: rgb(184, 191, 198);">REDIS_OK</span>;</p>
<p>&nbsp;}</p>
<p>​</p>
<p>&nbsp;&nbsp;<span style="color: rgb(218, 146, 74);">// 检测无误，那么执行命令</span></p>
<p>&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">if</span> (<span style="color: rgb(184, 191, 198);">c-&gt;flags</span> <span style="color: rgb(184, 191, 198);">&amp;</span> <span style="color: rgb(184, 191, 198);">REDIS_MULTI</span> <span style="color: rgb(184, 191, 198);">&amp;&amp;</span></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">c-&gt;cmd-&gt;proc</span> <span style="color: rgb(184, 191, 198);">!=</span> <span style="color: rgb(184, 191, 198);">execCommand</span> <span style="color: rgb(184, 191, 198);">&amp;&amp;</span> <span style="color: rgb(184, 191, 198);">c-&gt;cmd-&gt;proc</span> <span style="color: rgb(184, 191, 198);">!=</span> <span style="color: rgb(184, 191, 198);">discardCommand</span> <span style="color: rgb(184, 191, 198);">&amp;&amp;</span></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">c-&gt;cmd-&gt;proc</span> <span style="color: rgb(184, 191, 198);">!=</span> <span style="color: rgb(184, 191, 198);">multiCommand</span> <span style="color: rgb(184, 191, 198);">&amp;&amp;</span> <span style="color: rgb(184, 191, 198);">c-&gt;cmd-&gt;proc</span> <span style="color: rgb(184, 191, 198);">!=</span> <span style="color: rgb(184, 191, 198);">watchCommand</span>)</p>
<p>&nbsp;{ <span style="color: rgb(218, 146, 74);">// 执行 MULTI 命令，也即多操作命令</span></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">queueMultiCommand</span>(<span style="color: rgb(184, 191, 198);">c</span>);</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">addReply</span>(<span style="color: rgb(184, 191, 198);">c</span>,<span style="color: rgb(184, 191, 198);">shared</span>.<span style="color: rgb(184, 191, 198);">queued</span>);</p>
<p>&nbsp;} <span style="color: rgb(200, 143, 208);">else</span> { <span style="color: rgb(218, 146, 74);">// 执行单命令</span></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">call</span>(<span style="color: rgb(184, 191, 198);">c</span>,<span style="color: rgb(184, 191, 198);">REDIS_CALL_FULL</span>);</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">if</span> (<span style="color: rgb(184, 191, 198);">listLength</span>(<span style="color: rgb(184, 191, 198);">server</span>.<span style="color: rgb(184, 191, 198);">ready_keys</span>))</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">handleClientsBlockedOnLists</span>();</p>
<p>&nbsp;}</p>
<p>&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">return</span> <span style="color: rgb(184, 191, 198);">REDIS_OK</span>;</p>
<p>}</p>
<p><strong>lookupCommand 函数</strong></p>
<p>该函数用于从server.commands中获取到name指定的函数指针，并将其命令返回，而server.commands在server初始化时由redisCommandTable数组中定义。源码如下。</p>
<p><span style="color: rgb(218, 146, 74);">// 填充命令列表放入server.commands中</span></p>
<p><span style="color: rgb(200, 143, 208);">struct</span> <span style="color: rgb(141, 141, 240);">redisCommand</span> <span style="color: rgb(141, 141, 240);">redisCommandTable</span>[] <span style="color: rgb(184, 191, 198);">=</span> {...};</p>
<p><span style="color: rgb(28, 198, 133);">void</span> <span style="color: rgb(141, 141, 240);">populateCommandTable</span>(<span style="color: rgb(28, 198, 133);">void</span>) {</p>
<p>&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">for</span> (<span style="color: rgb(184, 191, 198);">j</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(100, 171, 143);">0</span>; <span style="color: rgb(184, 191, 198);">j</span> <span style="color: rgb(184, 191, 198);">&lt;</span> <span style="color: rgb(184, 191, 198);">numcommands</span>; <span style="color: rgb(184, 191, 198);">j++</span>) {</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">struct</span> <span style="color: rgb(141, 141, 240);">redisCommand</span> <span style="color: rgb(184, 191, 198);">*c</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">redisCommandTable+j</span>;</p>
<p>&nbsp;&nbsp;&nbsp;...</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">retval</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">dictAdd</span>(<span style="color: rgb(184, 191, 198);">server</span>.<span style="color: rgb(184, 191, 198);">commands</span>, <span style="color: rgb(184, 191, 198);">sdsnew</span>(<span style="color: rgb(184, 191, 198);">c-&gt;name</span>), <span style="color: rgb(184, 191, 198);">c</span>);</p>
<p>&nbsp;}</p>
<p>}</p>
<p>​</p>
<p><span style="color: rgb(200, 143, 208);">struct</span> <span style="color: rgb(141, 141, 240);">redisCommand</span> <span style="color: rgb(184, 191, 198);">*</span><span style="color: rgb(141, 141, 240);">lookupCommand</span>(<span style="color: rgb(184, 191, 198);">sds</span> <span style="color: rgb(184, 191, 198);">name</span>) {</p>
<p>&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">return</span> <span style="color: rgb(184, 191, 198);">dictFetchValue</span>(<span style="color: rgb(184, 191, 198);">server</span>.<span style="color: rgb(184, 191, 198);">commands</span>, <span style="color: rgb(184, 191, 198);">name</span>);</p>
<p>}</p>
<p>​</p>
<p><span style="color: rgb(28, 198, 133);">void</span> <span style="color: rgb(28, 198, 133);">*</span><span style="color: rgb(141, 141, 240);">dictFetchValue</span>(<span style="color: rgb(184, 191, 198);">dict</span> <span style="color: rgb(184, 191, 198);">*d</span>, <span style="color: rgb(200, 143, 208);">const</span> <span style="color: rgb(28, 198, 133);">void</span> <span style="color: rgb(28, 198, 133);">*</span><span style="color: rgb(184, 191, 198);">key</span>) {</p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">dictEntry</span> <span style="color: rgb(184, 191, 198);">*he</span>;</p>
<p>​</p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">he</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">dictFind</span>(<span style="color: rgb(184, 191, 198);">d</span>,<span style="color: rgb(184, 191, 198);">key</span>);</p>
<p>&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">return</span> <span style="color: rgb(184, 191, 198);">he</span> <span style="color: rgb(184, 191, 198);">?</span> <span style="color: rgb(184, 191, 198);">dictGetVal</span>(<span style="color: rgb(184, 191, 198);">he</span>) : <span style="color: rgb(184, 191, 198);">NULL</span>;</p>
<p>}</p>
<p><strong>queueMultiCommand 函数</strong></p>
<p>该函数用于将multi命令添加到multi队列中。源码如下。</p>
<p><span style="color: rgb(28, 198, 133);">void</span> <span style="color: rgb(141, 141, 240);">queueMultiCommand</span>(<span style="color: rgb(184, 191, 198);">redisClient</span> <span style="color: rgb(184, 191, 198);">*c</span>) {</p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">multiCmd</span> <span style="color: rgb(184, 191, 198);">*mc</span>;</p>
<p>&nbsp;&nbsp;<span style="color: rgb(28, 198, 133);">int</span> <span style="color: rgb(184, 191, 198);">j</span>;</p>
<p>&nbsp;&nbsp;<span style="color: rgb(218, 146, 74);">// 增加commands队列大小，并将redisClient 数据放入新增的一项multiCmd中</span></p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">c-&gt;mstate</span>.<span style="color: rgb(184, 191, 198);">commands</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">zrealloc</span>(<span style="color: rgb(184, 191, 198);">c-&gt;mstate</span>.<span style="color: rgb(184, 191, 198);">commands</span>,</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">sizeof</span>(<span style="color: rgb(184, 191, 198);">multiCmd</span>)<span style="color: rgb(184, 191, 198);">*</span>(<span style="color: rgb(184, 191, 198);">c-&gt;mstate</span>.<span style="color: rgb(184, 191, 198);">count+</span><span style="color: rgb(100, 171, 143);">1</span>));</p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">mc</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">c-&gt;mstate</span>.<span style="color: rgb(184, 191, 198);">commands+c-&gt;mstate</span>.<span style="color: rgb(184, 191, 198);">count</span>;</p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">mc-&gt;cmd</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">c-&gt;cmd</span>;</p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">mc-&gt;argc</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">c-&gt;argc</span>;</p>
<p>&nbsp;&nbsp;<span style="color: rgb(218, 146, 74);">// 将redisClient的argv复制到mc-&gt;argv中，因为multi命令执行与客户端redisClient结构再无关系</span></p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">mc-&gt;argv</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">zmalloc</span>(<span style="color: rgb(200, 143, 208);">sizeof</span>(<span style="color: rgb(184, 191, 198);">robj*</span>)<span style="color: rgb(184, 191, 198);">*c-&gt;argc</span>);</p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">memcpy</span>(<span style="color: rgb(184, 191, 198);">mc-&gt;argv</span>,<span style="color: rgb(184, 191, 198);">c-&gt;argv</span>,<span style="color: rgb(200, 143, 208);">sizeof</span>(<span style="color: rgb(184, 191, 198);">robj*</span>)<span style="color: rgb(184, 191, 198);">*c-&gt;argc</span>);</p>
<p>&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">for</span> (<span style="color: rgb(184, 191, 198);">j</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(100, 171, 143);">0</span>; <span style="color: rgb(184, 191, 198);">j</span> <span style="color: rgb(184, 191, 198);">&lt;</span> <span style="color: rgb(184, 191, 198);">c-&gt;argc</span>; <span style="color: rgb(184, 191, 198);">j++</span>)</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">incrRefCount</span>(<span style="color: rgb(184, 191, 198);">mc-&gt;argv</span>[<span style="color: rgb(184, 191, 198);">j</span>]);</p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">c-&gt;mstate</span>.<span style="color: rgb(184, 191, 198);">count++</span>;</p>
<p>}</p>
<p><strong>call 函数 </strong></p>
<p>该函数将调用c-&gt;cmd-&gt;proc(c)设置的函数完成客户端命令执行。源码描述如下。</p>
<p><span style="color: rgb(28, 198, 133);">void</span> <span style="color: rgb(141, 141, 240);">call</span>(<span style="color: rgb(184, 191, 198);">redisClient</span> <span style="color: rgb(184, 191, 198);">*c</span>, <span style="color: rgb(28, 198, 133);">int</span> <span style="color: rgb(184, 191, 198);">flags</span>) {</p>
<p>&nbsp;&nbsp;<span style="color: rgb(28, 198, 133);">long</span> <span style="color: rgb(28, 198, 133);">long</span> <span style="color: rgb(184, 191, 198);">dirty</span>, <span style="color: rgb(184, 191, 198);">start</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">ustime</span>(), <span style="color: rgb(184, 191, 198);">duration</span>;</p>
<p>&nbsp;...</p>
<p>&nbsp;&nbsp;<span style="color: rgb(218, 146, 74);">// 执行命令</span></p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">redisOpArrayInit</span>(<span style="color: rgb(184, 191, 198);">&amp;server</span>.<span style="color: rgb(184, 191, 198);">also_propagate</span>);</p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">dirty</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">server</span>.<span style="color: rgb(184, 191, 198);">dirty</span>; <span style="color: rgb(218, 146, 74);">// 保存服务器为脏状态，也即是否修改了内存数据</span></p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">c-&gt;cmd-&gt;proc</span>(<span style="color: rgb(184, 191, 198);">c</span>);</p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">dirty</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">server</span>.<span style="color: rgb(184, 191, 198);">dirty-dirty</span>; <span style="color: rgb(218, 146, 74);">// 看看执行完命令后，是否修改了内存数据</span></p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">duration</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">ustime</span>()<span style="color: rgb(184, 191, 198);">-start</span>; <span style="color: rgb(218, 146, 74);">// 记录命令执行时间</span></p>
<p>​</p>
<p>&nbsp;&nbsp;<span style="color: rgb(218, 146, 74);">// 当调用EVAL加载AOF时，我们不希望从Lua调用的命令影响慢日志或填充统计信息</span></p>
<p>&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">if</span> (<span style="color: rgb(184, 191, 198);">server</span>.<span style="color: rgb(184, 191, 198);">loading</span> <span style="color: rgb(184, 191, 198);">&amp;&amp;</span> <span style="color: rgb(184, 191, 198);">c-&gt;flags</span> <span style="color: rgb(184, 191, 198);">&amp;</span> <span style="color: rgb(184, 191, 198);">REDIS_LUA_CLIENT</span>)</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">flags</span> <span style="color: rgb(184, 191, 198);">&amp;=</span> <span style="color: rgb(184, 191, 198);">~</span>(<span style="color: rgb(184, 191, 198);">REDIS_CALL_SLOWLOG</span> <span style="color: rgb(184, 191, 198);">|</span> <span style="color: rgb(184, 191, 198);">REDIS_CALL_STATS</span>);</p>
<p>​</p>
<p>&nbsp;&nbsp;<span style="color: rgb(218, 146, 74);">// 记录慢操作日志</span></p>
<p>&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">if</span> (<span style="color: rgb(184, 191, 198);">flags</span> <span style="color: rgb(184, 191, 198);">&amp;</span> <span style="color: rgb(184, 191, 198);">REDIS_CALL_SLOWLOG</span>)</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">slowlogPushEntryIfNeeded</span>(<span style="color: rgb(184, 191, 198);">c-&gt;argv</span>,<span style="color: rgb(184, 191, 198);">c-&gt;argc</span>,<span style="color: rgb(184, 191, 198);">duration</span>);</p>
<p>&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">if</span> (<span style="color: rgb(184, 191, 198);">flags</span> <span style="color: rgb(184, 191, 198);">&amp;</span> <span style="color: rgb(184, 191, 198);">REDIS_CALL_STATS</span>) {</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">c-&gt;cmd-&gt;microseconds</span> <span style="color: rgb(184, 191, 198);">+=</span> <span style="color: rgb(184, 191, 198);">duration</span>;</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">c-&gt;cmd-&gt;calls++</span>;</p>
<p>&nbsp;}</p>
<p>&nbsp;&nbsp;<span style="color: rgb(218, 146, 74);">// 将命令复制到aof和slave复制队列</span></p>
<p>&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">if</span> (<span style="color: rgb(184, 191, 198);">flags</span> <span style="color: rgb(184, 191, 198);">&amp;</span> <span style="color: rgb(184, 191, 198);">REDIS_CALL_PROPAGATE</span>) {</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(28, 198, 133);">int</span> <span style="color: rgb(184, 191, 198);">flags</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">REDIS_PROPAGATE_NONE</span>;</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">if</span> (<span style="color: rgb(184, 191, 198);">c-&gt;cmd-&gt;flags</span> <span style="color: rgb(184, 191, 198);">&amp;</span> <span style="color: rgb(184, 191, 198);">REDIS_CMD_FORCE_REPLICATION</span>)</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">flags</span> <span style="color: rgb(184, 191, 198);">|=</span> <span style="color: rgb(184, 191, 198);">REDIS_PROPAGATE_REPL</span>;</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">if</span> (<span style="color: rgb(184, 191, 198);">dirty</span>)</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">flags</span> <span style="color: rgb(184, 191, 198);">|=</span> (<span style="color: rgb(184, 191, 198);">REDIS_PROPAGATE_REPL</span> <span style="color: rgb(184, 191, 198);">|</span> <span style="color: rgb(184, 191, 198);">REDIS_PROPAGATE_AOF</span>);</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">if</span> (<span style="color: rgb(184, 191, 198);">flags</span> <span style="color: rgb(184, 191, 198);">!=</span> <span style="color: rgb(184, 191, 198);">REDIS_PROPAGATE_NONE</span>)</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">propagate</span>(<span style="color: rgb(184, 191, 198);">c-&gt;cmd</span>,<span style="color: rgb(184, 191, 198);">c-&gt;db-&gt;id</span>,<span style="color: rgb(184, 191, 198);">c-&gt;argv</span>,<span style="color: rgb(184, 191, 198);">c-&gt;argc</span>,<span style="color: rgb(184, 191, 198);">flags</span>);</p>
<p>&nbsp;}</p>
<p>&nbsp;&nbsp;<span style="color: rgb(218, 146, 74);">// 诸如 LPUSH 或 BRPOPLPUSH 之类的命令可能传递额外的push命令</span></p>
<p>&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">if</span> (<span style="color: rgb(184, 191, 198);">server</span>.<span style="color: rgb(184, 191, 198);">also_propagate</span>.<span style="color: rgb(184, 191, 198);">numops</span>) {</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(28, 198, 133);">int</span> <span style="color: rgb(184, 191, 198);">j</span>;</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">redisOp</span> <span style="color: rgb(184, 191, 198);">*rop</span>;</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">for</span> (<span style="color: rgb(184, 191, 198);">j</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(100, 171, 143);">0</span>; <span style="color: rgb(184, 191, 198);">j</span> <span style="color: rgb(184, 191, 198);">&lt;</span> <span style="color: rgb(184, 191, 198);">server</span>.<span style="color: rgb(184, 191, 198);">also_propagate</span>.<span style="color: rgb(184, 191, 198);">numops</span>; <span style="color: rgb(184, 191, 198);">j++</span>) {</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">rop</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">&amp;server</span>.<span style="color: rgb(184, 191, 198);">also_propagate</span>.<span style="color: rgb(184, 191, 198);">ops</span>[<span style="color: rgb(184, 191, 198);">j</span>];</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">propagate</span>(<span style="color: rgb(184, 191, 198);">rop-&gt;cmd</span>, <span style="color: rgb(184, 191, 198);">rop-&gt;dbid</span>, <span style="color: rgb(184, 191, 198);">rop-&gt;argv</span>, <span style="color: rgb(184, 191, 198);">rop-&gt;argc</span>, <span style="color: rgb(184, 191, 198);">rop-&gt;target</span>);</p>
<p>&nbsp;&nbsp;&nbsp;}</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">redisOpArrayFree</span>(<span style="color: rgb(184, 191, 198);">&amp;server</span>.<span style="color: rgb(184, 191, 198);">also_propagate</span>);</p>
<p>&nbsp;}</p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">server</span>.<span style="color: rgb(184, 191, 198);">stat_numcommands++</span>;</p>
<p>}</p>
<p><strong>addReply 函数</strong></p>
<p>该函数用于将 robj *obj 的redis 对象写入客户端。这里我们先尝试写入缓冲区，失败后将robj放入reply列表，将会在sendReplyToClient函数中处理。源码如下。</p>
<p><span style="color: rgb(28, 198, 133);">void</span> <span style="color: rgb(141, 141, 240);">addReply</span>(<span style="color: rgb(184, 191, 198);">redisClient</span> <span style="color: rgb(184, 191, 198);">*c</span>, <span style="color: rgb(184, 191, 198);">robj</span> <span style="color: rgb(184, 191, 198);">*obj</span>) {</p>
<p>&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">if</span> (<span style="color: rgb(184, 191, 198);">prepareClientToWrite</span>(<span style="color: rgb(184, 191, 198);">c</span>) <span style="color: rgb(184, 191, 198);">!=</span> <span style="color: rgb(184, 191, 198);">REDIS_OK</span>) <span style="color: rgb(200, 143, 208);">return</span>;</p>
<p>&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">if</span> (<span style="color: rgb(184, 191, 198);">obj-&gt;encoding</span> <span style="color: rgb(184, 191, 198);">==</span> <span style="color: rgb(184, 191, 198);">REDIS_ENCODING_RAW</span>) { <span style="color: rgb(218, 146, 74);">// RAW 原始编码，那么将数据写入客户端的redis层面的写缓冲区中（ char buf[REDIS_REPLY_CHUNK_BYTES]）若写入失败，那么将其写入list *reply列表</span></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">if</span> (<span style="color: rgb(184, 191, 198);">_addReplyToBuffer</span>(<span style="color: rgb(184, 191, 198);">c</span>,<span style="color: rgb(184, 191, 198);">obj-&gt;ptr</span>,<span style="color: rgb(184, 191, 198);">sdslen</span>(<span style="color: rgb(184, 191, 198);">obj-&gt;ptr</span>)) <span style="color: rgb(184, 191, 198);">!=</span> <span style="color: rgb(184, 191, 198);">REDIS_OK</span>)</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">_addReplyObjectToList</span>(<span style="color: rgb(184, 191, 198);">c</span>,<span style="color: rgb(184, 191, 198);">obj</span>);</p>
<p>&nbsp;} <span style="color: rgb(200, 143, 208);">else</span> <span style="color: rgb(200, 143, 208);">if</span> (<span style="color: rgb(184, 191, 198);">obj-&gt;encoding</span> <span style="color: rgb(184, 191, 198);">==</span> <span style="color: rgb(184, 191, 198);">REDIS_ENCODING_INT</span>) { <span style="color: rgb(218, 146, 74);">// INT 整形编码，那么将其转为字符串后，写入缓冲区，同样写入失败后，将其放入list *reply列表</span></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">if</span> (<span style="color: rgb(184, 191, 198);">listLength</span>(<span style="color: rgb(184, 191, 198);">c-&gt;reply</span>) <span style="color: rgb(184, 191, 198);">==</span> <span style="color: rgb(100, 171, 143);">0</span> <span style="color: rgb(184, 191, 198);">&amp;&amp;</span> (<span style="color: rgb(200, 143, 208);">sizeof</span>(<span style="color: rgb(184, 191, 198);">c-&gt;buf</span>) <span style="color: rgb(184, 191, 198);">-</span> <span style="color: rgb(184, 191, 198);">c-&gt;bufpos</span>) <span style="color: rgb(184, 191, 198);">&gt;=</span> <span style="color: rgb(100, 171, 143);">32</span>) { <span style="color: rgb(218, 146, 74);">// reply列表为空，同时缓冲区中存在空间可以写入32个字符（这里32个字符为优化操作，如果缓冲区中有32个字节的空间（超过64位的整数可以用作字符串的最大字符数），这就避免解码对象，读者可以自行查看ll2string的代码）</span></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(28, 198, 133);">char</span> <span style="color: rgb(184, 191, 198);">buf</span>[<span style="color: rgb(100, 171, 143);">32</span>];</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(28, 198, 133);">int</span> <span style="color: rgb(184, 191, 198);">len</span>;</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">len</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">ll2string</span>(<span style="color: rgb(184, 191, 198);">buf</span>,<span style="color: rgb(200, 143, 208);">sizeof</span>(<span style="color: rgb(184, 191, 198);">buf</span>),(<span style="color: rgb(28, 198, 133);">long</span>)<span style="color: rgb(184, 191, 198);">obj-&gt;ptr</span>);</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">if</span> (<span style="color: rgb(184, 191, 198);">_addReplyToBuffer</span>(<span style="color: rgb(184, 191, 198);">c</span>,<span style="color: rgb(184, 191, 198);">buf</span>,<span style="color: rgb(184, 191, 198);">len</span>) <span style="color: rgb(184, 191, 198);">==</span> <span style="color: rgb(184, 191, 198);">REDIS_OK</span>) <span style="color: rgb(218, 146, 74);">// 由于预判了存在足够大的缓冲区，所以直接写入即可</span></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">return</span>;</p>
<p>&nbsp;&nbsp;&nbsp;}</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">obj</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">getDecodedObject</span>(<span style="color: rgb(184, 191, 198);">obj</span>); <span style="color: rgb(218, 146, 74);">// 否则解码对象，然后将其再次尝试添加到缓冲区，失败后将其添加到reply列表</span></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">if</span> (<span style="color: rgb(184, 191, 198);">_addReplyToBuffer</span>(<span style="color: rgb(184, 191, 198);">c</span>,<span style="color: rgb(184, 191, 198);">obj-&gt;ptr</span>,<span style="color: rgb(184, 191, 198);">sdslen</span>(<span style="color: rgb(184, 191, 198);">obj-&gt;ptr</span>)) <span style="color: rgb(184, 191, 198);">!=</span> <span style="color: rgb(184, 191, 198);">REDIS_OK</span>)</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">_addReplyObjectToList</span>(<span style="color: rgb(184, 191, 198);">c</span>,<span style="color: rgb(184, 191, 198);">obj</span>);</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">decrRefCount</span>(<span style="color: rgb(184, 191, 198);">obj</span>); <span style="color: rgb(218, 146, 74);">// obj写入成功，那么释放一个引用次数</span></p>
<p>&nbsp;} <span style="color: rgb(200, 143, 208);">else</span> {</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">redisPanic</span>(<span style="color: rgb(210, 107, 107);">"Wrong obj-&gt;encoding in addReply()"</span>);</p>
<p>&nbsp;}</p>
<p>}</p>
<p>​</p>
<p><span style="color: rgb(218, 146, 74);">// 检测客户端状态，并将客户端socket fd注册到多路复用器中，写函数为sendReplyToClient，当客户端fd的写缓冲区空闲时将会调用sendReplyToClient完成写入</span></p>
<p><span style="color: rgb(28, 198, 133);">int</span> <span style="color: rgb(141, 141, 240);">prepareClientToWrite</span>(<span style="color: rgb(184, 191, 198);">redisClient</span> <span style="color: rgb(184, 191, 198);">*c</span>) {</p>
<p>&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">if</span> (<span style="color: rgb(184, 191, 198);">c-&gt;flags</span> <span style="color: rgb(184, 191, 198);">&amp;</span> <span style="color: rgb(184, 191, 198);">REDIS_LUA_CLIENT</span>) <span style="color: rgb(200, 143, 208);">return</span> <span style="color: rgb(184, 191, 198);">REDIS_OK</span>;</p>
<p>&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">if</span> (<span style="color: rgb(184, 191, 198);">c-&gt;fd</span> <span style="color: rgb(184, 191, 198);">&lt;=</span> <span style="color: rgb(100, 171, 143);">0</span>) <span style="color: rgb(200, 143, 208);">return</span> <span style="color: rgb(184, 191, 198);">REDIS_ERR</span>; <span style="color: rgb(218, 146, 74);">// 虚拟客户端，比如LUA 脚本执行</span></p>
<p>&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">if</span> (<span style="color: rgb(184, 191, 198);">c-&gt;bufpos</span> <span style="color: rgb(184, 191, 198);">==</span> <span style="color: rgb(100, 171, 143);">0</span> <span style="color: rgb(184, 191, 198);">&amp;&amp;</span> <span style="color: rgb(184, 191, 198);">listLength</span>(<span style="color: rgb(184, 191, 198);">c-&gt;reply</span>) <span style="color: rgb(184, 191, 198);">==</span> <span style="color: rgb(100, 171, 143);">0</span> <span style="color: rgb(184, 191, 198);">&amp;&amp;</span></p>
<p>&nbsp;&nbsp;&nbsp;(<span style="color: rgb(184, 191, 198);">c-&gt;replstate</span> <span style="color: rgb(184, 191, 198);">==</span> <span style="color: rgb(184, 191, 198);">REDIS_REPL_NONE</span> <span style="color: rgb(184, 191, 198);">||</span></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">c-&gt;replstate</span> <span style="color: rgb(184, 191, 198);">==</span> <span style="color: rgb(184, 191, 198);">REDIS_REPL_ONLINE</span>) <span style="color: rgb(184, 191, 198);">&amp;&amp;</span></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">aeCreateFileEvent</span>(<span style="color: rgb(184, 191, 198);">server</span>.<span style="color: rgb(184, 191, 198);">el</span>, <span style="color: rgb(184, 191, 198);">c-&gt;fd</span>, <span style="color: rgb(184, 191, 198);">AE_WRITABLE</span>,</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">sendReplyToClient</span>, <span style="color: rgb(184, 191, 198);">c</span>) <span style="color: rgb(184, 191, 198);">==</span> <span style="color: rgb(184, 191, 198);">AE_ERR</span>) <span style="color: rgb(200, 143, 208);">return</span> <span style="color: rgb(184, 191, 198);">REDIS_ERR</span>;</p>
<p>&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">return</span> <span style="color: rgb(184, 191, 198);">REDIS_OK</span>;</p>
<p>}</p>
<p><strong>sendReplyToClient 函数</strong></p>
<p>该函数在ae时间循环中调用，当socket fd 写缓冲区空闲时调用，将redis的写缓冲区的数据和reply链表的数据写出（读者注意：这里需要写入的数据为redis写缓冲区和reply链表，而又由于fd的内核写缓冲区有限，所以有可能一次写入不成功，那么可以在下一次ae发现写缓冲区不为满状态时，再次由ae事件循环完成写出）。源码描述如下。</p>
<p><span style="color: rgb(28, 198, 133);">void</span> <span style="color: rgb(141, 141, 240);">sendReplyToClient</span>(<span style="color: rgb(184, 191, 198);">aeEventLoop</span> <span style="color: rgb(184, 191, 198);">*el</span>, <span style="color: rgb(28, 198, 133);">int</span> <span style="color: rgb(184, 191, 198);">fd</span>, <span style="color: rgb(28, 198, 133);">void</span> <span style="color: rgb(28, 198, 133);">*</span><span style="color: rgb(184, 191, 198);">privdata</span>, <span style="color: rgb(28, 198, 133);">int</span> <span style="color: rgb(184, 191, 198);">mask</span>) {</p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">redisClient</span> <span style="color: rgb(184, 191, 198);">*c</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">privdata</span>;</p>
<p>&nbsp;&nbsp;<span style="color: rgb(28, 198, 133);">int</span> <span style="color: rgb(184, 191, 198);">nwritten</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(100, 171, 143);">0</span>, <span style="color: rgb(184, 191, 198);">totwritten</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(100, 171, 143);">0</span>, <span style="color: rgb(184, 191, 198);">objlen</span>;</p>
<p>&nbsp;&nbsp;<span style="color: rgb(28, 198, 133);">size_t</span> <span style="color: rgb(184, 191, 198);">objmem</span>;</p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">robj</span> <span style="color: rgb(184, 191, 198);">*o</span>;</p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">REDIS_NOTUSED</span>(<span style="color: rgb(184, 191, 198);">el</span>);</p>
<p>&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">REDIS_NOTUSED</span>(<span style="color: rgb(184, 191, 198);">mask</span>);</p>
<p>&nbsp;&nbsp;<span style="color: rgb(218, 146, 74);">// 存在数据需要写出</span></p>
<p>&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">while</span>(<span style="color: rgb(184, 191, 198);">c-&gt;bufpos</span> <span style="color: rgb(184, 191, 198);">&gt;</span> <span style="color: rgb(100, 171, 143);">0</span> <span style="color: rgb(184, 191, 198);">||</span> <span style="color: rgb(184, 191, 198);">listLength</span>(<span style="color: rgb(184, 191, 198);">c-&gt;reply</span>)) {</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">if</span> (<span style="color: rgb(184, 191, 198);">c-&gt;bufpos</span> <span style="color: rgb(184, 191, 198);">&gt;</span> <span style="color: rgb(100, 171, 143);">0</span>) {</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">if</span> (<span style="color: rgb(184, 191, 198);">c-&gt;flags</span> <span style="color: rgb(184, 191, 198);">&amp;</span> <span style="color: rgb(184, 191, 198);">REDIS_MASTER</span>) { <span style="color: rgb(218, 146, 74);">// 若客户端时主库，那么不能写出，主库必须回应</span></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">nwritten</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">c-&gt;bufpos</span> <span style="color: rgb(184, 191, 198);">-</span> <span style="color: rgb(184, 191, 198);">c-&gt;sentlen</span>;</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} <span style="color: rgb(200, 143, 208);">else</span> {&nbsp;<span style="color: rgb(218, 146, 74);">// 开始写出客户都安</span></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">nwritten</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">write</span>(<span style="color: rgb(184, 191, 198);">fd</span>,<span style="color: rgb(184, 191, 198);">c-&gt;buf+c-&gt;sentlen</span>,<span style="color: rgb(184, 191, 198);">c-&gt;bufpos-c-&gt;sentlen</span>);</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">if</span> (<span style="color: rgb(184, 191, 198);">nwritten</span> <span style="color: rgb(184, 191, 198);">&lt;=</span> <span style="color: rgb(100, 171, 143);">0</span>) <span style="color: rgb(200, 143, 208);">break</span>; <span style="color: rgb(218, 146, 74);">// fd写缓冲区满，那么结束写入</span></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">c-&gt;sentlen</span> <span style="color: rgb(184, 191, 198);">+=</span> <span style="color: rgb(184, 191, 198);">nwritten</span>;</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">totwritten</span> <span style="color: rgb(184, 191, 198);">+=</span> <span style="color: rgb(184, 191, 198);">nwritten</span>;</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">if</span> (<span style="color: rgb(184, 191, 198);">c-&gt;sentlen</span> <span style="color: rgb(184, 191, 198);">==</span> <span style="color: rgb(184, 191, 198);">c-&gt;bufpos</span>) { <span style="color: rgb(218, 146, 74);">// 客户端redis写缓冲区中的数据已经完全写出</span></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">c-&gt;bufpos</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(100, 171, 143);">0</span>;</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">c-&gt;sentlen</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(100, 171, 143);">0</span>;</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</p>
<p>&nbsp;&nbsp;&nbsp;} <span style="color: rgb(200, 143, 208);">else</span> { <span style="color: rgb(218, 146, 74);">// 处理reply中的数据，将其尝试写出</span></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">o</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">listNodeValue</span>(<span style="color: rgb(184, 191, 198);">listFirst</span>(<span style="color: rgb(184, 191, 198);">c-&gt;reply</span>));</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">objlen</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">sdslen</span>(<span style="color: rgb(184, 191, 198);">o-&gt;ptr</span>);</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">objmem</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">zmalloc_size_sds</span>(<span style="color: rgb(184, 191, 198);">o-&gt;ptr</span>);</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">if</span> (<span style="color: rgb(184, 191, 198);">objlen</span> <span style="color: rgb(184, 191, 198);">==</span> <span style="color: rgb(100, 171, 143);">0</span>) { <span style="color: rgb(218, 146, 74);">// 当前robj不存在数据尝试链表中下一个</span></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">listDelNode</span>(<span style="color: rgb(184, 191, 198);">c-&gt;reply</span>,<span style="color: rgb(184, 191, 198);">listFirst</span>(<span style="color: rgb(184, 191, 198);">c-&gt;reply</span>));</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">continue</span>;</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">if</span> (<span style="color: rgb(184, 191, 198);">c-&gt;flags</span> <span style="color: rgb(184, 191, 198);">&amp;</span> <span style="color: rgb(184, 191, 198);">REDIS_MASTER</span>) {</p>
<p>&nbsp;</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">nwritten</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">objlen</span> <span style="color: rgb(184, 191, 198);">-</span> <span style="color: rgb(184, 191, 198);">c-&gt;sentlen</span>;</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} <span style="color: rgb(200, 143, 208);">else</span> { <span style="color: rgb(218, 146, 74);">// 开始写出</span></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">nwritten</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">write</span>(<span style="color: rgb(184, 191, 198);">fd</span>, ((<span style="color: rgb(28, 198, 133);">char*</span>)<span style="color: rgb(184, 191, 198);">o-&gt;ptr</span>)<span style="color: rgb(184, 191, 198);">+c-&gt;sentlen</span>,<span style="color: rgb(184, 191, 198);">objlen-c-&gt;sentlen</span>);</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">if</span> (<span style="color: rgb(184, 191, 198);">nwritten</span> <span style="color: rgb(184, 191, 198);">&lt;=</span> <span style="color: rgb(100, 171, 143);">0</span>) <span style="color: rgb(200, 143, 208);">break</span>;</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">c-&gt;sentlen</span> <span style="color: rgb(184, 191, 198);">+=</span> <span style="color: rgb(184, 191, 198);">nwritten</span>;</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">totwritten</span> <span style="color: rgb(184, 191, 198);">+=</span> <span style="color: rgb(184, 191, 198);">nwritten</span>;</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(218, 146, 74);">// 完全写出第一个robj，那么继续写出下一个</span></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">if</span> (<span style="color: rgb(184, 191, 198);">c-&gt;sentlen</span> <span style="color: rgb(184, 191, 198);">==</span> <span style="color: rgb(184, 191, 198);">objlen</span>) {</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">listDelNode</span>(<span style="color: rgb(184, 191, 198);">c-&gt;reply</span>,<span style="color: rgb(184, 191, 198);">listFirst</span>(<span style="color: rgb(184, 191, 198);">c-&gt;reply</span>));</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">c-&gt;sentlen</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(100, 171, 143);">0</span>;</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">c-&gt;reply_bytes</span> <span style="color: rgb(184, 191, 198);">-=</span> <span style="color: rgb(184, 191, 198);">objmem</span>;</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</p>
<p>&nbsp;&nbsp;&nbsp;}</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(218, 146, 74);">// 避免一次写入过多数据</span></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">if</span> (<span style="color: rgb(184, 191, 198);">totwritten</span> <span style="color: rgb(184, 191, 198);">&gt;</span> <span style="color: rgb(184, 191, 198);">REDIS_MAX_WRITE_PER_EVENT</span> <span style="color: rgb(184, 191, 198);">&amp;&amp;</span></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span style="color: rgb(184, 191, 198);">server</span>.<span style="color: rgb(184, 191, 198);">maxmemory</span> <span style="color: rgb(184, 191, 198);">==</span> <span style="color: rgb(100, 171, 143);">0</span> <span style="color: rgb(184, 191, 198);">||</span></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">zmalloc_used_memory</span>() <span style="color: rgb(184, 191, 198);">&lt;</span> <span style="color: rgb(184, 191, 198);">server</span>.<span style="color: rgb(184, 191, 198);">maxmemory</span>)) <span style="color: rgb(200, 143, 208);">break</span>;</p>
<p>&nbsp;}</p>
<p>&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">if</span> (<span style="color: rgb(184, 191, 198);">nwritten</span> <span style="color: rgb(184, 191, 198);">==</span> <span style="color: rgb(184, 191, 198);">-</span><span style="color: rgb(100, 171, 143);">1</span>) { <span style="color: rgb(218, 146, 74);">// 写入失败，那么打印日志</span></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">if</span> (<span style="color: rgb(184, 191, 198);">errno</span> <span style="color: rgb(184, 191, 198);">==</span> <span style="color: rgb(184, 191, 198);">EAGAIN</span>) { <span style="color: rgb(218, 146, 74);">// EAGAIN表示重试，那么不需要报警，下一次fd写缓冲区可用时再次写入即可</span></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">nwritten</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(100, 171, 143);">0</span>;</p>
<p>&nbsp;&nbsp;&nbsp;} <span style="color: rgb(200, 143, 208);">else</span> {</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">redisLog</span>(<span style="color: rgb(184, 191, 198);">REDIS_VERBOSE</span>,</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(210, 107, 107);">"Error writing to client: %s"</span>, <span style="color: rgb(184, 191, 198);">strerror</span>(<span style="color: rgb(184, 191, 198);">errno</span>));</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">freeClient</span>(<span style="color: rgb(184, 191, 198);">c</span>);</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">return</span>;</p>
<p>&nbsp;&nbsp;&nbsp;}</p>
<p>&nbsp;}</p>
<p>&nbsp;&nbsp;<span style="color: rgb(218, 146, 74);">// 成功写出数据，那么记录最后一次写出数据时间</span></p>
<p>&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">if</span> (<span style="color: rgb(184, 191, 198);">totwritten</span> <span style="color: rgb(184, 191, 198);">&gt;</span> <span style="color: rgb(100, 171, 143);">0</span>) <span style="color: rgb(184, 191, 198);">c-&gt;lastinteraction</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(184, 191, 198);">server</span>.<span style="color: rgb(184, 191, 198);">unixtime</span>;</p>
<p>&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">if</span> (<span style="color: rgb(184, 191, 198);">c-&gt;bufpos</span> <span style="color: rgb(184, 191, 198);">==</span> <span style="color: rgb(100, 171, 143);">0</span> <span style="color: rgb(184, 191, 198);">&amp;&amp;</span> <span style="color: rgb(184, 191, 198);">listLength</span>(<span style="color: rgb(184, 191, 198);">c-&gt;reply</span>) <span style="color: rgb(184, 191, 198);">==</span> <span style="color: rgb(100, 171, 143);">0</span>) { <span style="color: rgb(218, 146, 74);">// 全部数据写出完成（写缓冲区和reply链表），那么将器从多路复用器中解除写事件注册，因为不需要再写入其他事件</span></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">c-&gt;sentlen</span> <span style="color: rgb(184, 191, 198);">=</span> <span style="color: rgb(100, 171, 143);">0</span>;</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(184, 191, 198);">aeDeleteFileEvent</span>(<span style="color: rgb(184, 191, 198);">server</span>.<span style="color: rgb(184, 191, 198);">el</span>,<span style="color: rgb(184, 191, 198);">c-&gt;fd</span>,<span style="color: rgb(184, 191, 198);">AE_WRITABLE</span>);</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(200, 143, 208);">if</span> (<span style="color: rgb(184, 191, 198);">c-&gt;flags</span> <span style="color: rgb(184, 191, 198);">&amp;</span> <span style="color: rgb(184, 191, 198);">REDIS_CLOSE_AFTER_REPLY</span>) <span style="color: rgb(184, 191, 198);">freeClient</span>(<span style="color: rgb(184, 191, 198);">c</span>);</p>
<p>&nbsp;}</p>
<p>}</p>
<p><br></p></p>
</body>
</html>